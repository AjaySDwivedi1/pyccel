

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>pyccel.parser.semantic &mdash; pyccel * documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/fonts.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> pyccel
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">docBranck</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">pyccel</a>
        
      </nav>


      <div class="wy-nav-content">
<div class="git-ribbon">
  <a href="http://github.com/SwissDataScienceCenter" rel="me">Join us on GitHub</a>
</div>

        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>pyccel.parser.semantic</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pyccel.parser.semantic</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">#------------------------------------------------------------------------------------------#</span>
<span class="c1"># This file is part of Pyccel which is released under MIT License. See the LICENSE file or #</span>
<span class="c1"># go to https://github.com/pyccel/pyccel/blob/master/LICENSE for full license details.     #</span>
<span class="c1">#------------------------------------------------------------------------------------------#</span>
<span class="sd">&quot;&quot;&quot; File containing SemanticParser. This class handles the semantic stage of the translation.</span>
<span class="sd">See the developer docs for more details</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># pylint: disable=missing-function-docstring</span>

<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>

<span class="kn">from</span> <span class="nn">sympy.utilities.iterables</span> <span class="kn">import</span> <span class="n">iterable</span> <span class="k">as</span> <span class="n">sympy_iterable</span>

<span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="n">Sum</span> <span class="k">as</span> <span class="n">Summation</span>
<span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="n">Symbol</span> <span class="k">as</span> <span class="n">sp_Symbol</span>
<span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="n">Integer</span> <span class="k">as</span> <span class="n">sp_Integer</span>
<span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="n">ceiling</span>
<span class="kn">from</span> <span class="nn">sympy.core</span> <span class="kn">import</span> <span class="n">cache</span>

<span class="c1">#==============================================================================</span>

<span class="kn">from</span> <span class="nn">pyccel.ast.basic</span> <span class="kn">import</span> <span class="n">Basic</span><span class="p">,</span> <span class="n">PyccelAstNode</span><span class="p">,</span> <span class="n">ScopedNode</span>

<span class="kn">from</span> <span class="nn">pyccel.ast.builtins</span> <span class="kn">import</span> <span class="n">PythonPrint</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.builtins</span> <span class="kn">import</span> <span class="n">PythonInt</span><span class="p">,</span> <span class="n">PythonBool</span><span class="p">,</span> <span class="n">PythonFloat</span><span class="p">,</span> <span class="n">PythonComplex</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.builtins</span> <span class="kn">import</span> <span class="n">python_builtin_datatype</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.builtins</span> <span class="kn">import</span> <span class="n">PythonList</span><span class="p">,</span> <span class="n">PythonConjugate</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.builtins</span> <span class="kn">import</span> <span class="p">(</span><span class="n">PythonRange</span><span class="p">,</span> <span class="n">PythonZip</span><span class="p">,</span> <span class="n">PythonEnumerate</span><span class="p">,</span>
                                 <span class="n">PythonMap</span><span class="p">,</span> <span class="n">PythonTuple</span><span class="p">,</span> <span class="n">Lambda</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">pyccel.ast.core</span> <span class="kn">import</span> <span class="n">Comment</span><span class="p">,</span> <span class="n">CommentBlock</span><span class="p">,</span> <span class="n">Pass</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.core</span> <span class="kn">import</span> <span class="n">If</span><span class="p">,</span> <span class="n">IfSection</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.core</span> <span class="kn">import</span> <span class="n">Allocate</span><span class="p">,</span> <span class="n">Deallocate</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.core</span> <span class="kn">import</span> <span class="n">Assign</span><span class="p">,</span> <span class="n">AliasAssign</span><span class="p">,</span> <span class="n">SymbolicAssign</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.core</span> <span class="kn">import</span> <span class="n">AugAssign</span><span class="p">,</span> <span class="n">CodeBlock</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.core</span> <span class="kn">import</span> <span class="n">Return</span><span class="p">,</span> <span class="n">FunctionDefArgument</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.core</span> <span class="kn">import</span> <span class="n">ConstructorCall</span><span class="p">,</span> <span class="n">InlineFunctionDef</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.core</span> <span class="kn">import</span> <span class="n">FunctionDef</span><span class="p">,</span> <span class="n">Interface</span><span class="p">,</span> <span class="n">FunctionAddress</span><span class="p">,</span> <span class="n">FunctionCall</span><span class="p">,</span> <span class="n">FunctionCallArgument</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.core</span> <span class="kn">import</span> <span class="n">DottedFunctionCall</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.core</span> <span class="kn">import</span> <span class="n">ClassDef</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.core</span> <span class="kn">import</span> <span class="n">For</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.core</span> <span class="kn">import</span> <span class="n">Module</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.core</span> <span class="kn">import</span> <span class="n">While</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.core</span> <span class="kn">import</span> <span class="n">SymbolicPrint</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.core</span> <span class="kn">import</span> <span class="n">Del</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.core</span> <span class="kn">import</span> <span class="n">Program</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.core</span> <span class="kn">import</span> <span class="n">EmptyNode</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.core</span> <span class="kn">import</span> <span class="n">Concatenate</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.core</span> <span class="kn">import</span> <span class="n">Import</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.core</span> <span class="kn">import</span> <span class="n">AsName</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.core</span> <span class="kn">import</span> <span class="n">With</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.core</span> <span class="kn">import</span> <span class="n">Duplicate</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.core</span> <span class="kn">import</span> <span class="n">StarredArguments</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.core</span> <span class="kn">import</span> <span class="n">Iterable</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.core</span> <span class="kn">import</span> <span class="n">InProgram</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.core</span> <span class="kn">import</span> <span class="n">Decorator</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.core</span> <span class="kn">import</span> <span class="n">PyccelFunctionDef</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.core</span> <span class="kn">import</span> <span class="n">Assert</span>

<span class="kn">from</span> <span class="nn">pyccel.ast.class_defs</span> <span class="kn">import</span> <span class="n">NumpyArrayClass</span><span class="p">,</span> <span class="n">TupleClass</span><span class="p">,</span> <span class="n">get_cls_base</span>

<span class="kn">from</span> <span class="nn">pyccel.ast.datatypes</span> <span class="kn">import</span> <span class="n">NativeRange</span><span class="p">,</span> <span class="n">str_dtype</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.datatypes</span> <span class="kn">import</span> <span class="n">NativeSymbol</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.datatypes</span> <span class="kn">import</span> <span class="n">default_precision</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.datatypes</span> <span class="kn">import</span> <span class="p">(</span><span class="n">NativeInteger</span><span class="p">,</span> <span class="n">NativeBool</span><span class="p">,</span>
                                  <span class="n">NativeFloat</span><span class="p">,</span> <span class="n">NativeString</span><span class="p">,</span>
                                  <span class="n">NativeGeneric</span><span class="p">,</span> <span class="n">NativeComplex</span><span class="p">,</span>
                                  <span class="n">NativeVoid</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">pyccel.ast.functionalexpr</span> <span class="kn">import</span> <span class="n">FunctionalSum</span><span class="p">,</span> <span class="n">FunctionalMax</span><span class="p">,</span> <span class="n">FunctionalMin</span><span class="p">,</span> <span class="n">GeneratorComprehension</span><span class="p">,</span> <span class="n">FunctionalFor</span>

<span class="kn">from</span> <span class="nn">pyccel.ast.headers</span> <span class="kn">import</span> <span class="n">FunctionHeader</span><span class="p">,</span> <span class="n">MethodHeader</span><span class="p">,</span> <span class="n">Header</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.headers</span> <span class="kn">import</span> <span class="n">MacroFunction</span><span class="p">,</span> <span class="n">MacroVariable</span>

<span class="kn">from</span> <span class="nn">pyccel.ast.internals</span> <span class="kn">import</span> <span class="n">PyccelInternalFunction</span><span class="p">,</span> <span class="n">Slice</span><span class="p">,</span> <span class="n">PyccelSymbol</span><span class="p">,</span> <span class="n">get_final_precision</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.itertoolsext</span> <span class="kn">import</span> <span class="n">Product</span>

<span class="kn">from</span> <span class="nn">pyccel.ast.literals</span> <span class="kn">import</span> <span class="n">LiteralTrue</span><span class="p">,</span> <span class="n">LiteralFalse</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.literals</span> <span class="kn">import</span> <span class="n">LiteralInteger</span><span class="p">,</span> <span class="n">LiteralFloat</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.literals</span> <span class="kn">import</span> <span class="n">Nil</span><span class="p">,</span> <span class="n">LiteralString</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.literals</span> <span class="kn">import</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">convert_to_literal</span>

<span class="kn">from</span> <span class="nn">pyccel.ast.mathext</span>  <span class="kn">import</span> <span class="n">math_constants</span>

<span class="kn">from</span> <span class="nn">pyccel.ast.numpyext</span> <span class="kn">import</span> <span class="n">NumpyZeros</span><span class="p">,</span> <span class="n">NumpyMatmul</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.numpyext</span> <span class="kn">import</span> <span class="n">NumpyBool</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.numpyext</span> <span class="kn">import</span> <span class="n">NumpyWhere</span><span class="p">,</span> <span class="n">NumpyArray</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.numpyext</span> <span class="kn">import</span> <span class="n">NumpyInt</span><span class="p">,</span> <span class="n">NumpyInt8</span><span class="p">,</span> <span class="n">NumpyInt16</span><span class="p">,</span> <span class="n">NumpyInt32</span><span class="p">,</span> <span class="n">NumpyInt64</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.numpyext</span> <span class="kn">import</span> <span class="n">NumpyFloat</span><span class="p">,</span> <span class="n">NumpyFloat32</span><span class="p">,</span> <span class="n">NumpyFloat64</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.numpyext</span> <span class="kn">import</span> <span class="n">NumpyComplex</span><span class="p">,</span> <span class="n">NumpyComplex64</span><span class="p">,</span> <span class="n">NumpyComplex128</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.numpyext</span> <span class="kn">import</span> <span class="n">NumpyTranspose</span><span class="p">,</span> <span class="n">NumpyConjugate</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.numpyext</span> <span class="kn">import</span> <span class="n">NumpyNewArray</span><span class="p">,</span> <span class="n">NumpyNonZero</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.numpyext</span> <span class="kn">import</span> <span class="n">DtypePrecisionToCastFunction</span>

<span class="kn">from</span> <span class="nn">pyccel.ast.omp</span> <span class="kn">import</span> <span class="p">(</span><span class="n">OMP_For_Loop</span><span class="p">,</span> <span class="n">OMP_Simd_Construct</span><span class="p">,</span> <span class="n">OMP_Distribute_Construct</span><span class="p">,</span>
                            <span class="n">OMP_TaskLoop_Construct</span><span class="p">,</span> <span class="n">OMP_Sections_Construct</span><span class="p">,</span> <span class="n">Omp_End_Clause</span><span class="p">,</span>
                            <span class="n">OMP_Single_Construct</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">pyccel.ast.operators</span> <span class="kn">import</span> <span class="n">PyccelArithmeticOperator</span><span class="p">,</span> <span class="n">PyccelIs</span><span class="p">,</span> <span class="n">PyccelIsNot</span><span class="p">,</span> <span class="n">IfTernaryOperator</span><span class="p">,</span> <span class="n">PyccelUnarySub</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.operators</span> <span class="kn">import</span> <span class="n">PyccelNot</span><span class="p">,</span> <span class="n">PyccelEq</span><span class="p">,</span> <span class="n">PyccelAdd</span><span class="p">,</span> <span class="n">PyccelMul</span><span class="p">,</span> <span class="n">PyccelPow</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.operators</span> <span class="kn">import</span> <span class="n">PyccelAssociativeParenthesis</span><span class="p">,</span> <span class="n">PyccelDiv</span>

<span class="kn">from</span> <span class="nn">pyccel.ast.sympy_helper</span> <span class="kn">import</span> <span class="n">sympy_to_pyccel</span><span class="p">,</span> <span class="n">pyccel_to_sympy</span>

<span class="kn">from</span> <span class="nn">pyccel.ast.utilities</span> <span class="kn">import</span> <span class="n">builtin_function</span> <span class="k">as</span> <span class="n">pyccel_builtin_function</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.utilities</span> <span class="kn">import</span> <span class="n">builtin_import</span> <span class="k">as</span> <span class="n">pyccel_builtin_import</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.utilities</span> <span class="kn">import</span> <span class="n">builtin_import_registery</span> <span class="k">as</span> <span class="n">pyccel_builtin_import_registery</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.utilities</span> <span class="kn">import</span> <span class="n">split_positional_keyword_arguments</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.utilities</span> <span class="kn">import</span> <span class="n">recognised_source</span>

<span class="kn">from</span> <span class="nn">pyccel.ast.variable</span> <span class="kn">import</span> <span class="n">Constant</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.variable</span> <span class="kn">import</span> <span class="n">Variable</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.variable</span> <span class="kn">import</span> <span class="n">TupleVariable</span><span class="p">,</span> <span class="n">HomogeneousTupleVariable</span><span class="p">,</span> <span class="n">InhomogeneousTupleVariable</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.variable</span> <span class="kn">import</span> <span class="n">IndexedElement</span>
<span class="kn">from</span> <span class="nn">pyccel.ast.variable</span> <span class="kn">import</span> <span class="n">DottedName</span><span class="p">,</span> <span class="n">DottedVariable</span>

<span class="kn">from</span> <span class="nn">pyccel.errors.errors</span> <span class="kn">import</span> <span class="n">Errors</span>
<span class="kn">from</span> <span class="nn">pyccel.errors.errors</span> <span class="kn">import</span> <span class="n">PyccelSemanticError</span>

<span class="kn">from</span> <span class="nn">pyccel.errors.messages</span> <span class="kn">import</span> <span class="p">(</span><span class="n">PYCCEL_RESTRICTION_TODO</span><span class="p">,</span> <span class="n">UNDERSCORE_NOT_A_THROWAWAY</span><span class="p">,</span>
        <span class="n">UNDEFINED_VARIABLE</span><span class="p">,</span> <span class="n">IMPORTING_EXISTING_IDENTIFIED</span><span class="p">,</span> <span class="n">INDEXED_TUPLE</span><span class="p">,</span> <span class="n">LIST_OF_TUPLES</span><span class="p">,</span>
        <span class="n">INVALID_INDICES</span><span class="p">,</span> <span class="n">INCOMPATIBLE_ARGUMENT</span><span class="p">,</span> <span class="n">INCOMPATIBLE_ORDERING</span><span class="p">,</span>
        <span class="n">UNRECOGNISED_FUNCTION_CALL</span><span class="p">,</span> <span class="n">STACK_ARRAY_SHAPE_UNPURE_FUNC</span><span class="p">,</span> <span class="n">STACK_ARRAY_UNKNOWN_SHAPE</span><span class="p">,</span>
        <span class="n">ARRAY_DEFINITION_IN_LOOP</span><span class="p">,</span> <span class="n">STACK_ARRAY_DEFINITION_IN_LOOP</span><span class="p">,</span>
        <span class="n">INCOMPATIBLE_TYPES_IN_ASSIGNMENT</span><span class="p">,</span> <span class="n">ARRAY_ALREADY_IN_USE</span><span class="p">,</span> <span class="n">ASSIGN_ARRAYS_ONE_ANOTHER</span><span class="p">,</span>
        <span class="n">INVALID_POINTER_REASSIGN</span><span class="p">,</span> <span class="n">INCOMPATIBLE_REDEFINITION</span><span class="p">,</span> <span class="n">ARRAY_IS_ARG</span><span class="p">,</span>
        <span class="n">INCOMPATIBLE_REDEFINITION_STACK_ARRAY</span><span class="p">,</span> <span class="n">ARRAY_REALLOCATION</span><span class="p">,</span> <span class="n">RECURSIVE_RESULTS_REQUIRED</span><span class="p">,</span>
        <span class="n">PYCCEL_RESTRICTION_INHOMOG_LIST</span><span class="p">,</span> <span class="n">UNDEFINED_IMPORT_OBJECT</span><span class="p">,</span> <span class="n">UNDEFINED_LAMBDA_VARIABLE</span><span class="p">,</span>
        <span class="n">UNDEFINED_LAMBDA_FUNCTION</span><span class="p">,</span> <span class="n">UNDEFINED_INIT_METHOD</span><span class="p">,</span> <span class="n">UNDEFINED_FUNCTION</span><span class="p">,</span>
        <span class="n">INVALID_MACRO_COMPOSITION</span><span class="p">,</span> <span class="n">WRONG_NUMBER_OUTPUT_ARGS</span><span class="p">,</span> <span class="n">INVALID_FOR_ITERABLE</span><span class="p">,</span>
        <span class="n">PYCCEL_RESTRICTION_LIST_COMPREHENSION_LIMITS</span><span class="p">,</span> <span class="n">PYCCEL_RESTRICTION_LIST_COMPREHENSION_SIZE</span><span class="p">,</span>
        <span class="n">UNUSED_DECORATORS</span><span class="p">,</span> <span class="n">DUPLICATED_SIGNATURE</span><span class="p">,</span> <span class="n">FUNCTION_TYPE_EXPECTED</span><span class="p">,</span>
        <span class="n">UNSUPPORTED_POINTER_RETURN_VALUE</span><span class="p">,</span> <span class="n">PYCCEL_MISSING_HEADER</span><span class="p">,</span> <span class="n">PYCCEL_RESTRICTION_OPTIONAL_NONE</span><span class="p">,</span>
        <span class="n">PYCCEL_RESTRICTION_PRIMITIVE_IMMUTABLE</span><span class="p">,</span> <span class="n">PYCCEL_RESTRICTION_IS_ISNOT</span><span class="p">,</span>
        <span class="n">FOUND_DUPLICATED_IMPORT</span><span class="p">,</span> <span class="n">UNDEFINED_WITH_ACCESS</span><span class="p">,</span> <span class="n">MACRO_MISSING_HEADER_OR_FUNC</span><span class="p">,)</span>

<span class="kn">from</span> <span class="nn">pyccel.parser.base</span>      <span class="kn">import</span> <span class="n">BasicParser</span>
<span class="kn">from</span> <span class="nn">pyccel.parser.syntactic</span> <span class="kn">import</span> <span class="n">SyntaxParser</span>

<span class="kn">from</span> <span class="nn">pyccel.utilities.stage</span> <span class="kn">import</span> <span class="n">PyccelStage</span>

<span class="kn">import</span> <span class="nn">pyccel.decorators</span> <span class="k">as</span> <span class="nn">def_decorators</span>
<span class="c1">#==============================================================================</span>

<span class="n">errors</span> <span class="o">=</span> <span class="n">Errors</span><span class="p">()</span>
<span class="n">pyccel_stage</span> <span class="o">=</span> <span class="n">PyccelStage</span><span class="p">()</span>

<span class="c1">#==============================================================================</span>

<div class="viewcode-block" id="_get_name"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic._get_name">[docs]</a><span class="k">def</span> <span class="nf">_get_name</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">var</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="p">(</span><span class="n">PyccelSymbol</span><span class="p">,</span> <span class="n">DottedName</span><span class="p">)):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="p">(</span><span class="n">IndexedElement</span><span class="p">)):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">base</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">FunctionCall</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">var</span><span class="o">.</span><span class="n">funcdef</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">AsName</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">var</span><span class="o">.</span><span class="n">target</span>
    <span class="n">name</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">var</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Name of Object : </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> cannot be determined&#39;</span>
    <span class="k">return</span> <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">PYCCEL_RESTRICTION_TODO</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">msg</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">var</span><span class="p">,</span>
                <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span></div>

<span class="c1">#==============================================================================</span>

<div class="viewcode-block" id="SemanticParser"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser">[docs]</a><span class="k">class</span> <span class="nc">SemanticParser</span><span class="p">(</span><span class="n">BasicParser</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot; Class for a Semantic Parser.</span>
<span class="sd">    It takes a syntactic parser as input for the moment&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># a Parser can have parents, who are importing it.</span>
        <span class="c1"># imports are then its sons.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parents</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;parents&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_d_parsers</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;d_parsers&#39;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="c1"># ...</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">SyntaxParser</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;&gt; Expecting a syntactic parser as input&#39;</span><span class="p">)</span>

        <span class="n">parser</span> <span class="o">=</span> <span class="n">inputs</span>
        <span class="c1"># ...</span>

        <span class="c1"># ...</span>
        <span class="n">BasicParser</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># ...</span>

        <span class="c1"># ...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fst</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">_fst</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ast</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">_ast</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span>  <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">_filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mod_name</span>  <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metavars</span>  <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">_metavars</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">scope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">imports</span><span class="p">[</span><span class="s1">&#39;imports&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_module_namespace</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_program_namespace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">new_child_scope</span><span class="p">(</span><span class="s1">&#39;__main__&#39;</span><span class="p">)</span>

        <span class="c1"># used to store the local variables of a code block needed for garbage collecting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_allocs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># used to store code split into multiple lines to be reinserted in the CodeBlock</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_additional_exprs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_code</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">_code</span>
        <span class="c1"># ...</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">annotate</span><span class="p">()</span>
        <span class="c1"># ...</span>

    <span class="c1">#================================================================</span>
    <span class="c1">#                  Property accessors</span>
    <span class="c1">#================================================================</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the parents parser.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parents</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">d_parsers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the d_parsers parser.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d_parsers</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">program_namespace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_program_namespace</span>

    <span class="c1">#================================================================</span>
    <span class="c1">#                     Public functions</span>
    <span class="c1">#================================================================</span>

<div class="viewcode-block" id="SemanticParser.annotate"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser.annotate">[docs]</a>    <span class="k">def</span> <span class="nf">annotate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">semantic_done</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;&gt; semantic analysis already done&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ast</span>

        <span class="c1"># TODO - add settings to Errors</span>
        <span class="c1">#      - filename</span>

        <span class="n">errors</span> <span class="o">=</span> <span class="n">Errors</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">set_target</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;file&#39;</span><span class="p">)</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">set_parser_stage</span><span class="p">(</span><span class="s1">&#39;semantic&#39;</span><span class="p">)</span>

        <span class="c1"># then we treat the current file</span>

        <span class="n">ast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ast</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_allocs</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="c1"># we add the try/except to allow the parser to find all possible errors</span>
        <span class="n">pyccel_stage</span><span class="o">.</span><span class="n">set_stage</span><span class="p">(</span><span class="s1">&#39;semantic&#39;</span><span class="p">)</span>
        <span class="n">ast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ast</span> <span class="o">=</span> <span class="n">ast</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_semantic_done</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">ast</span></div>

    <span class="c1">#================================================================</span>
    <span class="c1">#              Utility functions for scope handling</span>
    <span class="c1">#================================================================</span>

<div class="viewcode-block" id="SemanticParser.change_to_program_scope"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser.change_to_program_scope">[docs]</a>    <span class="k">def</span> <span class="nf">change_to_program_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_allocs</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_module_namespace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_program_namespace</span></div>

<div class="viewcode-block" id="SemanticParser.change_to_module_scope"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser.change_to_module_scope">[docs]</a>    <span class="k">def</span> <span class="nf">change_to_module_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_program_namespace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module_namespace</span></div>

<div class="viewcode-block" id="SemanticParser.check_for_variable"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser.check_for_variable">[docs]</a>    <span class="k">def</span> <span class="nf">check_for_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Search for a Variable object with the given name in the current scope,</span>
<span class="sd">        defined by the local and global Python scopes. Return None if not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_class</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_class</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                    <span class="n">var</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="k">return</span> <span class="n">var</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;variables&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SemanticParser.get_variable"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser.get_variable">[docs]</a>    <span class="k">def</span> <span class="nf">get_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Like &#39;check_for_variable&#39;, but raise Pyccel error if Variable is not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_for_variable</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">UNDERSCORE_NOT_A_THROWAWAY</span><span class="p">,</span>
                    <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                    <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">UNDEFINED_VARIABLE</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                    <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">var</span></div>

<div class="viewcode-block" id="SemanticParser.get_variables"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser.get_variables">[docs]</a>    <span class="k">def</span> <span class="nf">get_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">container</span><span class="p">):</span>
        <span class="c1"># this only works if called on a function scope</span>
        <span class="c1"># TODO needs more tests when we have nested functions</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">variables</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">sub_container</span> <span class="ow">in</span> <span class="n">container</span><span class="o">.</span><span class="n">loops</span><span class="p">:</span>
            <span class="n">variables</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_variables</span><span class="p">(</span><span class="n">sub_container</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">variables</span></div>

<div class="viewcode-block" id="SemanticParser.get_class_construct"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser.get_class_construct">[docs]</a>    <span class="k">def</span> <span class="nf">get_class_construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the class datatype for name if it exists.</span>
<span class="sd">        Raises an error otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;cls_constructs&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;class construct </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> not found&#39;</span>
            <span class="k">return</span> <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span>
                <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="SemanticParser.insert_import"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser.insert_import">[docs]</a>    <span class="k">def</span> <span class="nf">insert_import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">storage_name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create and insert a new import in scope if it&#39;s not defined</span>
<span class="sd">        otherwise append target to existing import.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str-like</span>
<span class="sd">               The source from which the object is imported</span>
<span class="sd">        target : AsName</span>
<span class="sd">               The imported object</span>
<span class="sd">        storage_name : str-like</span>
<span class="sd">                The name which will be used to identify the Import in the</span>
<span class="sd">                container</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">_get_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">storage_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">storage_name</span> <span class="o">=</span> <span class="n">source</span>
        <span class="n">imp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s1">&#39;imports&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">imp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">imp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">storage_name</span><span class="p">,</span> <span class="s1">&#39;imports&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">imp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">imp_source</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">source</span>
            <span class="k">if</span> <span class="n">imp_source</span> <span class="o">==</span> <span class="n">source</span><span class="p">:</span>
                <span class="n">imp</span><span class="o">.</span><span class="n">define_target</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">IMPORTING_EXISTING_IDENTIFIED</span><span class="p">,</span>
                              <span class="n">symbol</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                              <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                              <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">container</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">imports</span>
            <span class="n">container</span><span class="p">[</span><span class="s1">&#39;imports&#39;</span><span class="p">][</span><span class="n">storage_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Import</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="SemanticParser.get_headers"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser.get_headers">[docs]</a>    <span class="k">def</span> <span class="nf">get_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get all headers in the scope which reference the</span>
<span class="sd">        requested name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">container</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">container</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">container</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">headers</span> <span class="o">+=</span> <span class="n">container</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="n">container</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="n">parent_scope</span>
        <span class="k">return</span> <span class="n">headers</span></div>


    <span class="c1">#=======================================================</span>
    <span class="c1">#              Utility functions</span>
    <span class="c1">#=======================================================</span>

<div class="viewcode-block" id="SemanticParser._garbage_collector"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._garbage_collector">[docs]</a>    <span class="k">def</span> <span class="nf">_garbage_collector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Search in a CodeBlock if no trailing Return Node is present add the needed frees.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">body</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">Return</span><span class="p">):</span>
            <span class="n">deallocs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Deallocate</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allocs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">deallocs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_allocs</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">deallocs</span></div>

<div class="viewcode-block" id="SemanticParser._infere_type"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._infere_type">[docs]</a>    <span class="k">def</span> <span class="nf">_infere_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        type inference for expressions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO - add settings to Errors</span>
        <span class="c1">#      - line and column</span>
        <span class="c1">#      - blocking errors</span>

        <span class="n">errors</span> <span class="o">=</span> <span class="n">Errors</span><span class="p">()</span>

        <span class="n">verbose</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;*** type inference for : &#39;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>

        <span class="n">d_var</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># TODO improve =&gt; put settings as attribut of Parser</span>

        <span class="k">if</span> <span class="n">expr</span> <span class="ow">in</span> <span class="p">(</span><span class="n">PythonInt</span><span class="p">,</span> <span class="n">PythonFloat</span><span class="p">,</span> <span class="n">PythonComplex</span><span class="p">,</span> <span class="n">PythonBool</span><span class="p">,</span> <span class="n">NumpyBool</span><span class="p">,</span> <span class="n">NumpyInt</span><span class="p">,</span> <span class="n">NumpyInt8</span><span class="p">,</span> <span class="n">NumpyInt16</span><span class="p">,</span>
                      <span class="n">NumpyInt32</span><span class="p">,</span> <span class="n">NumpyInt64</span><span class="p">,</span> <span class="n">NumpyComplex</span><span class="p">,</span> <span class="n">NumpyComplex64</span><span class="p">,</span>
					  <span class="n">NumpyComplex128</span><span class="p">,</span> <span class="n">NumpyFloat</span><span class="p">,</span> <span class="n">NumpyFloat64</span><span class="p">,</span> <span class="n">NumpyFloat32</span><span class="p">):</span>

            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span>   <span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span>       <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span>  <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="n">d_var</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Variable</span><span class="p">):</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span>       <span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">dtype</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;memory_handling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">memory_handling</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span>          <span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span>           <span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">rank</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;cls_base&#39;</span>       <span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">cls_base</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;is_target&#39;</span>      <span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">is_target</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;order&#39;</span>          <span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">order</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span>      <span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">precision</span>
            <span class="k">return</span> <span class="n">d_var</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">PythonTuple</span><span class="p">):</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span>       <span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">dtype</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span>      <span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">precision</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;memory_handling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;heap&#39;</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span>          <span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span>           <span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">rank</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;order&#39;</span>          <span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">order</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;cls_base&#39;</span>       <span class="p">]</span> <span class="o">=</span> <span class="n">TupleClass</span>
            <span class="k">return</span> <span class="n">d_var</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Concatenate</span><span class="p">):</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span>      <span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">dtype</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span>     <span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">precision</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span>         <span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span>          <span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">rank</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;order&#39;</span>         <span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">order</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;cls_base&#39;</span>      <span class="p">]</span> <span class="o">=</span> <span class="n">TupleClass</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;on_heap&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">):</span>
                <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;memory_handling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;heap&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;memory_handling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;stack&#39;</span>
            <span class="k">return</span> <span class="n">d_var</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Duplicate</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infere_type</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>

            <span class="c1"># TODO must check that it is consistent with pyccel&#39;s rules</span>
            <span class="c1"># TODO improve</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span>      <span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span>          <span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">rank</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span>         <span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;order&#39;</span>         <span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">order</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;cls_base&#39;</span>      <span class="p">]</span> <span class="o">=</span> <span class="n">TupleClass</span>
            <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;on_stack&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">length</span><span class="p">,</span> <span class="n">LiteralInteger</span><span class="p">):</span>
                <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;memory_handling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;stack&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;memory_handling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;heap&#39;</span>
            <span class="k">return</span> <span class="n">d_var</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">NumpyNewArray</span><span class="p">):</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">dtype</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;memory_handling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;heap&#39;</span> <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">rank</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;stack&#39;</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span>      <span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span>       <span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">rank</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;order&#39;</span>      <span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">order</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span>  <span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">precision</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;cls_base&#39;</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">NumpyArrayClass</span>
            <span class="k">return</span> <span class="n">d_var</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">NumpyTranspose</span><span class="p">):</span>

            <span class="n">var</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">internal_var</span>

            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;memory_handling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;alias&#39;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;heap&#39;</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span>      <span class="p">]</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">dtype</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span>         <span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span>          <span class="p">]</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">rank</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;cls_base&#39;</span>      <span class="p">]</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">cls_base</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;is_target&#39;</span>     <span class="p">]</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">is_target</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;order&#39;</span>         <span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;C&#39;</span> <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">order</span><span class="o">==</span><span class="s1">&#39;F&#39;</span> <span class="k">else</span> <span class="s1">&#39;F&#39;</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span>     <span class="p">]</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">precision</span>
            <span class="k">return</span> <span class="n">d_var</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">PyccelAstNode</span><span class="p">):</span>

            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">dtype</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;memory_handling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;heap&#39;</span> <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">rank</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;stack&#39;</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span>      <span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span>       <span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">rank</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;order&#39;</span>      <span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">order</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span>  <span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">precision</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;cls_base&#39;</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">get_cls_base</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">expr</span><span class="o">.</span><span class="n">precision</span><span class="p">,</span> <span class="n">expr</span><span class="o">.</span><span class="n">rank</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">d_var</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">IfTernaryOperator</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infere_type</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">PythonRange</span><span class="p">):</span>

            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">NativeRange</span><span class="p">()</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;memory_handling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;stack&#39;</span> <span class="c1"># because rank is 0 and no shape defined</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span>      <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span>       <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;cls_base&#39;</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">expr</span>  <span class="c1"># TODO: shall we keep it?</span>
            <span class="k">return</span> <span class="n">d_var</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Lambda</span><span class="p">):</span>

            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">NativeSymbol</span><span class="p">()</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;memory_handling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;stack&#39;</span> <span class="c1"># because rank is 0 and no shape defined</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span>       <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="n">d_var</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ConstructorCall</span><span class="p">):</span>
            <span class="n">cls_name</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">cls_name</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">cls_name</span><span class="p">,</span> <span class="s1">&#39;classes&#39;</span><span class="p">)</span>

            <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_class_construct</span><span class="p">(</span><span class="n">cls_name</span><span class="p">)()</span>

            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">dtype</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;memory_handling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;stack&#39;</span> <span class="c1"># because rank is 0 and no shape defined</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span>      <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span>       <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;is_target&#39;</span>  <span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># set target  to True if we want the class objects to be pointers</span>

            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;cls_base&#39;</span>      <span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span>
            <span class="k">return</span> <span class="n">d_var</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">GeneratorComprehension</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infere_type</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">lhs</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">type_name</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Type of Object : </span><span class="si">{</span><span class="n">type_name</span><span class="si">}</span><span class="s1"> cannot be infered&#39;</span>
            <span class="k">return</span> <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">PYCCEL_RESTRICTION_TODO</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">msg</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">expr</span><span class="p">,</span>
                <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SemanticParser._extract_indexed_from_var"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._extract_indexed_from_var">[docs]</a>    <span class="k">def</span> <span class="nf">_extract_indexed_from_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">expr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Use indices to extract appropriate element from</span>
<span class="sd">        object &#39;var&#39;</span>
<span class="sd">        This contains most of the contents of _visit_IndexedElement</span>
<span class="sd">        but is a separate function in order to be recursive</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># case of Pyccel ast Variable</span>
        <span class="c1"># if not possible we use symbolic objects</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">PythonTuple</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">is_literal_index</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
                <span class="k">def</span> <span class="nf">is_int</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
                    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">LiteralInteger</span><span class="p">))</span> <span class="ow">or</span> \
                        <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">PyccelUnarySub</span><span class="p">)</span> <span class="ow">and</span> \
                         <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">LiteralInteger</span><span class="p">)))</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">Slice</span><span class="p">):</span>
                    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">is_int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">or</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">stop</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">is_int</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">is_literal_index</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">var</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">:]])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tmp_var</span> <span class="o">=</span> <span class="n">PyccelSymbol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_new_name</span><span class="p">())</span>
                <span class="n">assign</span> <span class="o">=</span> <span class="n">Assign</span><span class="p">(</span><span class="n">tmp_var</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
                <span class="n">assign</span><span class="o">.</span><span class="n">set_fst</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">fst</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_additional_exprs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">assign</span><span class="p">))</span>
                <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">tmp_var</span><span class="p">)</span>


        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">Variable</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="s1">&#39;__getitem__&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">var</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">:]])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">var_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can&#39;t index </span><span class="si">{</span><span class="n">var_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">expr</span><span class="p">,</span>
                    <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                    <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>

        <span class="n">indices</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">InhomogeneousTupleVariable</span><span class="p">):</span>

            <span class="n">arg</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Slice</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">arg</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">LiteralInteger</span><span class="p">))</span> <span class="ow">or</span>
                        <span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="n">LiteralInteger</span><span class="p">))):</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">INDEXED_TUPLE</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">var</span><span class="p">,</span>
                        <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                        <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>

                <span class="n">idx</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">arg</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
                <span class="n">selected_vars</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">get_var</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_vars</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">selected_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">var</span> <span class="o">=</span> <span class="n">selected_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_indexed_from_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">expr</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_vars</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">PythonTuple</span><span class="p">(</span><span class="o">*</span><span class="n">selected_vars</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">PythonTuple</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_extract_indexed_from_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">expr</span><span class="p">)</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">selected_vars</span><span class="p">])</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">LiteralInteger</span><span class="p">):</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">var</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span>

                <span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_indexed_from_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">expr</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">INDEXED_TUPLE</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">var</span><span class="p">,</span>
                    <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                    <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">PythonTuple</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">var</span><span class="o">.</span><span class="n">is_homogeneous</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">LIST_OF_TUPLES</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">var</span><span class="p">,</span>
                <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">var</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span><span class="o">.</span><span class="n">indices</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Slice</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> \
                <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s1">&#39;dtype&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">NativeInteger</span><span class="p">)):</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">INVALID_INDICES</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">var</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span>
                <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">var</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span></div>

<div class="viewcode-block" id="SemanticParser._create_PyccelOperator"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._create_PyccelOperator">[docs]</a>    <span class="k">def</span> <span class="nf">_create_PyccelOperator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">visited_args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Called by _visit_PyccelOperator and other classes</span>
<span class="sd">        inheriting from PyccelOperator</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">expr_new</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">expr</span><span class="p">)(</span><span class="o">*</span><span class="n">visited_args</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">PyccelSemanticError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">expr</span><span class="p">,</span>
                <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">expr_new</span></div>

<div class="viewcode-block" id="SemanticParser._create_Duplicate"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._create_Duplicate">[docs]</a>    <span class="k">def</span> <span class="nf">_create_Duplicate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Called by _visit_PyccelMul when a Duplicate is</span>
<span class="sd">        identified</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Arguments have been visited in PyccelMul</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">TupleVariable</span><span class="p">,</span> <span class="n">PythonTuple</span><span class="p">)):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;Unexpected Duplicate&quot;</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">Duplicate</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">length</span><span class="p">),</span>
                <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">is_homogeneous</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Duplicate</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">LiteralInteger</span><span class="p">):</span>
                <span class="n">length</span> <span class="o">=</span> <span class="n">length</span><span class="o">.</span><span class="n">python_value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;Cannot create inhomogeneous tuple of unknown size&quot;</span><span class="p">,</span>
                    <span class="n">symbol</span><span class="o">=</span><span class="n">Duplicate</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">length</span><span class="p">),</span>
                    <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                    <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">TupleVariable</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">PythonTuple</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">get_vars</span><span class="p">()</span><span class="o">*</span><span class="n">length</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">PythonTuple</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">args</span><span class="o">*</span><span class="n">length</span><span class="p">))</span></div>

<div class="viewcode-block" id="SemanticParser._handle_function_args"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._handle_function_args">[docs]</a>    <span class="k">def</span> <span class="nf">_handle_function_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">args</span>  <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">arguments</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">StarredArguments</span><span class="p">):</span>
                <span class="n">args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">FunctionCallArgument</span><span class="p">(</span><span class="n">av</span><span class="p">)</span> <span class="k">for</span> <span class="n">av</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">args_var</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">PyccelArithmeticOperator</span><span class="p">)</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">rank</span><span class="p">:</span>
                    <span class="n">tmp_var</span> <span class="o">=</span> <span class="n">PyccelSymbol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_new_name</span><span class="p">(),</span> <span class="n">is_temp</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">assign</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">Assign</span><span class="p">(</span><span class="n">tmp_var</span><span class="p">,</span> <span class="n">arg</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">fst</span><span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">fst</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_additional_exprs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">assign</span><span class="p">)</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">FunctionCallArgument</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">tmp_var</span><span class="p">))</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">args</span></div>

<div class="viewcode-block" id="SemanticParser.get_type_description"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser.get_type_description">[docs]</a>    <span class="k">def</span> <span class="nf">get_type_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">include_rank</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Provides a text description of the type of a variable</span>
<span class="sd">        (useful for error messages)</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        var          : Variable</span>
<span class="sd">                       The variable to describe</span>
<span class="sd">        include_rank : bool</span>
<span class="sd">                       Indicates whether rank information should be included</span>
<span class="sd">                       Default : True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">dtype</span>
        <span class="n">prec</span>  <span class="o">=</span> <span class="n">get_final_precision</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="n">descr</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dtype</span><span class="si">}{</span><span class="p">(</span><span class="n">prec</span> <span class="o">*</span> <span class="mi">2</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">NativeComplex</span><span class="p">)</span> <span class="k">else</span> <span class="n">prec</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span> <span class="k">if</span> <span class="n">prec</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">include_rank</span> <span class="ow">and</span> <span class="n">var</span><span class="o">.</span><span class="n">rank</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="o">*</span><span class="n">var</span><span class="o">.</span><span class="n">rank</span><span class="p">)</span>
            <span class="n">descr</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;[</span><span class="si">{</span><span class="n">dims</span><span class="si">}</span><span class="s1">]&#39;</span>
        <span class="k">return</span> <span class="n">descr</span></div>

<div class="viewcode-block" id="SemanticParser._check_argument_compatibility"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._check_argument_compatibility">[docs]</a>    <span class="k">def</span> <span class="nf">_check_argument_compatibility</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_args</span><span class="p">,</span> <span class="n">func_args</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">elemental</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that the provided arguments match the expected types</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        input_args : list</span>
<span class="sd">                     The arguments provided to the function</span>
<span class="sd">        func_args  : list</span>
<span class="sd">                     The arguments expected by the function</span>
<span class="sd">        expr       : PyccelAstNode</span>
<span class="sd">                     The expression where this call is found (used for error output)</span>
<span class="sd">        elemental  : bool</span>
<span class="sd">                     Indicates if the function is elemental</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">elemental</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">incompatible</span><span class="p">(</span><span class="n">i_arg</span><span class="p">,</span> <span class="n">f_arg</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">i_arg</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">f_arg</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">or</span> \
                        <span class="n">get_final_precision</span><span class="p">(</span><span class="n">i_arg</span><span class="p">)</span> <span class="o">!=</span> <span class="n">get_final_precision</span><span class="p">(</span><span class="n">f_arg</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">incompatible</span><span class="p">(</span><span class="n">i_arg</span><span class="p">,</span> <span class="n">f_arg</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">i_arg</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">f_arg</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">or</span> \
                        <span class="n">get_final_precision</span><span class="p">(</span><span class="n">i_arg</span><span class="p">)</span> <span class="o">!=</span> <span class="n">get_final_precision</span><span class="p">(</span><span class="n">f_arg</span><span class="p">)</span> <span class="ow">or</span>
                        <span class="n">i_arg</span><span class="o">.</span><span class="n">rank</span> <span class="o">!=</span> <span class="n">f_arg</span><span class="o">.</span><span class="n">rank</span><span class="p">)</span>

        <span class="c1"># Compare each set of arguments</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">i_arg</span><span class="p">,</span> <span class="n">f_arg</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">input_args</span><span class="p">,</span> <span class="n">func_args</span><span class="p">)):</span>
            <span class="n">i_arg</span> <span class="o">=</span> <span class="n">i_arg</span><span class="o">.</span><span class="n">value</span>
            <span class="n">f_arg</span> <span class="o">=</span> <span class="n">f_arg</span><span class="o">.</span><span class="n">var</span>
            <span class="c1"># Ignore types which cannot be compared</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i_arg</span> <span class="ow">is</span> <span class="n">Nil</span><span class="p">()</span>
                    <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f_arg</span><span class="p">,</span> <span class="n">FunctionAddress</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="n">f_arg</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">is</span> <span class="n">NativeGeneric</span><span class="p">()):</span>
                <span class="k">continue</span>
            <span class="c1"># Check for compatibility</span>
            <span class="k">if</span> <span class="n">incompatible</span><span class="p">(</span><span class="n">i_arg</span><span class="p">,</span> <span class="n">f_arg</span><span class="p">):</span>
                <span class="n">expected</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_type_description</span><span class="p">(</span><span class="n">f_arg</span><span class="p">,</span> <span class="ow">not</span> <span class="n">elemental</span><span class="p">)</span>
                <span class="n">type_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_type_description</span><span class="p">(</span><span class="n">i_arg</span><span class="p">,</span> <span class="ow">not</span> <span class="n">elemental</span><span class="p">)</span>
                <span class="n">received</span>  <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i_arg</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">type_name</span><span class="si">}</span><span class="s1">)&#39;</span>

                <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">INCOMPATIBLE_ARGUMENT</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">received</span><span class="p">,</span> <span class="n">expr</span><span class="o">.</span><span class="n">func_name</span><span class="p">,</span> <span class="n">expected</span><span class="p">),</span>
                        <span class="n">symbol</span> <span class="o">=</span> <span class="n">expr</span><span class="p">,</span>
                        <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">f_arg</span><span class="o">.</span><span class="n">rank</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">i_arg</span><span class="o">.</span><span class="n">order</span> <span class="o">!=</span> <span class="n">f_arg</span><span class="o">.</span><span class="n">order</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">INCOMPATIBLE_ORDERING</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">arg</span><span class="o">=</span><span class="n">i_arg</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">expr</span><span class="o">.</span><span class="n">func_name</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">f_arg</span><span class="o">.</span><span class="n">order</span><span class="p">),</span>
                        <span class="n">symbol</span> <span class="o">=</span> <span class="n">expr</span><span class="p">,</span>
                        <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SemanticParser._handle_function"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._handle_function">[docs]</a>    <span class="k">def</span> <span class="nf">_handle_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a FunctionCall or an instance of a PyccelInternalFunction</span>
<span class="sd">        from the function information and arguments</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>
<span class="sd">        expr : PyccelAstNode</span>
<span class="sd">               The expression where this call is found (used for error output)</span>
<span class="sd">        func : FunctionDef instance, Interface instance or PyccelInternalFunction type</span>
<span class="sd">               The function being called</span>
<span class="sd">        args : tuple</span>
<span class="sd">               The arguments passed to the function</span>

<span class="sd">        Returns</span>
<span class="sd">        =======</span>
<span class="sd">        new_expr : FunctionCall or PyccelInternalFunction</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">PyccelFunctionDef</span><span class="p">):</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">cls_name</span>
            <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">split_positional_keyword_arguments</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="s1">&#39;dtype&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;tuple&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_infere_type</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="s1">&#39;dtype&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;tuple&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_infere_type</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">new_expr</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">UNRECOGNISED_FUNCTION_CALL</span><span class="p">,</span>
                        <span class="n">symbol</span> <span class="o">=</span> <span class="n">expr</span><span class="p">,</span>
                        <span class="n">severity</span> <span class="o">=</span> <span class="s1">&#39;fatal&#39;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">new_expr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_function</span> <span class="o">==</span> <span class="n">func</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">results</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">PyccelAstNode</span><span class="p">):</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">RECURSIVE_RESULTS_REQUIRED</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">func</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;fatal&quot;</span><span class="p">)</span>

            <span class="n">parent_assign</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">get_direct_user_nodes</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Assign</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">parent_assign</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">func</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tmp_var</span> <span class="o">=</span> <span class="n">PyccelSymbol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_new_name</span><span class="p">())</span>
                <span class="n">assign</span> <span class="o">=</span> <span class="n">Assign</span><span class="p">(</span><span class="n">tmp_var</span><span class="p">,</span> <span class="n">expr</span><span class="p">)</span>
                <span class="n">assign</span><span class="o">.</span><span class="n">set_fst</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">fst</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_additional_exprs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">assign</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">tmp_var</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">FunctionDef</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">arguments</span><span class="p">):</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;Too many arguments passed in function call&quot;</span><span class="p">,</span>
                        <span class="n">symbol</span> <span class="o">=</span> <span class="n">expr</span><span class="p">,</span>
                        <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>

            <span class="n">func_args</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">arguments</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">FunctionDef</span><span class="p">)</span> <span class="k">else</span> <span class="n">func</span><span class="o">.</span><span class="n">functions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">arguments</span>
            <span class="c1"># Sort arguments to match the order in the function definition</span>
            <span class="n">input_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">keyword</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>
            <span class="n">nargs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_args</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ka</span> <span class="ow">in</span> <span class="n">func_args</span><span class="p">[</span><span class="n">nargs</span><span class="p">:]:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">ka</span><span class="o">.</span><span class="n">name</span>
                <span class="n">relevant_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="n">nargs</span><span class="p">:]</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">keyword</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
                <span class="n">n_relevant_args</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">relevant_args</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">n_relevant_args</span> <span class="o">&lt;=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">n_relevant_args</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ka</span><span class="o">.</span><span class="n">has_default</span><span class="p">:</span>
                    <span class="n">input_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ka</span><span class="o">.</span><span class="n">default_call_arg</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">n_relevant_args</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">input_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relevant_args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">args</span> <span class="o">=</span> <span class="n">input_args</span>

            <span class="n">new_expr</span> <span class="o">=</span> <span class="n">FunctionCall</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_function</span><span class="p">)</span>
            <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="n">new_expr</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;Too few arguments passed in function call&quot;</span><span class="p">,</span>
                        <span class="n">symbol</span> <span class="o">=</span> <span class="n">expr</span><span class="p">,</span>
                        <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">FunctionDef</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_argument_compatibility</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">func_args</span><span class="p">,</span>
                            <span class="n">expr</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="n">is_elemental</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">new_expr</span></div>

<div class="viewcode-block" id="SemanticParser._create_variable"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._create_variable">[docs]</a>    <span class="k">def</span> <span class="nf">_create_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">d_lhs</span><span class="p">,</span> <span class="n">arr_in_multirets</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new variable. In most cases this is just a call to</span>
<span class="sd">        Variable.__init__</span>
<span class="sd">        but in the case of a tuple variable it is a recursive call to</span>
<span class="sd">        create all elements in the tuple.</span>
<span class="sd">        This is done separately to _assign_lhs_variable to ensure that</span>
<span class="sd">        elements of a tuple do not exist in the scope</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            The name of the new variable</span>

<span class="sd">        dtype : DataType</span>
<span class="sd">            The data type of the new variable</span>

<span class="sd">        rhs : Variable</span>
<span class="sd">            The value assigned to the lhs. This is required to call</span>
<span class="sd">            self._infere_type recursively for tuples</span>

<span class="sd">        arr_in_multirets : bool</span>
<span class="sd">            If True, the variable that will be created is an array</span>
<span class="sd">            in multi-values return, false otherwise.</span>

<span class="sd">        d_lhs : dict</span>
<span class="sd">            Dictionary of properties for the new Variable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">PyccelSymbol</span><span class="p">):</span>
            <span class="n">is_temp</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">is_temp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">is_temp</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="p">(</span><span class="n">PythonTuple</span><span class="p">,</span> <span class="n">InhomogeneousTupleVariable</span><span class="p">,</span> <span class="n">NumpyNonZero</span><span class="p">))</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">FunctionCall</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">rhs</span><span class="o">.</span><span class="n">funcdef</span><span class="o">.</span><span class="n">results</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">FunctionCall</span><span class="p">):</span>
                <span class="n">iterable</span> <span class="o">=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">funcdef</span><span class="o">.</span><span class="n">results</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">iterable</span> <span class="o">=</span> <span class="n">rhs</span>
            <span class="n">elem_vars</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">is_homogeneous</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">elem_d_lhs_ref</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
                <span class="n">elem_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_new_name</span><span class="p">(</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">)</span>
                <span class="n">elem_d_lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infere_type</span><span class="p">(</span> <span class="n">r</span> <span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">arr_in_multirets</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_target</span><span class="p">(</span> <span class="n">r</span><span class="p">,</span> <span class="n">elem_d_lhs</span> <span class="p">)</span>
                <span class="k">if</span> <span class="n">elem_d_lhs_ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">elem_d_lhs_ref</span> <span class="o">=</span> <span class="n">elem_d_lhs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">is_homogeneous</span> <span class="o">=</span> <span class="n">elem_d_lhs</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NativeGeneric</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">elem_d_lhs</span> <span class="o">!=</span> <span class="n">elem_d_lhs_ref</span><span class="p">:</span>
                    <span class="n">is_homogeneous</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="n">elem_dtype</span> <span class="o">=</span> <span class="n">elem_d_lhs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;datatype&#39;</span><span class="p">)</span>

                <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_variable</span><span class="p">(</span><span class="n">elem_name</span><span class="p">,</span> <span class="n">elem_dtype</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">elem_d_lhs</span><span class="p">)</span>
                <span class="n">elem_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">is_alias</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">elem_vars</span><span class="p">):</span>
                <span class="n">d_lhs</span><span class="p">[</span><span class="s1">&#39;memory_handling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;alias&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d_lhs</span><span class="p">[</span><span class="s1">&#39;memory_handling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_lhs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;memory_handling&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;heap&#39;</span>

            <span class="k">if</span> <span class="n">is_homogeneous</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">d_lhs</span><span class="p">[</span><span class="s1">&#39;memory_handling&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;alias&#39;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">PythonTuple</span><span class="p">)):</span>
                <span class="n">lhs</span> <span class="o">=</span> <span class="n">HomogeneousTupleVariable</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">d_lhs</span><span class="p">,</span> <span class="n">is_temp</span><span class="o">=</span><span class="n">is_temp</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lhs</span> <span class="o">=</span> <span class="n">InhomogeneousTupleVariable</span><span class="p">(</span><span class="n">elem_vars</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">d_lhs</span><span class="p">,</span> <span class="n">is_temp</span><span class="o">=</span><span class="n">is_temp</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_type</span> <span class="o">=</span> <span class="n">HomogeneousTupleVariable</span> \
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="p">(</span><span class="n">HomogeneousTupleVariable</span><span class="p">,</span> <span class="n">Concatenate</span><span class="p">,</span> <span class="n">Duplicate</span><span class="p">))</span> \
                    <span class="k">else</span> <span class="n">Variable</span>
            <span class="n">lhs</span> <span class="o">=</span> <span class="n">new_type</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">d_lhs</span><span class="p">,</span> <span class="n">is_temp</span><span class="o">=</span><span class="n">is_temp</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">lhs</span></div>

<div class="viewcode-block" id="SemanticParser._ensure_target"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._ensure_target">[docs]</a>    <span class="k">def</span> <span class="nf">_ensure_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">d_lhs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Function using data about the new lhs to determine</span>
<span class="sd">        whether the lhs is an alias and the rhs is a target</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">NumpyTranspose</span><span class="p">)</span> <span class="ow">and</span> <span class="n">rhs</span><span class="o">.</span><span class="n">internal_var</span><span class="o">.</span><span class="n">on_heap</span><span class="p">:</span>
            <span class="n">d_lhs</span><span class="p">[</span><span class="s1">&#39;memory_handling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;alias&#39;</span>
            <span class="n">rhs</span><span class="o">.</span><span class="n">internal_var</span><span class="o">.</span><span class="n">is_target</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)</span> <span class="ow">and</span> <span class="n">rhs</span><span class="o">.</span><span class="n">is_ndarray</span><span class="p">:</span>
            <span class="n">d_lhs</span><span class="p">[</span><span class="s1">&#39;memory_handling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;alias&#39;</span>
            <span class="n">rhs</span><span class="o">.</span><span class="n">is_target</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">rhs</span><span class="o">.</span><span class="n">is_alias</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">IndexedElement</span><span class="p">)</span> <span class="ow">and</span> <span class="n">rhs</span><span class="o">.</span><span class="n">rank</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> \
                <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">rhs</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="s1">&#39;is_ndarray&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rhs</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="s1">&#39;is_alias&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)):</span>
            <span class="n">d_lhs</span><span class="p">[</span><span class="s1">&#39;memory_handling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;alias&#39;</span>
            <span class="n">rhs</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">is_target</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">rhs</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">is_alias</span></div>

<div class="viewcode-block" id="SemanticParser._assign_lhs_variable"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._assign_lhs_variable">[docs]</a>    <span class="k">def</span> <span class="nf">_assign_lhs_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">d_var</span><span class="p">,</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">new_expressions</span><span class="p">,</span> <span class="n">is_augassign</span><span class="p">,</span><span class="n">arr_in_multirets</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a lhs based on the information in d_var</span>
<span class="sd">        If the lhs already exists then check that it has the expected properties.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lhs : PyccelSymbol (or DottedName of PyccelSymbols)</span>
<span class="sd">            The representation of the lhs provided by the SyntacticParser</span>

<span class="sd">        d_var : dict</span>
<span class="sd">            Dictionary of expected lhs properties</span>

<span class="sd">        rhs : Variable / expression</span>
<span class="sd">            The representation of the rhs provided by the SemanticParser.</span>
<span class="sd">            This is necessary in order to set the rhs &#39;is_target&#39; property</span>
<span class="sd">            if necessary</span>

<span class="sd">        new_expression : list</span>
<span class="sd">            A list which allows collection of any additional expressions</span>
<span class="sd">            resulting from this operation (e.g. Allocation)</span>

<span class="sd">        is_augassign : bool</span>
<span class="sd">            Indicates whether this is an assign ( = ) or an augassign ( += / -= / etc )</span>
<span class="sd">            This is necessary as the restrictions on the dtype are less strict in this</span>
<span class="sd">            case</span>

<span class="sd">        arr_in_multirets : bool</span>
<span class="sd">            If True, rhs has an array in its results, otherwise, it should be set to False.</span>
<span class="sd">            It helps when we don&#39;t need lhs to be a pointer in case of a returned array in</span>
<span class="sd">            a tuple of results.</span>

<span class="sd">        settings : dictionary</span>
<span class="sd">            Provided to all _visit_ClassName functions</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">IndexedElement</span><span class="p">):</span>
            <span class="n">lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">lhs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">PyccelSymbol</span><span class="p">):</span>

            <span class="n">name</span> <span class="o">=</span> <span class="n">lhs</span>
            <span class="k">if</span> <span class="n">lhs</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_new_name</span><span class="p">()</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">d_var</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;datatype&#39;</span><span class="p">)</span>

            <span class="n">d_lhs</span> <span class="o">=</span> <span class="n">d_var</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1"># ISSUES #177: lhs must be a pointer when rhs is heap array</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">arr_in_multirets</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_target</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">d_lhs</span><span class="p">)</span>

            <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_for_variable</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="c1"># Variable not yet declared (hence array not yet allocated)</span>
            <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

                <span class="c1"># Update variable&#39;s dictionary with information from function decorators</span>
                <span class="n">decorators</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">decorators</span>
                <span class="k">if</span> <span class="n">decorators</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;stack_array&#39;</span> <span class="ow">in</span> <span class="n">decorators</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">decorators</span><span class="p">[</span><span class="s1">&#39;stack_array&#39;</span><span class="p">]:</span>
                            <span class="n">d_lhs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">memory_handling</span><span class="o">=</span><span class="s1">&#39;stack&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s1">&#39;allow_negative_index&#39;</span> <span class="ow">in</span> <span class="n">decorators</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">lhs</span> <span class="ow">in</span> <span class="n">decorators</span><span class="p">[</span><span class="s1">&#39;allow_negative_index&#39;</span><span class="p">]:</span>
                            <span class="n">d_lhs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">allows_negative_indexes</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># We cannot allow the definition of a stack array from a shape which</span>
                <span class="c1"># is unknown at the declaration</span>
                <span class="k">if</span> <span class="n">d_lhs</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">d_lhs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;memory_handling&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;stack&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">d_lhs</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">FunctionCall</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">funcdef</span><span class="o">.</span><span class="n">is_pure</span><span class="p">)</span> <span class="ow">or</span> \
                                <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">funcdef</span><span class="o">.</span><span class="n">is_pure</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">get_attribute_nodes</span><span class="p">(</span><span class="n">FunctionCall</span><span class="p">)):</span>
                            <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">STACK_ARRAY_SHAPE_UNPURE_FUNC</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">funcdef</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">,</span>
                            <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">))</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">is_argument</span><span class="p">)</span> \
                                <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">is_argument</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">get_attribute_nodes</span><span class="p">(</span><span class="n">Variable</span><span class="p">)):</span>
                            <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">STACK_ARRAY_UNKNOWN_SHAPE</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">,</span>
                            <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">))</span>

                <span class="n">new_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_expected_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

                <span class="c1"># Create new variable</span>
                <span class="n">lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_variable</span><span class="p">(</span><span class="n">new_name</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">d_lhs</span><span class="p">,</span> <span class="n">arr_in_multirets</span><span class="o">=</span><span class="n">arr_in_multirets</span><span class="p">)</span>

                <span class="c1"># Add variable to scope</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">insert_variable</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

                <span class="c1"># ...</span>
                <span class="c1"># Add memory allocation if needed</span>
                <span class="n">array_declared_in_function</span> <span class="o">=</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">FunctionCall</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="o">.</span><span class="n">funcdef</span><span class="p">,</span> <span class="n">PyccelFunctionDef</span><span class="p">)</span> \
                                            <span class="ow">and</span> <span class="ow">not</span> <span class="n">rhs</span><span class="o">.</span><span class="n">funcdef</span><span class="o">.</span><span class="n">is_elemental</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">HomogeneousTupleVariable</span><span class="p">))</span> <span class="ow">or</span> <span class="n">arr_in_multirets</span>
                <span class="k">if</span> <span class="n">lhs</span><span class="o">.</span><span class="n">on_heap</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">array_declared_in_function</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">is_loop</span><span class="p">:</span>
                        <span class="c1"># Array defined in a loop may need reallocation at every cycle</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">ARRAY_DEFINITION_IN_LOOP</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;warning&#39;</span><span class="p">,</span>
                            <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">))</span>
                        <span class="n">status</span><span class="o">=</span><span class="s1">&#39;unknown&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Array defined outside of a loop will be allocated only once</span>
                        <span class="n">status</span><span class="o">=</span><span class="s1">&#39;unallocated&#39;</span>

                    <span class="c1"># Create Allocate node</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">InhomogeneousTupleVariable</span><span class="p">):</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">lhs</span><span class="o">.</span><span class="n">get_vars</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">rank</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">new_args</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">InhomogeneousTupleVariable</span><span class="p">):</span>
                                    <span class="n">new_args</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">get_vars</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">rank</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">new_expressions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Allocate</span><span class="p">(</span><span class="n">a</span><span class="p">,</span>
                                        <span class="n">shape</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">alloc_shape</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">))</span>
                                    <span class="c1"># Add memory deallocation for array variables</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_allocs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                            <span class="n">args</span> <span class="o">=</span> <span class="n">new_args</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_expressions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Allocate</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">lhs</span><span class="o">.</span><span class="n">alloc_shape</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">lhs</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">))</span>
                <span class="c1"># ...</span>

                <span class="c1"># ...</span>
                <span class="c1"># Add memory deallocation for array variables</span>
                <span class="k">if</span> <span class="n">lhs</span><span class="o">.</span><span class="n">is_ndarray</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">lhs</span><span class="o">.</span><span class="n">on_stack</span><span class="p">:</span>
                    <span class="c1"># Create Deallocate node</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_allocs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lhs</span><span class="p">)</span>
                <span class="c1"># ...</span>

                <span class="c1"># We cannot allow the definition of a stack array in a loop</span>
                <span class="k">if</span> <span class="n">lhs</span><span class="o">.</span><span class="n">is_stack_array</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">is_loop</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">STACK_ARRAY_DEFINITION_IN_LOOP</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">,</span>
                        <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">))</span>

                <span class="c1"># Not yet supported for arrays: x=y+z, x=b[:]</span>
                <span class="c1"># Because we cannot infer shape of right-hand side yet</span>
                <span class="n">know_lhs_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">lhs</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">all</span><span class="p">(</span><span class="n">sh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">sh</span> <span class="ow">in</span> <span class="n">lhs</span><span class="o">.</span><span class="n">alloc_shape</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">know_lhs_shape</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Cannot infer shape of right-hand side for expression </span><span class="si">{</span><span class="n">lhs</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">rhs</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">PYCCEL_RESTRICTION_TODO</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">msg</span><span class="p">,</span>
                        <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                        <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>

            <span class="c1"># Variable already exists</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_infered_type_matches_existing</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">d_var</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">is_augassign</span><span class="p">,</span> <span class="n">new_expressions</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>

                <span class="c1"># in the case of elemental, lhs is not of the same dtype as</span>
                <span class="c1"># var.</span>
                <span class="c1"># TODO d_lhs must be consistent with var!</span>
                <span class="c1"># the following is a small fix, since lhs must be already</span>
                <span class="c1"># declared</span>
                <span class="n">lhs</span> <span class="o">=</span> <span class="n">var</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">DottedName</span><span class="p">):</span>

            <span class="n">dtype</span> <span class="o">=</span> <span class="n">d_var</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;datatype&#39;</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_expected_name</span><span class="p">(</span><span class="n">lhs</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_function</span> <span class="o">==</span> <span class="s1">&#39;__init__&#39;</span><span class="p">:</span>

                <span class="bp">cls</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">)</span>
                <span class="n">cls_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">cls_base</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="bp">cls</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">cls_name</span><span class="p">,</span> <span class="s1">&#39;classes&#39;</span><span class="p">)</span>

                <span class="n">attributes</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">attributes</span>
                <span class="n">parent</span>     <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">superclass</span>
                <span class="n">attributes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
                <span class="n">n_name</span>     <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">lhs</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

                <span class="c1"># update the self variable with the new attributes</span>

                <span class="n">var</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">)</span>
                <span class="n">d_lhs</span>    <span class="o">=</span> <span class="n">d_var</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>


                <span class="c1"># ISSUES #177: lhs must be a pointer when rhs is heap array</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">arr_in_multirets</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_target</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">d_lhs</span><span class="p">)</span>

                <span class="n">member</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_variable</span><span class="p">(</span><span class="n">n_name</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">d_lhs</span><span class="p">)</span>
                <span class="n">lhs</span>    <span class="o">=</span> <span class="n">member</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">member</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">new_class</span> <span class="o">=</span> <span class="n">DottedVariable</span><span class="p">,</span> <span class="n">lhs</span> <span class="o">=</span> <span class="n">var</span><span class="p">)</span>

                <span class="c1"># update the attributes of the class and push it to the scope</span>
                <span class="n">attributes</span> <span class="o">+=</span> <span class="p">[</span><span class="n">member</span><span class="p">]</span>
                <span class="n">new_cls</span> <span class="o">=</span> <span class="n">ClassDef</span><span class="p">(</span><span class="n">cls_name</span><span class="p">,</span> <span class="n">attributes</span><span class="p">,</span> <span class="p">[],</span> <span class="n">superclass</span><span class="o">=</span><span class="n">parent</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">parent_scope</span><span class="o">.</span><span class="n">insert_class</span><span class="p">(</span><span class="n">new_cls</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lhs_type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">lhs</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_assign_lhs_variable does not handle </span><span class="si">{</span><span class="n">lhs_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">lhs</span></div>

<div class="viewcode-block" id="SemanticParser._ensure_infered_type_matches_existing"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._ensure_infered_type_matches_existing">[docs]</a>    <span class="k">def</span> <span class="nf">_ensure_infered_type_matches_existing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">d_var</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">is_augassign</span><span class="p">,</span> <span class="n">new_expressions</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensure that the inferred type of the new variable, matches the existing variable (which has the</span>
<span class="sd">        same name). If this is not the case then errors are raised preventing pyccel reaching the codegen</span>
<span class="sd">        stage.</span>
<span class="sd">        This function also handles any reallocations caused by differing shapes between the two objects.</span>
<span class="sd">        These allocations/deallocations are saved in the list new_expressions</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dtype : DataType</span>
<span class="sd">                The inferred DataType</span>
<span class="sd">        d_var : dict</span>
<span class="sd">                The inferred information about the variable. Usually created by the _infere_type function</span>
<span class="sd">        var   : Variable</span>
<span class="sd">                The existing variable</span>
<span class="sd">        is_augassign : bool</span>
<span class="sd">                A boolean indicating if the assign statement is an augassign (tests are less strict)</span>
<span class="sd">        new_expressions : list</span>
<span class="sd">                A list to which any new expressions created are appended</span>
<span class="sd">        rhs   : PyccelAstNode</span>
<span class="sd">                The right hand side of the expression : lhs=rhs</span>
<span class="sd">                If is_augassign is False, this value is not used</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">precision</span> <span class="o">=</span> <span class="n">d_var</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;precision&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">internal_precision</span> <span class="o">=</span> <span class="n">default_precision</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">dtype</span><span class="p">)]</span> <span class="k">if</span> <span class="n">precision</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">precision</span>

        <span class="c1"># TODO improve check type compatibility</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s1">&#39;dtype&#39;</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">INCOMPATIBLE_TYPES_IN_ASSIGNMENT</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;&lt;module&gt;&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="p">),</span>
                    <span class="n">symbol</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                    <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="n">is_augassign</span> <span class="ow">and</span> <span class="n">var</span><span class="o">.</span><span class="n">is_ndarray</span> <span class="ow">and</span> <span class="n">var</span><span class="o">.</span><span class="n">is_target</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">ARRAY_ALREADY_IN_USE</span><span class="p">,</span>
                <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                        <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="n">is_augassign</span> <span class="ow">and</span> <span class="n">var</span><span class="o">.</span><span class="n">is_ndarray</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="p">(</span><span class="n">Variable</span><span class="p">,</span> <span class="n">IndexedElement</span><span class="p">))</span> <span class="ow">and</span> <span class="n">var</span><span class="o">.</span><span class="n">on_heap</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">ASSIGN_ARRAYS_ONE_ANOTHER</span><span class="p">,</span>
                <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                        <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">var</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">var</span><span class="o">.</span><span class="n">is_ndarray</span> <span class="ow">and</span> <span class="n">var</span><span class="o">.</span><span class="n">is_alias</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">NumpyNewArray</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">INVALID_POINTER_REASSIGN</span><span class="p">,</span>
                <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                        <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">var</span><span class="o">.</span><span class="n">is_ndarray</span> <span class="ow">and</span> <span class="n">var</span><span class="o">.</span><span class="n">is_alias</span><span class="p">:</span>
            <span class="c1"># we allow pointers to be reassigned multiple times</span>
            <span class="c1"># pointers reassigning need to call free_pointer func</span>
            <span class="c1"># to remove memory leaks</span>
            <span class="n">new_expressions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Deallocate</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>

        <span class="k">elif</span> <span class="nb">str</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="ow">or</span> \
                <span class="n">internal_precision</span> <span class="o">!=</span> <span class="n">get_final_precision</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">is_augassign</span><span class="p">:</span>
                <span class="n">tmp_result</span> <span class="o">=</span> <span class="n">PyccelAdd</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
                <span class="n">result_dtype</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tmp_result</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                <span class="n">result_precision</span> <span class="o">=</span> <span class="n">get_final_precision</span><span class="p">(</span><span class="n">tmp_result</span><span class="p">)</span>
                <span class="n">raise_error</span> <span class="o">=</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">!=</span> <span class="n">result_dtype</span> <span class="ow">or</span> \
                        <span class="n">get_final_precision</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="o">!=</span> <span class="n">result_precision</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">raise_error</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">raise_error</span><span class="p">:</span>
                <span class="c1"># Get type name from cast function (handles precision implicitly)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">d1</span> <span class="o">=</span> <span class="n">DtypePrecisionToCastFunction</span><span class="p">[</span><span class="n">var</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">var</span><span class="o">.</span><span class="n">precision</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">d1</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">d2</span> <span class="o">=</span> <span class="n">DtypePrecisionToCastFunction</span><span class="p">[</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">precision</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">d2</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

                <span class="n">name</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span>
                <span class="n">rhs_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">INCOMPATIBLE_TYPES_IN_ASSIGNMENT</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">),</span>
                    <span class="n">symbol</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">rhs_str</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                    <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="n">is_augassign</span><span class="p">:</span>

            <span class="n">rank</span>  <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s1">&#39;rank&#39;</span> <span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">)</span>
            <span class="n">order</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s1">&#39;order&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">)</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">rank</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">rank</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">order</span><span class="p">):</span>

                <span class="n">txt</span> <span class="o">=</span> <span class="s1">&#39;|</span><span class="si">{name}</span><span class="s1">| </span><span class="si">{dtype}{old}</span><span class="s1"> &lt;-&gt; </span><span class="si">{dtype}{new}</span><span class="s1">&#39;</span>
                <span class="k">def</span> <span class="nf">format_shape</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                    <span class="k">return</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">s</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">old</span><span class="o">=</span><span class="n">format_shape</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>
                    <span class="n">new</span><span class="o">=</span><span class="n">format_shape</span><span class="p">(</span><span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]))</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">INCOMPATIBLE_REDEFINITION</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">txt</span><span class="p">,</span>
                    <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                    <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">shape</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">is_argument</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">ARRAY_IS_ARG</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">var</span><span class="p">,</span>
                        <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">,</span>
                        <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">))</span>

                <span class="k">elif</span> <span class="n">var</span><span class="o">.</span><span class="n">is_stack_array</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">INCOMPATIBLE_REDEFINITION_STACK_ARRAY</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">,</span>
                        <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">))</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">var</span><span class="o">.</span><span class="n">set_changeable_shape</span><span class="p">()</span>
                    <span class="n">previous_allocations</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">get_direct_user_nodes</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">Allocate</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">previous_allocations</span><span class="p">:</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;PYCCEL INTERNAL ERROR : Variable exists already, but it has never been allocated&quot;</span><span class="p">,</span>
                                <span class="n">symbol</span><span class="o">=</span><span class="n">var</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>

                    <span class="n">last_allocation</span> <span class="o">=</span> <span class="n">previous_allocations</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                    <span class="c1"># Find outermost IfSection of last allocation</span>
                    <span class="n">last_alloc_ifsection</span> <span class="o">=</span> <span class="n">last_allocation</span><span class="o">.</span><span class="n">get_user_nodes</span><span class="p">(</span><span class="n">IfSection</span><span class="p">)</span>
                    <span class="n">alloc_ifsection</span> <span class="o">=</span> <span class="n">last_alloc_ifsection</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">last_alloc_ifsection</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">last_alloc_ifsection</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">alloc_ifsection</span> <span class="o">=</span> <span class="n">last_alloc_ifsection</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">last_alloc_ifsection</span> <span class="o">=</span> <span class="n">alloc_ifsection</span><span class="o">.</span><span class="n">get_user_nodes</span><span class="p">(</span><span class="n">IfSection</span><span class="p">)</span>

                    <span class="n">ifsection_has_if</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">alloc_ifsection</span><span class="o">.</span><span class="n">get_direct_user_nodes</span><span class="p">(</span>
                                                        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">If</span><span class="p">)))</span> <span class="o">==</span> <span class="mi">1</span> \
                                    <span class="k">if</span> <span class="n">alloc_ifsection</span> <span class="k">else</span> <span class="kc">False</span>

                    <span class="k">if</span> <span class="n">alloc_ifsection</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ifsection_has_if</span><span class="p">:</span>
                        <span class="n">status</span> <span class="o">=</span> <span class="n">last_allocation</span><span class="o">.</span><span class="n">status</span>
                    <span class="k">elif</span> <span class="n">last_allocation</span><span class="o">.</span><span class="n">get_user_nodes</span><span class="p">((</span><span class="n">If</span><span class="p">,</span> <span class="n">For</span><span class="p">,</span> <span class="n">While</span><span class="p">)):</span>
                        <span class="n">status</span><span class="o">=</span><span class="s1">&#39;unknown&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">status</span><span class="o">=</span><span class="s1">&#39;allocated&#39;</span>
                    <span class="n">new_expressions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Allocate</span><span class="p">(</span><span class="n">var</span><span class="p">,</span>
                        <span class="n">shape</span><span class="o">=</span><span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">],</span>
                        <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="s1">&#39;unallocated&#39;</span><span class="p">:</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">ARRAY_REALLOCATION</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;warning&#39;</span><span class="p">,</span>
                            <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Same shape as before</span>
                <span class="n">previous_allocations</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">get_direct_user_nodes</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">Allocate</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">previous_allocations</span> <span class="ow">and</span> <span class="n">previous_allocations</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_user_nodes</span><span class="p">(</span><span class="n">IfSection</span><span class="p">)</span> \
                        <span class="ow">and</span> <span class="ow">not</span> <span class="n">previous_allocations</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_user_nodes</span><span class="p">((</span><span class="n">If</span><span class="p">)):</span>
                    <span class="c1"># If previously allocated in If still under construction</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="n">previous_allocations</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">status</span>

                    <span class="n">new_expressions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Allocate</span><span class="p">(</span><span class="n">var</span><span class="p">,</span>
                        <span class="n">shape</span><span class="o">=</span><span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">],</span>
                        <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">precision</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">precision</span> <span class="o">!=</span> <span class="n">var</span><span class="o">.</span><span class="n">precision</span><span class="p">:</span>
            <span class="n">var</span><span class="o">.</span><span class="n">use_exact_precision</span><span class="p">()</span></div>

<div class="viewcode-block" id="SemanticParser._assign_GeneratorComprehension"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._assign_GeneratorComprehension">[docs]</a>    <span class="k">def</span> <span class="nf">_assign_GeneratorComprehension</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lhs_name</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Visit the GeneratorComprehension node creating all necessary expressions</span>
<span class="sd">        for its definition</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lhs_name : str</span>
<span class="sd">                    The name to which the expression is assigned</span>
<span class="sd">        expr : GeneratorComprehension</span>

<span class="sd">        Results</span>
<span class="sd">        -------</span>
<span class="sd">        new_expr : CodeBlock</span>
<span class="sd">                   CodeBlock containing the semantic version of the GeneratorComprehension node</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span>   <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">expr</span>

        <span class="n">loop</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">loops</span>
        <span class="n">nlevels</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Create throw-away variable to help obtain result type</span>
        <span class="n">index</span>   <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_new_name</span><span class="p">(</span><span class="s1">&#39;to_delete&#39;</span><span class="p">),</span> <span class="n">is_temp</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">insert_variable</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">new_expr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">For</span><span class="p">):</span>
            <span class="n">nlevels</span><span class="o">+=</span><span class="mi">1</span>
            <span class="n">iterable</span> <span class="o">=</span> <span class="n">Iterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">loop</span><span class="o">.</span><span class="n">iterable</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">))</span>
            <span class="n">n_index</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">iterable</span><span class="o">.</span><span class="n">num_loop_counters_required</span><span class="p">)</span>
            <span class="c1"># Set dummy indices to iterable object in order to be able to</span>
            <span class="c1"># obtain a target with a deducible dtype</span>
            <span class="n">iterable</span><span class="o">.</span><span class="n">set_loop_counter</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">*</span><span class="n">n_index</span><span class="p">)</span>

            <span class="n">iterator</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">target</span>

            <span class="c1"># Collect a target with a deducible dtype</span>
            <span class="n">iterator_rhs</span> <span class="o">=</span> <span class="n">iterable</span><span class="o">.</span><span class="n">get_target_from_range</span><span class="p">()</span>
            <span class="c1"># Use _visit_Assign to create the requested iterator with the correct type</span>
            <span class="c1"># The result of this operation is not stored, it is just used to declare</span>
            <span class="c1"># iterator with the correct dtype to allow correct dtype deductions later</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">Assign</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="n">iterator_rhs</span><span class="p">,</span> <span class="n">fst</span><span class="o">=</span><span class="n">expr</span><span class="o">.</span><span class="n">fst</span><span class="p">))</span>

            <span class="n">loop_elem</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loop_elem</span><span class="p">,</span> <span class="n">Assign</span><span class="p">):</span>
                <span class="c1"># If the result contains a GeneratorComprehension, treat it and replace</span>
                <span class="c1"># it with it&#39;s lhs variable before continuing</span>
                <span class="n">gens</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">loop_elem</span><span class="o">.</span><span class="n">get_attribute_nodes</span><span class="p">(</span><span class="n">GeneratorComprehension</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gens</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">gen</span> <span class="o">=</span> <span class="n">gens</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gen</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span> <span class="n">PyccelSymbol</span><span class="p">)</span> <span class="ow">and</span> <span class="n">gen</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">is_temp</span>
                    <span class="n">gen_lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_new_name</span><span class="p">()</span> <span class="k">if</span> <span class="n">gen</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">is_temp</span> <span class="k">else</span> <span class="n">gen</span><span class="o">.</span><span class="n">lhs</span>
                    <span class="n">assign</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">Assign</span><span class="p">(</span><span class="n">gen_lhs</span><span class="p">,</span> <span class="n">gen</span><span class="p">,</span> <span class="n">fst</span><span class="o">=</span><span class="n">gen</span><span class="o">.</span><span class="n">fst</span><span class="p">))</span>
                    <span class="n">new_expr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">assign</span><span class="p">)</span>
                    <span class="n">loop</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="n">assign</span><span class="o">.</span><span class="n">lhs</span><span class="p">)</span>
                    <span class="n">loop_elem</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">loop</span> <span class="o">=</span> <span class="n">loop_elem</span>
        <span class="c1"># Remove the throw-away variable from the scope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">remove_variable</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

        <span class="c1"># Visit result expression (correctly defined as iterator</span>
        <span class="c1"># objects exist in the scope despite not being defined)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">CodeBlock</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Infer the final dtype of the expression</span>
        <span class="n">d_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infere_type</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">d_var</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;datatype&#39;</span><span class="p">)</span>
        <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;is_temp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">is_temp</span>

        <span class="n">lhs</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_for_variable</span><span class="p">(</span><span class="n">lhs_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lhs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_infered_type_matches_existing</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">d_var</span><span class="p">,</span> <span class="n">lhs</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">new_expr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lhs_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_expected_name</span><span class="p">(</span><span class="n">lhs_name</span><span class="p">)</span>
            <span class="n">lhs</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">lhs_name</span><span class="p">,</span> <span class="o">**</span><span class="n">d_var</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">insert_variable</span><span class="p">(</span><span class="n">lhs</span><span class="p">)</span>

        <span class="c1"># Iterate over the loops</span>
        <span class="c1"># This provides the definitions of iterators as well</span>
        <span class="c1"># as the central expression</span>
        <span class="n">loops</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">loops</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)]</span>

        <span class="c1"># If necessary add additional expressions corresponding</span>
        <span class="c1"># to nested GeneratorComprehensions</span>
        <span class="k">if</span> <span class="n">new_expr</span><span class="p">:</span>
            <span class="n">loop</span> <span class="o">=</span> <span class="n">loops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlevels</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">loop</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">new_expr</span><span class="p">:</span>
                <span class="n">loop</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">insert2body</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">back</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">e</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">update_parent_scope</span><span class="p">(</span><span class="n">loop</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span> <span class="n">is_loop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">FunctionalSum</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">LiteralInteger</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">str_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;complex&#39;</span><span class="p">]:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">LiteralFloat</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">FunctionalMin</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">math_constants</span><span class="p">[</span><span class="s1">&#39;inf&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">FunctionalMax</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">PyccelUnarySub</span><span class="p">(</span><span class="n">math_constants</span><span class="p">[</span><span class="s1">&#39;inf&#39;</span><span class="p">])</span>

        <span class="c1"># Initialise result with correct initial value</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="n">Assign</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="n">stmt</span><span class="o">.</span><span class="n">set_fst</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">fst</span><span class="p">)</span>
        <span class="n">loops</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">stmt</span><span class="p">)</span>

        <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">indices</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">FunctionalSum</span><span class="p">):</span>
            <span class="n">expr_new</span> <span class="o">=</span> <span class="n">FunctionalSum</span><span class="p">(</span><span class="n">loops</span><span class="p">,</span> <span class="n">lhs</span><span class="o">=</span><span class="n">lhs</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">FunctionalMin</span><span class="p">):</span>
            <span class="n">expr_new</span> <span class="o">=</span> <span class="n">FunctionalMin</span><span class="p">(</span><span class="n">loops</span><span class="p">,</span> <span class="n">lhs</span><span class="o">=</span><span class="n">lhs</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">FunctionalMax</span><span class="p">):</span>
            <span class="n">expr_new</span> <span class="o">=</span> <span class="n">FunctionalMax</span><span class="p">(</span><span class="n">loops</span><span class="p">,</span> <span class="n">lhs</span><span class="o">=</span><span class="n">lhs</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">)</span>
        <span class="n">expr_new</span><span class="o">.</span><span class="n">set_fst</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">fst</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">expr_new</span></div>

    <span class="c1">#====================================================</span>
    <span class="c1">#                 _visit functions</span>
    <span class="c1">#====================================================</span>


<div class="viewcode-block" id="SemanticParser._visit"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit">[docs]</a>    <span class="k">def</span> <span class="nf">_visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Annotates the AST.</span>

<span class="sd">        The annotation is done by finding the appropriate function _visit_X</span>
<span class="sd">        for the object expr. X is the type of the object expr. If this function</span>
<span class="sd">        does not exist then the method resolution order is used to search for</span>
<span class="sd">        other compatible _visit_X functions. If none are found then an error is</span>
<span class="sd">        raised</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># TODO - add settings to Errors</span>
        <span class="c1">#      - line and column</span>
        <span class="c1">#      - blocking errors</span>
        <span class="n">current_fst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span><span class="s1">&#39;fst&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">expr</span><span class="o">.</span><span class="n">fst</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">fst</span>

        <span class="n">classes</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span><span class="o">.</span><span class="vm">__mro__</span>
        <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
            <span class="n">annotation_method</span> <span class="o">=</span> <span class="s1">&#39;_visit_&#39;</span> <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">annotation_method</span><span class="p">):</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">annotation_method</span><span class="p">)(</span><span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Basic</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="p">:</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">set_fst</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span> <span class="o">=</span> <span class="n">current_fst</span>
                <span class="k">return</span> <span class="n">obj</span>

        <span class="c1"># Unknown object, we raise an error.</span>
        <span class="k">return</span> <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">PYCCEL_RESTRICTION_TODO</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">expr</span><span class="p">),</span>
            <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
            <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SemanticParser._visit_Module"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_Module">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_Module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">program</span><span class="p">)</span><span class="o">.</span><span class="n">body</span>
        <span class="n">program_body</span>      <span class="o">=</span> <span class="p">[]</span>
        <span class="n">init_func_body</span>    <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mod_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metavars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;module_name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mod_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mod_name</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">insert_symbol</span><span class="p">(</span><span class="n">mod_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mod_name</span> <span class="o">=</span> <span class="n">mod_name</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">AsName</span><span class="p">):</span>
            <span class="n">name_suffix</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name_suffix</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">name</span>
        <span class="n">prog_name</span> <span class="o">=</span> <span class="s1">&#39;prog_&#39;</span><span class="o">+</span><span class="n">name_suffix</span>
        <span class="n">prog_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_new_name</span><span class="p">(</span><span class="n">prog_name</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">body</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">If</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">condition</span><span class="p">,</span> <span class="n">InProgram</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">blocks</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">blocks</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">condition</span><span class="p">,</span> <span class="n">InProgram</span><span class="p">):</span>
                            <span class="n">program_body</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">init_func_body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">init_func_body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">CodeBlock</span><span class="p">):</span>
                <span class="n">init_func_body</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">init_func_body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

        <span class="n">variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variables</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="p">)</span>
        <span class="n">init_func</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">free_func</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">program</span>   <span class="o">=</span> <span class="kc">None</span>

        <span class="n">comment_types</span> <span class="o">=</span> <span class="p">(</span><span class="n">Header</span><span class="p">,</span> <span class="n">MacroFunction</span><span class="p">,</span> <span class="n">EmptyNode</span><span class="p">,</span> <span class="n">Comment</span><span class="p">,</span> <span class="n">CommentBlock</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">comment_types</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">init_func_body</span><span class="p">):</span>
            <span class="c1"># If there are any initialisation statements then create an initialisation function</span>
            <span class="n">init_var</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">NativeBool</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_new_name</span><span class="p">(</span><span class="s1">&#39;initialised&#39;</span><span class="p">),</span>
                                <span class="n">is_private</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">init_func_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_new_name</span><span class="p">(</span><span class="n">name_suffix</span><span class="o">+</span><span class="s1">&#39;__init&#39;</span><span class="p">)</span>
            <span class="c1"># Ensure that the function is correctly defined within the namespaces</span>
            <span class="n">init_scope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_new_function_scope</span><span class="p">(</span><span class="n">init_func_name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">init_func_body</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">ScopedNode</span><span class="p">):</span>
                    <span class="n">b</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">update_parent_scope</span><span class="p">(</span><span class="n">init_scope</span><span class="p">,</span> <span class="n">is_loop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">FunctionalFor</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">loops</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">ScopedNode</span><span class="p">):</span>
                            <span class="n">l</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">update_parent_scope</span><span class="p">(</span><span class="n">init_scope</span><span class="p">,</span> <span class="n">is_loop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">exit_function_scope</span><span class="p">()</span>

            <span class="c1"># Update variable scope for temporaries</span>
            <span class="n">to_remove</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">is_temp</span><span class="p">:</span>
                    <span class="n">init_scope</span><span class="o">.</span><span class="n">insert_variable</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="n">to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

            <span class="c1"># Remove in a second loop so the dictionary doesn&#39;t change during iteration</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">to_remove</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">remove_variable</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="n">variables</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

            <span class="c1"># Get deallocations</span>
            <span class="n">deallocs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_garbage_collector</span><span class="p">(</span><span class="n">CodeBlock</span><span class="p">(</span><span class="n">init_func_body</span><span class="p">))</span>

            <span class="c1"># Deallocate temporaries in init function</span>
            <span class="n">dealloc_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">variable</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">deallocs</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dealloc_vars</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">to_remove</span><span class="p">:</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="n">deallocs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">init_func_body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

            <span class="n">init_func_body</span> <span class="o">=</span> <span class="n">If</span><span class="p">(</span><span class="n">IfSection</span><span class="p">(</span><span class="n">PyccelNot</span><span class="p">(</span><span class="n">init_var</span><span class="p">),</span>
                                <span class="n">init_func_body</span><span class="o">+</span><span class="p">[</span><span class="n">Assign</span><span class="p">(</span><span class="n">init_var</span><span class="p">,</span> <span class="n">LiteralTrue</span><span class="p">())]))</span>

            <span class="n">init_func</span> <span class="o">=</span> <span class="n">FunctionDef</span><span class="p">(</span><span class="n">init_func_name</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[</span><span class="n">init_func_body</span><span class="p">],</span>
                    <span class="n">global_vars</span> <span class="o">=</span> <span class="n">variables</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">init_scope</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">insert_function</span><span class="p">(</span><span class="n">init_func</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">init_func</span><span class="p">:</span>
            <span class="n">free_func_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_new_name</span><span class="p">(</span><span class="n">name_suffix</span><span class="o">+</span><span class="s1">&#39;__free&#39;</span><span class="p">)</span>
            <span class="n">pyccelised_imports</span> <span class="o">=</span> <span class="p">[</span><span class="n">imp</span> <span class="k">for</span> <span class="n">imp_name</span><span class="p">,</span> <span class="n">imp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">imports</span><span class="p">[</span><span class="s1">&#39;imports&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> \
                             <span class="k">if</span> <span class="n">imp_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_parsers</span><span class="p">]</span>

            <span class="n">import_frees</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">d_parsers</span><span class="p">[</span><span class="n">imp</span><span class="o">.</span><span class="n">source</span><span class="p">]</span><span class="o">.</span><span class="n">semantic_parser</span><span class="o">.</span><span class="n">ast</span><span class="o">.</span><span class="n">free_func</span> <span class="k">for</span> <span class="n">imp</span> <span class="ow">in</span> <span class="n">pyccelised_imports</span> \
                                <span class="k">if</span> <span class="n">imp</span><span class="o">.</span><span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_parsers</span><span class="p">]</span>
            <span class="n">import_frees</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">imp</span><span class="o">.</span><span class="n">target</span> <span class="k">else</span> \
                             <span class="n">f</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">target</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">imp</span><span class="o">.</span><span class="n">target</span> \
                                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">AsName</span><span class="p">)</span> <span class="ow">and</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">))</span> \
                            <span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">imp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">import_frees</span><span class="p">,</span> <span class="n">pyccelised_imports</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">deallocs</span> <span class="ow">or</span> <span class="n">import_frees</span><span class="p">:</span>
                <span class="c1"># If there is anything that needs deallocating when the module goes out of scope</span>
                <span class="c1"># create a deallocation function</span>
                <span class="n">import_free_calls</span> <span class="o">=</span> <span class="p">[</span><span class="n">FunctionCall</span><span class="p">(</span><span class="n">f</span><span class="p">,[],[])</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">import_frees</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
                <span class="n">free_func_body</span> <span class="o">=</span> <span class="n">If</span><span class="p">(</span><span class="n">IfSection</span><span class="p">(</span><span class="n">init_var</span><span class="p">,</span>
                    <span class="n">import_free_calls</span><span class="o">+</span><span class="n">deallocs</span><span class="o">+</span><span class="p">[</span><span class="n">Assign</span><span class="p">(</span><span class="n">init_var</span><span class="p">,</span> <span class="n">LiteralFalse</span><span class="p">())]))</span>
                <span class="c1"># Ensure that the function is correctly defined within the namespaces</span>
                <span class="n">scope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_new_function_scope</span><span class="p">(</span><span class="n">free_func_name</span><span class="p">)</span>
                <span class="n">free_func</span> <span class="o">=</span> <span class="n">FunctionDef</span><span class="p">(</span><span class="n">free_func_name</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[</span><span class="n">free_func_body</span><span class="p">],</span>
                                    <span class="n">global_vars</span> <span class="o">=</span> <span class="n">variables</span><span class="p">,</span> <span class="n">scope</span> <span class="o">=</span> <span class="n">scope</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exit_function_scope</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">insert_function</span><span class="p">(</span><span class="n">free_func</span><span class="p">)</span>

        <span class="n">funcs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">interfaces</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">FunctionDef</span><span class="p">):</span>
                <span class="n">funcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">Interface</span><span class="p">):</span>
                <span class="n">interfaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="c1"># in the case of a header file, we need to convert all headers to</span>
        <span class="c1"># FunctionDef etc ...</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_header_file</span><span class="p">:</span>
            <span class="c1"># ARA : issue-999</span>
            <span class="n">is_external</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metavars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;external&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">headers</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">FunctionHeader</span><span class="p">)</span> <span class="ow">and</span> \
                        <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">MethodHeader</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">):</span>
                    <span class="n">F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;functions&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">F</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">func_defs</span> <span class="o">=</span> <span class="p">[</span><span class="n">vi</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">headers</span> <span class="k">for</span> <span class="n">vi</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">create_definition</span><span class="p">(</span><span class="n">is_external</span><span class="o">=</span><span class="n">is_external</span><span class="p">)]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">func_defs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">F</span> <span class="o">=</span> <span class="n">func_defs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">funcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">F</span> <span class="o">=</span> <span class="n">Interface</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">func_defs</span><span class="p">)</span>
                            <span class="n">interfaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">insert_function</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">IMPORTING_EXISTING_IDENTIFIED</span><span class="p">,</span>
                                <span class="n">symbol</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">rank</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">is_alias</span><span class="p">:</span>
                <span class="n">v</span><span class="o">.</span><span class="n">is_target</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">mod</span> <span class="o">=</span> <span class="n">Module</span><span class="p">(</span><span class="n">mod_name</span><span class="p">,</span>
                    <span class="n">variables</span><span class="p">,</span>
                    <span class="n">funcs</span><span class="p">,</span>
                    <span class="n">init_func</span> <span class="o">=</span> <span class="n">init_func</span><span class="p">,</span>
                    <span class="n">free_func</span> <span class="o">=</span> <span class="n">free_func</span><span class="p">,</span>
                    <span class="n">interfaces</span><span class="o">=</span><span class="n">interfaces</span><span class="p">,</span>
                    <span class="n">classes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
                    <span class="n">imports</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">imports</span><span class="p">[</span><span class="s1">&#39;imports&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
                    <span class="n">scope</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="p">)</span>
        <span class="n">container</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_program_namespace</span><span class="o">.</span><span class="n">imports</span>
        <span class="n">container</span><span class="p">[</span><span class="s1">&#39;imports&#39;</span><span class="p">][</span><span class="n">mod_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Import</span><span class="p">(</span><span class="n">mod_name</span><span class="p">,</span> <span class="n">mod</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">program_body</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">init_func</span><span class="p">:</span>
                <span class="n">import_init</span>  <span class="o">=</span> <span class="n">FunctionCall</span><span class="p">(</span><span class="n">init_func</span><span class="p">,[],[])</span>
                <span class="n">program_body</span> <span class="o">=</span> <span class="p">[</span><span class="n">import_init</span><span class="p">,</span> <span class="o">*</span><span class="n">program_body</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">free_func</span><span class="p">:</span>
                <span class="n">import_free</span>  <span class="o">=</span> <span class="n">FunctionCall</span><span class="p">(</span><span class="n">free_func</span><span class="p">,[],[])</span>
                <span class="n">program_body</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">program_body</span><span class="p">,</span> <span class="n">import_free</span><span class="p">]</span>
            <span class="n">container</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_program_namespace</span>
            <span class="n">program</span> <span class="o">=</span> <span class="n">Program</span><span class="p">(</span><span class="n">prog_name</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">get_variables</span><span class="p">(</span><span class="n">container</span><span class="p">),</span>
                            <span class="n">program_body</span><span class="p">,</span>
                            <span class="n">container</span><span class="o">.</span><span class="n">imports</span><span class="p">[</span><span class="s1">&#39;imports&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
                            <span class="n">scope</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_program_namespace</span><span class="p">)</span>

            <span class="n">mod</span><span class="o">.</span><span class="n">program</span> <span class="o">=</span> <span class="n">program</span>

        <span class="k">return</span> <span class="n">mod</span></div>

<div class="viewcode-block" id="SemanticParser._visit_tuple"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_tuple">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">expr</span><span class="p">)</span></div>

<div class="viewcode-block" id="SemanticParser._visit_PythonTuple"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_PythonTuple">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_PythonTuple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">ls</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">expr</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">PythonTuple</span><span class="p">(</span><span class="o">*</span><span class="n">ls</span><span class="p">)</span></div>

<div class="viewcode-block" id="SemanticParser._visit_PythonList"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_PythonList">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_PythonList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">ls</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">expr</span><span class="p">]</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">PythonList</span><span class="p">(</span><span class="o">*</span><span class="n">ls</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span><span class="o">.</span><span class="n">is_homogeneous</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">PYCCEL_RESTRICTION_INHOMOG_LIST</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">expr</span><span class="p">,</span>
                <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">expr</span></div>

<div class="viewcode-block" id="SemanticParser._visit_FunctionCallArgument"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_FunctionCallArgument">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_FunctionCallArgument</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">FunctionCallArgument</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">expr</span><span class="o">.</span><span class="n">keyword</span><span class="p">)</span></div>

<div class="viewcode-block" id="SemanticParser._visit_FunctionDefArgument"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_FunctionDefArgument">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_FunctionDefArgument</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">var</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">var</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">FunctionDefArgument</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                <span class="n">annotation</span><span class="o">=</span><span class="n">expr</span><span class="o">.</span><span class="n">annotation</span><span class="p">,</span>
                <span class="n">kwonly</span><span class="o">=</span><span class="n">expr</span><span class="o">.</span><span class="n">is_kwonly</span><span class="p">)</span></div>

<div class="viewcode-block" id="SemanticParser._visit_CodeBlock"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_CodeBlock">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_CodeBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">ls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_additional_exprs</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>

            <span class="c1"># Save parsed code</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
            <span class="n">ls</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_additional_exprs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_additional_exprs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">CodeBlock</span><span class="p">):</span>
                <span class="n">ls</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_additional_exprs</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">CodeBlock</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span></div>

<div class="viewcode-block" id="SemanticParser._visit_Nil"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_Nil">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_Nil</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">expr</span><span class="o">.</span><span class="n">clear_user_nodes</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">expr</span></div>

<div class="viewcode-block" id="SemanticParser._visit_EmptyNode"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_EmptyNode">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_EmptyNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">expr</span><span class="o">.</span><span class="n">clear_user_nodes</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">expr</span></div>

<div class="viewcode-block" id="SemanticParser._visit_Break"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_Break">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_Break</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">expr</span><span class="o">.</span><span class="n">clear_user_nodes</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">expr</span></div>

<div class="viewcode-block" id="SemanticParser._visit_Continue"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_Continue">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_Continue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">expr</span><span class="o">.</span><span class="n">clear_user_nodes</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">expr</span></div>

<div class="viewcode-block" id="SemanticParser._visit_Comment"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_Comment">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_Comment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">expr</span><span class="o">.</span><span class="n">clear_user_nodes</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">expr</span></div>

<div class="viewcode-block" id="SemanticParser._visit_CommentBlock"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_CommentBlock">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_CommentBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">expr</span><span class="o">.</span><span class="n">clear_user_nodes</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">expr</span></div>

<div class="viewcode-block" id="SemanticParser._visit_AnnotatedComment"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_AnnotatedComment">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_AnnotatedComment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">expr</span><span class="o">.</span><span class="n">clear_user_nodes</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">expr</span></div>

<div class="viewcode-block" id="SemanticParser._visit_OmpAnnotatedComment"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_OmpAnnotatedComment">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_OmpAnnotatedComment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">_user_nodes</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">code</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
        <span class="n">combined_loop</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">combined</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;for&#39;</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">combined</span> <span class="ow">or</span> <span class="s1">&#39;distribute&#39;</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">combined</span> <span class="ow">or</span> <span class="s1">&#39;taskloop&#39;</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">combined</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">(</span><span class="n">OMP_Sections_Construct</span><span class="p">,</span> <span class="n">OMP_Single_Construct</span><span class="p">))</span> \
           <span class="ow">and</span> <span class="n">expr</span><span class="o">.</span><span class="n">has_nowait</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">code</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Omp_End_Clause</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">txt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">has_nowait</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">(</span><span class="n">OMP_For_Loop</span><span class="p">,</span> <span class="n">OMP_Simd_Construct</span><span class="p">,</span>
                    <span class="n">OMP_Distribute_Construct</span><span class="p">,</span> <span class="n">OMP_TaskLoop_Construct</span><span class="p">))</span> <span class="ow">or</span> <span class="n">combined_loop</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">body</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="p">(</span><span class="n">Comment</span><span class="p">,</span> <span class="n">CommentBlock</span><span class="p">,</span> <span class="n">Pass</span><span class="p">)):</span>
                <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">body</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">For</span><span class="p">):</span>
                <span class="n">end_expr</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;!$omp&#39;</span><span class="p">,</span> <span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="n">expr</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">combined</span><span class="p">:</span>
                    <span class="n">end_expr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">combined</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">has_nowait</span><span class="p">:</span>
                    <span class="n">end_expr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;nowait&#39;</span><span class="p">)</span>
                <span class="n">code</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">end_annotation</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">end_expr</span> <span class="k">if</span> <span class="n">e</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">type_name</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Statement after </span><span class="si">{</span><span class="n">type_name</span><span class="si">}</span><span class="s2"> must be a for loop.&quot;</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">expr</span><span class="p">,</span>
                    <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>

        <span class="n">expr</span><span class="o">.</span><span class="n">clear_user_nodes</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">expr</span></div>

<div class="viewcode-block" id="SemanticParser._visit_Omp_End_Clause"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_Omp_End_Clause">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_Omp_End_Clause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">end_loop</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">txt</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;for&#39;</span><span class="p">,</span> <span class="s1">&#39;distribute&#39;</span><span class="p">,</span> <span class="s1">&#39;taskloop&#39;</span><span class="p">,</span> <span class="s1">&#39;simd&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">end_loop</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;For loops do not require an end clause. This clause is ignored&quot;</span><span class="p">,</span>
                    <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;warning&#39;</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">expr</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">EmptyNode</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expr</span><span class="o">.</span><span class="n">clear_user_nodes</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">expr</span></div>

<div class="viewcode-block" id="SemanticParser._visit_Literal"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_Literal">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_Literal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">expr</span><span class="o">.</span><span class="n">clear_user_nodes</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">expr</span></div>
<div class="viewcode-block" id="SemanticParser._visit_PythonComplex"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_PythonComplex">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_PythonComplex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">expr</span><span class="o">.</span><span class="n">clear_user_nodes</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">expr</span></div>
<div class="viewcode-block" id="SemanticParser._visit_Pass"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_Pass">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_Pass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">expr</span><span class="o">.</span><span class="n">clear_user_nodes</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">expr</span></div>

<div class="viewcode-block" id="SemanticParser._visit_Variable"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_Variable">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_Variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_python_name</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="SemanticParser._visit_str"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_str">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_str</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span></div>

<div class="viewcode-block" id="SemanticParser._visit_Slice"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_Slice">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_Slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span> <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">step</span><span class="p">)</span> <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">Slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span></div>

<div class="viewcode-block" id="SemanticParser._visit_IndexedElement"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_IndexedElement">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_IndexedElement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">base</span><span class="p">)</span>
        <span class="c1"># TODO check consistency of indices with shape/rank</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">indices</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">TupleVariable</span><span class="p">,</span> <span class="n">PythonTuple</span><span class="p">))):</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="p">(</span><span class="n">TupleVariable</span><span class="p">,</span> <span class="n">PythonTuple</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">):</span>
            <span class="n">n_exprs</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">n_exprs</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="n">n_exprs</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">n_exprs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="n">new_expr_args</span> <span class="o">=</span> <span class="p">[[</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;__getitem__&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
                             <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_exprs</span><span class="p">)]</span>
            <span class="k">return</span> <span class="n">NumpyArray</span><span class="p">(</span><span class="n">PythonTuple</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">var</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">new_expr_args</span><span class="p">]))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_indexed_from_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">expr</span><span class="p">)</span></div>

<div class="viewcode-block" id="SemanticParser._visit_PyccelSymbol"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_PyccelSymbol">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_PyccelSymbol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">expr</span>

        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_for_variable</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;functions&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;symbolic_functions&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">python_builtin_datatype</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">UNDERSCORE_NOT_A_THROWAWAY</span><span class="p">,</span>
                    <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                    <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">UNDEFINED_VARIABLE</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                    <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">var</span></div>


<div class="viewcode-block" id="SemanticParser._visit_DottedName"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_DottedName">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_DottedName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>

        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_for_variable</span><span class="p">(</span><span class="n">_get_name</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">var</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">var</span>

        <span class="n">lhs</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> \
                <span class="k">else</span> <span class="n">DottedName</span><span class="p">(</span><span class="o">*</span><span class="n">expr</span><span class="o">.</span><span class="n">name</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">rhs</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">visited_lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">lhs</span><span class="p">)</span>
        <span class="n">first</span> <span class="o">=</span> <span class="n">visited_lhs</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">visited_lhs</span><span class="p">,</span> <span class="n">FunctionCall</span><span class="p">):</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">visited_lhs</span><span class="o">.</span><span class="n">funcdef</span><span class="o">.</span><span class="n">results</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;Cannot get attribute of function call with multiple returns&quot;</span><span class="p">,</span>
                        <span class="n">symbol</span><span class="o">=</span><span class="n">expr</span><span class="p">,</span>
                        <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                        <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>
            <span class="n">first</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">rhs_name</span> <span class="o">=</span> <span class="n">_get_name</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span>
        <span class="n">attr_name</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Handle case of imported module</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">Module</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">rhs_name</span> <span class="ow">in</span> <span class="n">first</span><span class="p">:</span>
                <span class="n">imp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">_get_name</span><span class="p">(</span><span class="n">lhs</span><span class="p">),</span> <span class="s1">&#39;imports&#39;</span><span class="p">)</span>

                <span class="n">new_name</span> <span class="o">=</span> <span class="n">rhs_name</span>
                <span class="k">if</span> <span class="n">imp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">new_name</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">find_module_target</span><span class="p">(</span><span class="n">rhs_name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">new_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">new_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_new_name</span><span class="p">(</span><span class="n">rhs_name</span><span class="p">)</span>

                        <span class="c1"># Save the import target that has been used</span>
                        <span class="n">imp</span><span class="o">.</span><span class="n">define_target</span><span class="p">(</span><span class="n">AsName</span><span class="p">(</span><span class="n">first</span><span class="p">[</span><span class="n">rhs_name</span><span class="p">],</span> <span class="n">PyccelSymbol</span><span class="p">(</span><span class="n">new_name</span><span class="p">)))</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">FunctionCall</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">imports</span><span class="p">[</span><span class="s1">&#39;functions&#39;</span><span class="p">][</span><span class="n">new_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">first</span><span class="p">[</span><span class="n">rhs_name</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">ConstructorCall</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">imports</span><span class="p">[</span><span class="s1">&#39;classes&#39;</span><span class="p">][</span><span class="n">new_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">first</span><span class="p">[</span><span class="n">rhs_name</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">Variable</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">imports</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">][</span><span class="n">new_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">rhs</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">FunctionCall</span><span class="p">):</span>
                    <span class="c1"># If object is a function</span>
                    <span class="n">args</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_function_args</span><span class="p">(</span><span class="n">rhs</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
                    <span class="n">func</span>  <span class="o">=</span> <span class="n">first</span><span class="p">[</span><span class="n">rhs_name</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">new_name</span> <span class="o">!=</span> <span class="n">rhs_name</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s1">&#39;clone&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">PyccelFunctionDef</span><span class="p">):</span>
                            <span class="n">func</span>  <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">new_name</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_function</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">Constant</span><span class="p">):</span>
                    <span class="n">var</span> <span class="o">=</span> <span class="n">first</span><span class="p">[</span><span class="n">rhs_name</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">new_name</span> <span class="o">!=</span> <span class="n">rhs_name</span><span class="p">:</span>
                        <span class="n">var</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">new_name</span>
                    <span class="k">return</span> <span class="n">var</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If object is something else (eg. dict)</span>
                    <span class="n">var</span> <span class="o">=</span> <span class="n">first</span><span class="p">[</span><span class="n">rhs_name</span><span class="p">]</span>
                    <span class="k">return</span> <span class="n">var</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">UNDEFINED_IMPORT_OBJECT</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rhs_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">lhs</span><span class="p">)),</span>
                        <span class="n">symbol</span><span class="o">=</span><span class="n">expr</span><span class="p">,</span>
                        <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                        <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>

        <span class="n">d_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infere_type</span><span class="p">(</span><span class="n">first</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d_var</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cls_base&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Attribute </span><span class="si">{</span><span class="n">rhs_name</span><span class="si">}</span><span class="s1"> not found&#39;</span><span class="p">,</span>
                <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>

        <span class="n">cls_base</span> <span class="o">=</span> <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;cls_base&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">cls_base</span><span class="p">:</span>
            <span class="n">attr_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cls_base</span><span class="o">.</span><span class="n">attributes</span><span class="p">]</span>

        <span class="c1"># look for a class method</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">FunctionCall</span><span class="p">):</span>
            <span class="n">methods</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cls_base</span><span class="o">.</span><span class="n">methods</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">cls_base</span><span class="o">.</span><span class="n">interfaces</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">Interface</span><span class="p">):</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s1">&#39;Generic methods are not supported yet&#39;</span><span class="p">,</span>
                        <span class="n">symbol</span><span class="o">=</span><span class="n">method</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                        <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>
            <span class="n">macro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">rhs_name</span><span class="p">,</span> <span class="s1">&#39;macros&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">macro</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">master</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">master</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">args</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">lhs</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">FunctionCall</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_function</span><span class="p">)</span>

            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span>
                    <span class="n">rhs</span><span class="o">.</span><span class="n">args</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="n">rhs_name</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;numpy_wrapper&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">decorators</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">func</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">decorators</span><span class="p">[</span><span class="s1">&#39;numpy_wrapper&#39;</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">insert_import</span><span class="p">(</span><span class="s1">&#39;numpy&#39;</span><span class="p">,</span> <span class="n">AsName</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">rhs_name</span><span class="p">))</span>
                        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">visited_lhs</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">DottedFunctionCall</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">=</span> <span class="n">visited_lhs</span><span class="p">,</span>
                                    <span class="n">current_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_function</span><span class="p">)</span>

        <span class="c1"># look for a class attribute / property</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">PyccelSymbol</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cls_base</span><span class="p">:</span>
            <span class="n">methods</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cls_base</span><span class="o">.</span><span class="n">methods</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">cls_base</span><span class="o">.</span><span class="n">interfaces</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">Interface</span><span class="p">):</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s1">&#39;Generic methods are not supported yet&#39;</span><span class="p">,</span>
                        <span class="n">symbol</span><span class="o">=</span><span class="n">method</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                        <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>
            <span class="c1"># standard class attribute</span>
            <span class="k">if</span> <span class="n">rhs</span> <span class="ow">in</span> <span class="n">attr_name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_current_class</span> <span class="o">=</span> <span class="n">cls_base</span>
                <span class="n">second</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_current_class</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">return</span> <span class="n">second</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">second</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">new_class</span> <span class="o">=</span> <span class="n">DottedVariable</span><span class="p">,</span> <span class="n">lhs</span> <span class="o">=</span> <span class="n">visited_lhs</span><span class="p">)</span>

            <span class="c1"># class property?</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">rhs</span> <span class="ow">and</span> \
                            <span class="s1">&#39;property&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">decorators</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">if</span> <span class="s1">&#39;numpy_wrapper&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">decorators</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">func</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">decorators</span><span class="p">[</span><span class="s1">&#39;numpy_wrapper&#39;</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">insert_import</span><span class="p">(</span><span class="s1">&#39;numpy&#39;</span><span class="p">,</span> <span class="n">AsName</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">rhs</span><span class="p">))</span>
                            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">visited_lhs</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">DottedFunctionCall</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">[],</span> <span class="n">prefix</span> <span class="o">=</span> <span class="n">visited_lhs</span><span class="p">,</span>
                                    <span class="n">current_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_function</span><span class="p">)</span>

        <span class="c1"># look for a macro</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="n">macro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">rhs_name</span><span class="p">,</span> <span class="s1">&#39;macros&#39;</span><span class="p">)</span>

            <span class="c1"># Macro</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">macro</span><span class="p">,</span> <span class="n">MacroVariable</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">macro</span><span class="o">.</span><span class="n">master</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">macro</span><span class="p">,</span> <span class="n">MacroFunction</span><span class="p">):</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">apply</span><span class="p">([</span><span class="n">visited_lhs</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">FunctionCall</span><span class="p">(</span><span class="n">macro</span><span class="o">.</span><span class="n">master</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_function</span><span class="p">)</span>

        <span class="c1"># did something go wrong?</span>
        <span class="k">return</span> <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Attribute </span><span class="si">{</span><span class="n">rhs_name</span><span class="si">}</span><span class="s1"> not found&#39;</span><span class="p">,</span>
            <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
            <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SemanticParser._visit_PyccelOperator"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_PyccelOperator">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_PyccelOperator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">args</span>     <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_PyccelOperator</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span></div>

<div class="viewcode-block" id="SemanticParser._visit_PyccelAdd"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_PyccelAdd">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_PyccelAdd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">TupleVariable</span><span class="p">,</span> <span class="n">PythonTuple</span><span class="p">,</span> <span class="n">Concatenate</span><span class="p">,</span> <span class="n">Duplicate</span><span class="p">)):</span>
            <span class="n">is_homogeneous</span> <span class="o">=</span> <span class="nb">all</span><span class="p">((</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="p">(</span><span class="n">TupleVariable</span><span class="p">,</span> <span class="n">PythonTuple</span><span class="p">))</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">is_homogeneous</span><span class="p">)</span> \
                                <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="p">(</span><span class="n">Concatenate</span><span class="p">,</span> <span class="n">Duplicate</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_homogeneous</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Concatenate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">get_vars</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">InhomogeneousTupleVariable</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">get_vars</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">PythonTuple</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">args</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">HomogeneousTupleVariable</span><span class="p">):</span>
                        <span class="n">n_vars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="p">(</span><span class="n">LiteralInteger</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
                            <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;Can&#39;t create an inhomogeneous tuple using a homogeneous tuple of unknown size&quot;</span><span class="p">,</span>
                                    <span class="n">symbol</span><span class="o">=</span><span class="n">expr</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_vars</span><span class="p">)]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">a_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected type </span><span class="si">{</span><span class="n">a_type</span><span class="si">}</span><span class="s2"> in tuple addition&quot;</span><span class="p">)</span>
                <span class="n">tuple_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">ai</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">for</span> <span class="n">ai</span> <span class="ow">in</span> <span class="n">get_vars</span><span class="p">(</span><span class="n">a</span><span class="p">)]</span>
                <span class="n">expr_new</span> <span class="o">=</span> <span class="n">PythonTuple</span><span class="p">(</span><span class="o">*</span><span class="n">tuple_args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expr_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_PyccelOperator</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">expr_new</span></div>

<div class="viewcode-block" id="SemanticParser._visit_PyccelMul"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_PyccelMul">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_PyccelMul</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">TupleVariable</span><span class="p">,</span> <span class="n">PythonTuple</span><span class="p">,</span> <span class="n">PythonList</span><span class="p">)):</span>
            <span class="n">expr_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_Duplicate</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">TupleVariable</span><span class="p">,</span> <span class="n">PythonTuple</span><span class="p">,</span> <span class="n">PythonList</span><span class="p">)):</span>
            <span class="n">expr_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_Duplicate</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expr_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_PyccelOperator</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">expr_new</span></div>

<div class="viewcode-block" id="SemanticParser._visit_PyccelPow"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_PyccelPow">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_PyccelPow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">base</span><span class="p">,</span> <span class="n">exponent</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">]</span>

        <span class="n">exp_val</span> <span class="o">=</span> <span class="n">exponent</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exponent</span><span class="p">,</span> <span class="n">LiteralInteger</span><span class="p">):</span>
            <span class="n">exp_val</span> <span class="o">=</span> <span class="n">exponent</span><span class="o">.</span><span class="n">python_value</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exponent</span><span class="p">,</span> <span class="n">PyccelAssociativeParenthesis</span><span class="p">):</span>
            <span class="n">exp</span> <span class="o">=</span> <span class="n">exponent</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># Handle (1/2)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">PyccelDiv</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">Literal</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">exp</span><span class="o">.</span><span class="n">args</span><span class="p">):</span>
                <span class="n">exp_val</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">python_value</span> <span class="o">/</span> <span class="n">exp</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">python_value</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="p">(</span><span class="n">Literal</span><span class="p">,</span> <span class="n">Variable</span><span class="p">))</span> <span class="ow">and</span> <span class="n">exp_val</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PyccelMul</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">exp_val</span> <span class="o">==</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">pyccel_stage</span><span class="o">.</span><span class="n">set_stage</span><span class="p">(</span><span class="s1">&#39;syntactic&#39;</span><span class="p">)</span>

            <span class="n">sqrt_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_new_name</span><span class="p">(</span><span class="s1">&#39;sqrt&#39;</span><span class="p">)</span>
            <span class="n">imp_name</span> <span class="o">=</span> <span class="n">AsName</span><span class="p">(</span><span class="s1">&#39;sqrt&#39;</span><span class="p">,</span> <span class="n">sqrt_name</span><span class="p">)</span>
            <span class="n">new_import</span> <span class="o">=</span> <span class="n">Import</span><span class="p">(</span><span class="s1">&#39;math&#39;</span><span class="p">,</span><span class="n">imp_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">new_import</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">PyccelAssociativeParenthesis</span><span class="p">):</span>
                <span class="n">new_call</span> <span class="o">=</span> <span class="n">FunctionCall</span><span class="p">(</span><span class="n">sqrt_name</span><span class="p">,</span> <span class="p">[</span><span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_call</span> <span class="o">=</span> <span class="n">FunctionCall</span><span class="p">(</span><span class="n">sqrt_name</span><span class="p">,</span> <span class="p">[</span><span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

            <span class="n">pyccel_stage</span><span class="o">.</span><span class="n">set_stage</span><span class="p">(</span><span class="s1">&#39;semantic&#39;</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">new_call</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PyccelPow</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">exponent</span><span class="p">)</span></div>

<div class="viewcode-block" id="SemanticParser._visit_MathSqrt"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_MathSqrt">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_MathSqrt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">funcdef</span><span class="p">,</span> <span class="s1">&#39;functions&#39;</span><span class="p">)</span>
        <span class="n">arg</span><span class="p">,</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_function_args</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span> <span class="c1">#pylint: disable=unbalanced-tuple-unpacking</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">PyccelMul</span><span class="p">):</span>
            <span class="n">mul1</span><span class="p">,</span> <span class="n">mul2</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">args</span>
            <span class="n">mul1_syn</span><span class="p">,</span> <span class="n">mul2_syn</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">args</span>
            <span class="n">is_abs</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">mul1</span> <span class="ow">is</span> <span class="n">mul2</span> <span class="ow">and</span> <span class="n">mul1</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">NativeInteger</span><span class="p">(),</span> <span class="n">NativeFloat</span><span class="p">()):</span>
                <span class="n">pyccel_stage</span><span class="o">.</span><span class="n">set_stage</span><span class="p">(</span><span class="s1">&#39;syntactic&#39;</span><span class="p">)</span>

                <span class="n">fabs_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_new_name</span><span class="p">(</span><span class="s1">&#39;fabs&#39;</span><span class="p">)</span>
                <span class="n">imp_name</span> <span class="o">=</span> <span class="n">AsName</span><span class="p">(</span><span class="s1">&#39;fabs&#39;</span><span class="p">,</span> <span class="n">fabs_name</span><span class="p">)</span>
                <span class="n">new_import</span> <span class="o">=</span> <span class="n">Import</span><span class="p">(</span><span class="s1">&#39;math&#39;</span><span class="p">,</span><span class="n">imp_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">new_import</span><span class="p">)</span>
                <span class="n">new_call</span> <span class="o">=</span> <span class="n">FunctionCall</span><span class="p">(</span><span class="n">fabs_name</span><span class="p">,</span> <span class="p">[</span><span class="n">mul1_syn</span><span class="p">])</span>

                <span class="n">pyccel_stage</span><span class="o">.</span><span class="n">set_stage</span><span class="p">(</span><span class="s1">&#39;semantic&#39;</span><span class="p">)</span>

                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">new_call</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mul1</span><span class="p">,</span> <span class="p">(</span><span class="n">NumpyConjugate</span><span class="p">,</span> <span class="n">PythonConjugate</span><span class="p">))</span> <span class="ow">and</span> <span class="n">mul1</span><span class="o">.</span><span class="n">internal_var</span> <span class="ow">is</span> <span class="n">mul2</span><span class="p">:</span>
                <span class="n">is_abs</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">abs_arg</span> <span class="o">=</span> <span class="n">mul2_syn</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mul2</span><span class="p">,</span> <span class="p">(</span><span class="n">NumpyConjugate</span><span class="p">,</span> <span class="n">PythonConjugate</span><span class="p">))</span> <span class="ow">and</span> <span class="n">mul1</span> <span class="ow">is</span> <span class="n">mul2</span><span class="o">.</span><span class="n">internal_var</span><span class="p">:</span>
                <span class="n">is_abs</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">abs_arg</span> <span class="o">=</span> <span class="n">mul1_syn</span>

            <span class="k">if</span> <span class="n">is_abs</span><span class="p">:</span>
                <span class="n">pyccel_stage</span><span class="o">.</span><span class="n">set_stage</span><span class="p">(</span><span class="s1">&#39;syntactic&#39;</span><span class="p">)</span>

                <span class="n">abs_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_new_name</span><span class="p">(</span><span class="s1">&#39;abs&#39;</span><span class="p">)</span>
                <span class="n">imp_name</span> <span class="o">=</span> <span class="n">AsName</span><span class="p">(</span><span class="s1">&#39;abs&#39;</span><span class="p">,</span> <span class="n">abs_name</span><span class="p">)</span>
                <span class="n">new_import</span> <span class="o">=</span> <span class="n">Import</span><span class="p">(</span><span class="s1">&#39;numpy&#39;</span><span class="p">,</span><span class="n">imp_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">new_import</span><span class="p">)</span>
                <span class="n">new_call</span> <span class="o">=</span> <span class="n">FunctionCall</span><span class="p">(</span><span class="n">abs_name</span><span class="p">,</span> <span class="p">[</span><span class="n">abs_arg</span><span class="p">])</span>

                <span class="n">pyccel_stage</span><span class="o">.</span><span class="n">set_stage</span><span class="p">(</span><span class="s1">&#39;semantic&#39;</span><span class="p">)</span>

                <span class="c1"># Cast to preserve final dtype</span>
                <span class="k">return</span> <span class="n">PythonComplex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">new_call</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">PyccelPow</span><span class="p">):</span>
            <span class="n">base</span><span class="p">,</span> <span class="n">exponent</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">args</span>
            <span class="n">base_syn</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">args</span>
            <span class="k">if</span> <span class="n">exponent</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">base</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">NativeInteger</span><span class="p">(),</span> <span class="n">NativeFloat</span><span class="p">()):</span>
                <span class="n">pyccel_stage</span><span class="o">.</span><span class="n">set_stage</span><span class="p">(</span><span class="s1">&#39;syntactic&#39;</span><span class="p">)</span>

                <span class="n">fabs_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_new_name</span><span class="p">(</span><span class="s1">&#39;fabs&#39;</span><span class="p">)</span>
                <span class="n">imp_name</span> <span class="o">=</span> <span class="n">AsName</span><span class="p">(</span><span class="s1">&#39;fabs&#39;</span><span class="p">,</span> <span class="n">fabs_name</span><span class="p">)</span>
                <span class="n">new_import</span> <span class="o">=</span> <span class="n">Import</span><span class="p">(</span><span class="s1">&#39;math&#39;</span><span class="p">,</span><span class="n">imp_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">new_import</span><span class="p">)</span>
                <span class="n">new_call</span> <span class="o">=</span> <span class="n">FunctionCall</span><span class="p">(</span><span class="n">fabs_name</span><span class="p">,</span> <span class="p">[</span><span class="n">base_syn</span><span class="p">])</span>

                <span class="n">pyccel_stage</span><span class="o">.</span><span class="n">set_stage</span><span class="p">(</span><span class="s1">&#39;semantic&#39;</span><span class="p">)</span>

                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">new_call</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_function</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="p">(</span><span class="n">arg</span><span class="p">,),</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span></div>

<div class="viewcode-block" id="SemanticParser._visit_Lambda"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_Lambda">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_Lambda</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">expr_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">get_attribute_nodes</span><span class="p">(</span><span class="n">PyccelSymbol</span><span class="p">))</span>
        <span class="n">var_names</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">expr</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span>
        <span class="n">missing_vars</span> <span class="o">=</span> <span class="n">expr_names</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">var_names</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_vars</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">UNDEFINED_LAMBDA_VARIABLE</span><span class="p">,</span> <span class="n">symbol</span> <span class="o">=</span> <span class="n">missing_vars</span><span class="p">,</span>
                <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>
        <span class="n">funcs</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">get_attribute_nodes</span><span class="p">(</span><span class="n">FunctionCall</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">_get_name</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;symbolic_functions&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">UNDEFINED_LAMBDA_FUNCTION</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                    <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                <span class="n">expr_new</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                <span class="n">expr</span> <span class="o">=</span> <span class="n">Lambda</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">variables</span><span class="p">),</span> <span class="n">expr_new</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">expr</span></div>

<div class="viewcode-block" id="SemanticParser._visit_FunctionCall"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_FunctionCall">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_FunctionCall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">name</span>     <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">funcdef</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_expected_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">func</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;functions&#39;</span><span class="p">)</span>

        <span class="c1"># Check for specialised method</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">PyccelFunctionDef</span><span class="p">):</span>
            <span class="n">annotation_method</span> <span class="o">=</span> <span class="s1">&#39;_visit_&#39;</span> <span class="o">+</span> <span class="n">func</span><span class="o">.</span><span class="n">cls_name</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">annotation_method</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">annotation_method</span><span class="p">)(</span><span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>

        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_function_args</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
        <span class="c1"># Correct keyword names if scope is available</span>
        <span class="c1"># The scope is only available if the function body has been parsed</span>
        <span class="c1"># (i.e. not for headers or builtin functions)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">FunctionDef</span><span class="p">)</span> <span class="ow">and</span> <span class="n">func</span><span class="o">.</span><span class="n">scope</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">keyword</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> \
                    <span class="n">FunctionCallArgument</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_expected_name</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">keyword</span><span class="p">))</span> \
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>


        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;lambdify&#39;</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s1">&#39;symbolic_functions&#39;</span><span class="p">)</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">pyccel_builtin_function</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">F</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">F</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;cls_constructs&#39;</span><span class="p">):</span>

            <span class="c1"># TODO improve the test</span>
            <span class="c1"># we must not invoke the scope like this</span>

            <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;classes&#39;</span><span class="p">)</span>
            <span class="n">d_methods</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">methods_as_dict</span>
            <span class="n">method</span> <span class="o">=</span> <span class="n">d_methods</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;__init__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

                <span class="c1"># TODO improve case of class with the no __init__</span>

                <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">UNDEFINED_INIT_METHOD</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">args</span>

            <span class="c1"># TODO check compatibility</span>
            <span class="c1"># TODO treat parametrized arguments.</span>

            <span class="n">expr</span> <span class="o">=</span> <span class="n">ConstructorCall</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">cls_variable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="c1">#if len(stmts) &gt; 0:</span>
            <span class="c1">#    stmts.append(expr)</span>
            <span class="c1">#    return CodeBlock(stmts)</span>
            <span class="k">return</span> <span class="n">expr</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># first we check if it is a macro, in this case, we will create</span>
            <span class="c1"># an appropriate FunctionCall</span>

            <span class="n">macro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;macros&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">macro</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">func</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">funcdef</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">_get_name</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;functions&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">UNDEFINED_FUNCTION</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                        <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_function</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span></div>

<div class="viewcode-block" id="SemanticParser._visit_Expr"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_Expr">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_Expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">PYCCEL_RESTRICTION_TODO</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">expr</span><span class="p">,</span>
            <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
            <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="SemanticParser._visit_Assign"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_Assign">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_Assign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="c1"># TODO unset position at the end of this part</span>
        <span class="n">new_expressions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fst</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">fst</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">fst</span><span class="p">)</span>

        <span class="n">rhs</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">rhs</span>
        <span class="n">lhs</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">lhs</span>

        <span class="c1"># Steps before visiting</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">GeneratorComprehension</span><span class="p">):</span>
            <span class="n">rhs</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">rhs</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span> <span class="n">lhs</span><span class="p">)</span>
            <span class="n">genexp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_GeneratorComprehension</span><span class="p">(</span><span class="n">_get_name</span><span class="p">(</span><span class="n">lhs</span><span class="p">),</span> <span class="n">rhs</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">AugAssign</span><span class="p">):</span>
                <span class="n">new_expressions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">genexp</span><span class="p">)</span>
                <span class="n">rhs</span> <span class="o">=</span> <span class="n">genexp</span><span class="o">.</span><span class="n">lhs</span>
            <span class="k">elif</span> <span class="n">genexp</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">lhs</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">genexp</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_expressions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">genexp</span><span class="p">)</span>
                <span class="n">rhs</span> <span class="o">=</span> <span class="n">genexp</span><span class="o">.</span><span class="n">lhs</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">IfTernaryOperator</span><span class="p">):</span>
            <span class="n">value_true</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">rhs</span><span class="o">.</span><span class="n">value_true</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value_true</span><span class="o">.</span><span class="n">rank</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">value_true</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">is</span> <span class="n">NativeString</span><span class="p">():</span>
                <span class="c1"># Temporarily deactivate type checks to construct syntactic assigns</span>
                <span class="n">pyccel_stage</span><span class="o">.</span><span class="n">set_stage</span><span class="p">(</span><span class="s1">&#39;syntactic&#39;</span><span class="p">)</span>
                <span class="n">assign_true</span>  <span class="o">=</span> <span class="n">Assign</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="o">.</span><span class="n">value_true</span><span class="p">,</span> <span class="n">fst</span> <span class="o">=</span> <span class="n">fst</span><span class="p">)</span>
                <span class="n">assign_false</span> <span class="o">=</span> <span class="n">Assign</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="o">.</span><span class="n">value_false</span><span class="p">,</span> <span class="n">fst</span> <span class="o">=</span> <span class="n">fst</span><span class="p">)</span>
                <span class="n">pyccel_stage</span><span class="o">.</span><span class="n">set_stage</span><span class="p">(</span><span class="s1">&#39;semantic&#39;</span><span class="p">)</span>

                <span class="n">cond</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">rhs</span><span class="o">.</span><span class="n">cond</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
                <span class="n">true_section</span>  <span class="o">=</span> <span class="n">IfSection</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">assign_true</span><span class="p">)])</span>
                <span class="n">false_section</span> <span class="o">=</span> <span class="n">IfSection</span><span class="p">(</span><span class="n">LiteralTrue</span><span class="p">(),</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">assign_false</span><span class="p">)])</span>
                <span class="k">return</span> <span class="n">If</span><span class="p">(</span><span class="n">true_section</span><span class="p">,</span> <span class="n">false_section</span><span class="p">)</span>

        <span class="c1"># Visit object</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">FunctionCall</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">funcdef</span>
            <span class="n">macro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;macros&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">macro</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">rhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="c1"># TODO check types from FunctionDef</span>
                <span class="n">master</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">master</span>
                <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rhs</span><span class="o">.</span><span class="n">args</span><span class="p">]</span>
                <span class="n">args_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">arg</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)]</span>
                <span class="n">d_m_args</span> <span class="o">=</span> <span class="p">{</span><span class="n">arg</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">name</span><span class="p">:</span><span class="n">arg</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">macro</span><span class="o">.</span><span class="n">master_arguments</span>
                                  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)}</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">sympy_iterable</span><span class="p">(</span><span class="n">lhs</span><span class="p">):</span>
                    <span class="n">lhs</span> <span class="o">=</span> <span class="p">[</span><span class="n">lhs</span><span class="p">]</span>
                <span class="n">results_shapes</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">get_results_shapes</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">m_result</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">macro</span><span class="o">.</span><span class="n">results</span><span class="p">,</span> <span class="n">results_shapes</span><span class="p">,</span> <span class="n">lhs</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">m_result</span> <span class="ow">in</span> <span class="n">d_m_args</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">args_names</span><span class="p">:</span>
                        <span class="n">d_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infere_type</span><span class="p">(</span><span class="n">d_m_args</span><span class="p">[</span><span class="n">m_result</span><span class="p">])</span>
                        <span class="n">d_result</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shape</span>
                        <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_lhs_variable</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">d_result</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">new_expressions</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">args_names</span><span class="p">:</span>
                        <span class="n">_name</span> <span class="o">=</span> <span class="n">_get_name</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                        <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">_name</span><span class="p">)</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># TODO: check for result in master_results</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">INVALID_MACRO_COMPOSITION</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">result</span><span class="p">,</span>
                        <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                        <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>

                <span class="n">expr</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">make_necessary_copies</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
                <span class="n">new_expressions</span> <span class="o">+=</span> <span class="n">expr</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">results</span><span class="o">=</span><span class="n">results</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">master</span><span class="o">.</span><span class="n">funcdef</span><span class="p">,</span> <span class="n">FunctionDef</span><span class="p">):</span>
                    <span class="n">func_call</span> <span class="o">=</span> <span class="n">FunctionCall</span><span class="p">(</span><span class="n">master</span><span class="o">.</span><span class="n">funcdef</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_function</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">new_expressions</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">CodeBlock</span><span class="p">([</span><span class="o">*</span><span class="n">new_expressions</span><span class="p">,</span> <span class="n">func_call</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">func_call</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># TODO treate interface case</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">PYCCEL_RESTRICTION_TODO</span><span class="p">,</span>
                                  <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                                  <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">DottedVariable</span><span class="p">):</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">rhs</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">_get_name</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
            <span class="n">macro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;macros&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">macro</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">rhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">master</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">master</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">macro</span><span class="p">,</span> <span class="n">MacroVariable</span><span class="p">):</span>
                    <span class="n">rhs</span> <span class="o">=</span> <span class="n">master</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If macro is function, create left-hand side variable</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">FunctionDef</span><span class="p">)</span> <span class="ow">and</span> <span class="n">master</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
                        <span class="n">d_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infere_type</span><span class="p">(</span><span class="n">master</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
                        <span class="n">dtype</span> <span class="o">=</span> <span class="n">d_var</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;datatype&#39;</span><span class="p">)</span>
                        <span class="n">lhs</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">lhs</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">d_var</span><span class="p">,</span> <span class="n">is_temp</span><span class="o">=</span><span class="n">lhs</span><span class="o">.</span><span class="n">is_temp</span><span class="p">)</span>
                        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_for_variable</span><span class="p">(</span><span class="n">lhs</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">insert_variable</span><span class="p">(</span><span class="n">lhs</span><span class="p">)</span>

                    <span class="n">name</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">name</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">sympy_iterable</span><span class="p">(</span><span class="n">lhs</span><span class="p">):</span>
                        <span class="n">lhs</span> <span class="o">=</span> <span class="p">[</span><span class="n">lhs</span><span class="p">]</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">lhs</span><span class="p">:</span>
                        <span class="n">_name</span> <span class="o">=</span> <span class="n">_get_name</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">_name</span><span class="p">)</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

                    <span class="n">args</span> <span class="o">=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">rhs</span><span class="o">.</span><span class="n">args</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">rhs</span><span class="o">.</span><span class="n">lhs</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>

                    <span class="n">args</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">results</span><span class="o">=</span><span class="n">results</span><span class="p">)</span>

                    <span class="c1"># Distinguish between function</span>
                    <span class="k">if</span> <span class="n">master</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">Assign</span><span class="p">(</span><span class="n">lhs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">FunctionCall</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_function</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">FunctionCall</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_function</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">rhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">FunctionDef</span><span class="p">):</span>

            <span class="c1"># case of lambdify</span>

            <span class="n">rhs</span> <span class="o">=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rhs</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
                <span class="n">i</span><span class="o">.</span><span class="n">set_fst</span><span class="p">(</span><span class="n">fst</span><span class="p">)</span>
            <span class="n">rhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit_FunctionDef</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">rhs</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">CodeBlock</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rhs</span><span class="o">.</span><span class="n">body</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">FunctionalFor</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">rhs</span>

            <span class="c1"># case of complex stmt</span>
            <span class="c1"># that needs to be splitted</span>
            <span class="c1"># into a list of stmts</span>
            <span class="n">stmts</span> <span class="o">=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">body</span>
            <span class="n">stmt</span>  <span class="o">=</span> <span class="n">stmts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">lhs</span>   <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">lhs</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">PyccelSymbol</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">lhs</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_for_variable</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">d_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infere_type</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
                    <span class="n">dtype</span> <span class="o">=</span> <span class="n">d_var</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;datatype&#39;</span><span class="p">)</span>
                    <span class="n">lhs</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">name</span> <span class="p">,</span> <span class="o">**</span><span class="n">d_var</span><span class="p">,</span> <span class="n">is_temp</span> <span class="o">=</span> <span class="n">lhs</span><span class="o">.</span><span class="n">is_temp</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">insert_variable</span><span class="p">(</span><span class="n">lhs</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Assign</span><span class="p">):</span>
                <span class="n">stmt</span> <span class="o">=</span> <span class="n">Assign</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">stmt</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">AugAssign</span><span class="p">):</span>
                <span class="n">stmt</span> <span class="o">=</span> <span class="n">AugAssign</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">expr</span><span class="o">.</span><span class="n">op</span><span class="p">,</span> <span class="n">stmt</span><span class="p">)</span>
            <span class="n">stmt</span><span class="o">.</span><span class="n">set_fst</span><span class="p">(</span><span class="n">fst</span><span class="p">)</span>
            <span class="n">stmts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">stmt</span>
            <span class="k">return</span> <span class="n">CodeBlock</span><span class="p">(</span><span class="n">stmts</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">FunctionCall</span><span class="p">):</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">funcdef</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">FunctionDef</span><span class="p">):</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">results</span>
                <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">d_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infere_type</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">d_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infere_type</span><span class="p">(</span><span class="n">PythonTuple</span><span class="p">(</span><span class="o">*</span><span class="n">results</span><span class="p">),</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">expr</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">is_temp</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">rhs</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Cannot assign result of a function without a return&quot;</span><span class="p">)</span>

                <span class="c1"># case of elemental function</span>
                <span class="c1"># if the input and args of func do not have the same shape,</span>
                <span class="c1"># then the lhs must be already declared</span>
                <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="n">is_elemental</span><span class="p">:</span>
                    <span class="c1"># we first compare the funcdef args with the func call</span>
                    <span class="c1"># args</span>
<span class="c1">#                   d_var = None</span>
                    <span class="n">func_args</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">arguments</span>
                    <span class="n">call_args</span> <span class="o">=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">args</span>
                    <span class="n">f_ranks</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">rank</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">func_args</span><span class="p">]</span>
                    <span class="n">c_ranks</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">rank</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">call_args</span><span class="p">]</span>
                    <span class="n">same_ranks</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">==</span><span class="n">y</span> <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">f_ranks</span><span class="p">,</span> <span class="n">c_ranks</span><span class="p">)]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">same_ranks</span><span class="p">):</span>
                        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c_ranks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">arg</span> <span class="o">=</span> <span class="n">call_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
                        <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span>          <span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">shape</span>
                        <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span>           <span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">rank</span>
                        <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;memory_handling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">memory_handling</span>
                        <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;order&#39;</span>          <span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">order</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">Interface</span><span class="p">):</span>
                <span class="n">d_var</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_infere_type</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>
                         <span class="n">func</span><span class="o">.</span><span class="n">functions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">results</span><span class="p">]</span>

                <span class="c1"># TODO imporve this will not work for</span>
                <span class="c1"># the case of different results types</span>
                <span class="n">d_var</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">dtype</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">d_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infere_type</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">PythonMap</span><span class="p">):</span>

            <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">rhs</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;functions&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">UNDEFINED_FUNCTION</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>

            <span class="n">dvar</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infere_type</span><span class="p">(</span><span class="n">rhs</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
            <span class="n">d_var</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_infere_type</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">func</span><span class="o">.</span><span class="n">results</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">d_var_i</span> <span class="ow">in</span> <span class="n">d_var</span><span class="p">:</span>
                <span class="n">d_var_i</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dvar</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span>
                <span class="n">d_var_i</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span> <span class="p">]</span>  <span class="o">=</span> <span class="n">dvar</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">NumpyTranspose</span><span class="p">):</span>
            <span class="n">d_var</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infere_type</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;memory_handling&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;alias&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">IndexedElement</span><span class="p">):</span>
                <span class="n">rhs</span> <span class="o">=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">internal_var</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">PyccelInternalFunction</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">NativeVoid</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">is_temp</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">rhs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Cannot assign result of a function without a return&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">d_var</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infere_type</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
            <span class="n">d_list</span> <span class="o">=</span> <span class="n">d_var</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d_var</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">d_var</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">d_list</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

                <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Pyccel&#39;</span><span class="p">):</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span>
                    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;cls_base&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;classes&#39;</span><span class="p">)</span>
                    <span class="c1">#TODO: Avoid writing the default variables here</span>
                    <span class="k">if</span> <span class="n">d_var</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_target&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="n">d_var</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;memory_handling&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;alias&#39;</span><span class="p">:</span>
                        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;memory_handling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;alias&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;memory_handling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_var</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;memory_handling&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;heap&#39;</span>

                    <span class="c1"># TODO if we want to use pointers then we set target to true</span>
                    <span class="c1"># in the ConsturcterCall</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)</span> <span class="ow">and</span> <span class="n">rhs</span><span class="o">.</span><span class="n">is_target</span><span class="p">:</span>
                    <span class="c1"># case of rhs is a target variable the lhs must be a pointer</span>
                    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;is_target&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;memory_handling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;alias&#39;</span>

        <span class="n">lhs</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">lhs</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="p">(</span><span class="n">PyccelSymbol</span><span class="p">,</span> <span class="n">DottedName</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d_var</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d_var</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">d_var</span> <span class="o">=</span> <span class="n">d_var</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">WRONG_NUMBER_OUTPUT_ARGS</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">expr</span><span class="p">,</span>
                        <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                        <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>
            <span class="n">lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_lhs_variable</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">d_var</span><span class="p">,</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">new_expressions</span><span class="p">,</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">AugAssign</span><span class="p">),</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">PythonTuple</span><span class="p">):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lhs</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="p">(</span><span class="n">PythonTuple</span><span class="p">,</span> <span class="n">InhomogeneousTupleVariable</span><span class="p">,</span> <span class="n">FunctionCall</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">FunctionCall</span><span class="p">):</span>
                    <span class="n">r_iter</span> <span class="o">=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">funcdef</span><span class="o">.</span><span class="n">results</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">r_iter</span> <span class="o">=</span> <span class="n">rhs</span>
                <span class="n">new_lhs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,(</span><span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span><span class="n">r_iter</span><span class="p">)):</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infere_type</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
                    <span class="n">new_lhs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_lhs_variable</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">new_expressions</span><span class="p">,</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">AugAssign</span><span class="p">),</span><span class="n">arr_in_multirets</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">rank</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">,</span><span class="o">**</span><span class="n">settings</span><span class="p">)</span> <span class="p">)</span>
                <span class="n">lhs</span> <span class="o">=</span> <span class="n">PythonTuple</span><span class="p">(</span><span class="o">*</span><span class="n">new_lhs</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">HomogeneousTupleVariable</span><span class="p">):</span>
                <span class="n">new_lhs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">d_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infere_type</span><span class="p">(</span><span class="n">rhs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">new_rhs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lhs</span><span class="p">):</span>
                    <span class="n">new_lhs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_lhs_variable</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">d_var</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                        <span class="n">rhs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">new_expressions</span><span class="p">,</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">AugAssign</span><span class="p">),</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span> <span class="p">)</span>
                    <span class="n">new_rhs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rhs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">rhs</span> <span class="o">=</span> <span class="n">PythonTuple</span><span class="p">(</span><span class="o">*</span><span class="n">new_rhs</span><span class="p">)</span>
                <span class="n">d_var</span> <span class="o">=</span> <span class="p">[</span><span class="n">d_var</span><span class="p">]</span>
                <span class="n">lhs</span> <span class="o">=</span> <span class="n">PythonTuple</span><span class="p">(</span><span class="o">*</span><span class="n">new_lhs</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d_var</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">d_var</span><span class="p">)</span><span class="o">==</span> <span class="n">n</span><span class="p">:</span>
                <span class="n">new_lhs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span><span class="s1">&#39;__getitem__&#39;</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lhs</span><span class="p">):</span>
                        <span class="n">new_lhs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_lhs_variable</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">d_var</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">rhs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">new_expressions</span><span class="p">,</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">AugAssign</span><span class="p">),</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lhs</span><span class="p">):</span>
                        <span class="n">new_lhs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_lhs_variable</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">d_var</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">new_expressions</span><span class="p">,</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">AugAssign</span><span class="p">),</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span> <span class="p">)</span>
                <span class="n">lhs</span> <span class="o">=</span> <span class="n">PythonTuple</span><span class="p">(</span><span class="o">*</span><span class="n">new_lhs</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">n</span><span class="p">:</span>
                <span class="n">new_lhs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">new_rhs</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
                    <span class="n">new_lhs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_lhs_variable</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infere_type</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">r</span><span class="p">,</span> <span class="n">new_expressions</span><span class="p">,</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">AugAssign</span><span class="p">),</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span> <span class="p">)</span>
                    <span class="n">new_rhs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

                <span class="n">lhs</span> <span class="o">=</span> <span class="n">PythonTuple</span><span class="p">(</span><span class="o">*</span><span class="n">new_lhs</span><span class="p">)</span>
                <span class="n">rhs</span> <span class="o">=</span> <span class="n">new_rhs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">WRONG_NUMBER_OUTPUT_ARGS</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">expr</span><span class="p">,</span>
                    <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                    <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="p">(</span><span class="n">PythonMap</span><span class="p">,</span> <span class="n">PythonZip</span><span class="p">)):</span>
            <span class="n">func</span>  <span class="o">=</span> <span class="n">_get_name</span><span class="p">(</span><span class="n">rhs</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">alloc</span> <span class="o">=</span> <span class="n">Assign</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">NumpyZeros</span><span class="p">(</span><span class="n">lhs</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">lhs</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
            <span class="n">alloc</span><span class="o">.</span><span class="n">set_fst</span><span class="p">(</span><span class="n">fst</span><span class="p">)</span>
            <span class="n">index_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_new_name</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">,</span><span class="n">index_name</span><span class="p">,</span> <span class="n">is_temp</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">range_</span> <span class="o">=</span> <span class="n">FunctionCall</span><span class="p">(</span><span class="s1">&#39;range&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">FunctionCall</span><span class="p">(</span><span class="s1">&#39;len&#39;</span><span class="p">,</span> <span class="n">lhs</span><span class="p">,),))</span>
            <span class="n">name</span>  <span class="o">=</span> <span class="n">_get_name</span><span class="p">(</span><span class="n">lhs</span><span class="p">)</span>
            <span class="n">var</span>   <span class="o">=</span> <span class="n">IndexedElement</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="n">args</span>  <span class="o">=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">args</span>  <span class="o">=</span> <span class="p">[</span><span class="n">_get_name</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
            <span class="n">args</span>  <span class="o">=</span> <span class="p">[</span><span class="n">IndexedElement</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
            <span class="n">func</span>  <span class="o">=</span> <span class="n">FunctionCall</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="n">body</span>  <span class="o">=</span> <span class="p">[</span><span class="n">Assign</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">func</span><span class="p">)]</span>
            <span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_fst</span><span class="p">(</span><span class="n">fst</span><span class="p">)</span>
            <span class="n">body</span>  <span class="o">=</span> <span class="n">For</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">range_</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
            <span class="n">body</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit_For</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
            <span class="n">body</span>  <span class="o">=</span> <span class="p">[</span><span class="n">alloc</span> <span class="p">,</span> <span class="n">body</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">CodeBlock</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">lhs</span> <span class="o">=</span> <span class="p">[</span><span class="n">lhs</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d_var</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
                <span class="n">d_var</span> <span class="o">=</span> <span class="p">[</span><span class="n">d_var</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lhs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">lhs</span> <span class="o">=</span> <span class="n">lhs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">Variable</span><span class="p">):</span>
            <span class="n">is_pointer</span> <span class="o">=</span> <span class="n">lhs</span><span class="o">.</span><span class="n">is_alias</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">IndexedElement</span><span class="p">):</span>
            <span class="n">is_pointer</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="p">(</span><span class="n">PythonTuple</span><span class="p">,</span> <span class="n">PythonList</span><span class="p">)):</span>
            <span class="n">is_pointer</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">is_alias</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lhs</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">Variable</span><span class="p">))</span>

        <span class="c1"># TODO: does is_pointer refer to any/all or last variable in list (currently last)</span>
        <span class="n">is_pointer</span> <span class="o">=</span> <span class="n">is_pointer</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="p">(</span><span class="n">Variable</span><span class="p">,</span> <span class="n">Duplicate</span><span class="p">))</span>
        <span class="n">is_pointer</span> <span class="o">=</span> <span class="n">is_pointer</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lhs</span><span class="o">.</span><span class="n">is_alias</span>

        <span class="n">lhs</span> <span class="o">=</span> <span class="p">[</span><span class="n">lhs</span><span class="p">]</span>
        <span class="n">rhs</span> <span class="o">=</span> <span class="p">[</span><span class="n">rhs</span><span class="p">]</span>
        <span class="c1"># Split into multiple Assigns to ensure AliasAssign is used where necessary</span>
        <span class="n">unravelling</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">while</span> <span class="n">unravelling</span><span class="p">:</span>
            <span class="n">unravelling</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">new_lhs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">new_rhs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
                <span class="c1"># Split assign (e.g. for a,b = 1,c)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="p">(</span><span class="n">PythonTuple</span><span class="p">,</span> <span class="n">InhomogeneousTupleVariable</span><span class="p">))</span> \
                        <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">PythonTuple</span><span class="p">,</span> <span class="n">TupleVariable</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                    <span class="n">new_lhs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                    <span class="n">new_rhs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                    <span class="c1"># Repeat step to handle tuples of tuples of etc.</span>
                    <span class="n">unravelling</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_lhs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                    <span class="n">new_rhs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="n">lhs</span> <span class="o">=</span> <span class="n">new_lhs</span>
            <span class="n">rhs</span> <span class="o">=</span> <span class="n">new_rhs</span>

        <span class="c1"># Examine each assign and determine assign type (Assign, AliasAssign, etc)</span>
        <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span><span class="n">rhs</span><span class="p">):</span>
            <span class="n">is_pointer_i</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">is_alias</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)</span> <span class="k">else</span> <span class="n">is_pointer</span>

            <span class="n">new_expr</span> <span class="o">=</span> <span class="n">Assign</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">is_pointer_i</span><span class="p">:</span>
                <span class="n">new_expr</span> <span class="o">=</span> <span class="n">AliasAssign</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">AugAssign</span><span class="p">):</span>
                <span class="n">new_expr</span> <span class="o">=</span> <span class="n">AugAssign</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">expr</span><span class="o">.</span><span class="n">op</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>


            <span class="k">elif</span> <span class="n">new_expr</span><span class="o">.</span><span class="n">is_symbolic_alias</span><span class="p">:</span>
                <span class="n">new_expr</span> <span class="o">=</span> <span class="n">SymbolicAssign</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

                <span class="c1"># in a symbolic assign, the rhs can be a lambda expression</span>
                <span class="c1"># it is then treated as a def node</span>

                <span class="n">F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="s1">&#39;symbolic_functions&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">F</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">insert_symbolic_function</span><span class="p">(</span><span class="n">new_expr</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">PYCCEL_RESTRICTION_TODO</span><span class="p">,</span>
                                  <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                                  <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>
            <span class="n">new_expressions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_expr</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_expressions</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">new_expressions</span> <span class="o">=</span> <span class="n">new_expressions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">new_expressions</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">CodeBlock</span><span class="p">(</span><span class="n">new_expressions</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="SemanticParser._visit_For"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_For">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_For</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>

        <span class="n">scope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_new_loop_scope</span><span class="p">()</span>

        <span class="c1"># treatment of the index/indices</span>
        <span class="n">iterable</span> <span class="o">=</span> <span class="n">Iterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">iterable</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">))</span>
        <span class="n">body</span>     <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>

        <span class="n">new_expr</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">LiteralInteger</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">iterator_d_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infere_type</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>

        <span class="n">iterator</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">target</span>

        <span class="k">if</span> <span class="n">iterable</span><span class="o">.</span><span class="n">num_loop_counters_required</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">Variable</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_new_name</span><span class="p">(),</span> <span class="n">is_temp</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterable</span><span class="o">.</span><span class="n">num_loop_counters_required</span><span class="p">)]</span>
            <span class="n">iterable</span><span class="o">.</span><span class="n">set_loop_counter</span><span class="p">(</span><span class="o">*</span><span class="n">indices</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">iterable</span><span class="o">.</span><span class="n">iterable</span><span class="p">,</span> <span class="n">PythonEnumerate</span><span class="p">):</span>
                <span class="n">syntactic_index</span> <span class="o">=</span> <span class="n">iterator</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">iterator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_expected_name</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>
                <span class="n">syntactic_index</span> <span class="o">=</span> <span class="n">iterator</span>
            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_for_variable</span><span class="p">(</span><span class="n">syntactic_index</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_lhs_variable</span><span class="p">(</span><span class="n">syntactic_index</span><span class="p">,</span> <span class="n">iterator_d_var</span><span class="p">,</span>
                                <span class="n">rhs</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">new_expressions</span><span class="o">=</span><span class="n">new_expr</span><span class="p">,</span>
                                <span class="n">is_augassign</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
            <span class="n">iterable</span><span class="o">.</span><span class="n">set_loop_counter</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="n">PyccelSymbol</span><span class="p">):</span>
            <span class="n">iterator_rhs</span> <span class="o">=</span> <span class="n">iterable</span><span class="o">.</span><span class="n">get_target_from_range</span><span class="p">()</span>
            <span class="n">iterator_d_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infere_type</span><span class="p">(</span><span class="n">iterator_rhs</span><span class="p">)</span>

            <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_lhs_variable</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="n">iterator_d_var</span><span class="p">,</span>
                            <span class="n">rhs</span><span class="o">=</span><span class="n">iterator_rhs</span><span class="p">,</span> <span class="n">new_expressions</span><span class="o">=</span><span class="n">new_expr</span><span class="p">,</span>
                            <span class="n">is_augassign</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="n">PythonTuple</span><span class="p">):</span>
            <span class="n">iterator_rhs</span> <span class="o">=</span> <span class="n">iterable</span><span class="o">.</span><span class="n">get_target_from_range</span><span class="p">()</span>
            <span class="n">target</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_assign_lhs_variable</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infere_type</span><span class="p">(</span><span class="n">rhs</span><span class="p">),</span>
                                <span class="n">rhs</span><span class="o">=</span><span class="n">rhs</span><span class="p">,</span> <span class="n">new_expressions</span><span class="o">=</span><span class="n">new_expr</span><span class="p">,</span>
                                <span class="n">is_augassign</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">rhs</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="n">iterator_rhs</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">INVALID_FOR_ITERABLE</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">expr</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
                   <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                   <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>


        <span class="n">body</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">body</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">exit_loop_scope</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">iterable</span><span class="o">.</span><span class="n">iterable</span><span class="p">,</span> <span class="n">Product</span><span class="p">):</span>
            <span class="n">for_expr</span> <span class="o">=</span> <span class="n">body</span>
            <span class="n">scopes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">create_product_loop_scope</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">iterable</span><span class="o">.</span><span class="n">get_range</span><span class="p">(),</span> <span class="n">scopes</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">for_expr</span> <span class="o">=</span> <span class="n">For</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">for_expr</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
                <span class="n">for_expr</span><span class="o">.</span><span class="n">end_annotation</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">end_annotation</span>
                <span class="n">for_expr</span> <span class="o">=</span> <span class="p">[</span><span class="n">for_expr</span><span class="p">]</span>
            <span class="n">for_expr</span> <span class="o">=</span> <span class="n">for_expr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">for_expr</span> <span class="o">=</span> <span class="n">For</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">)</span>
            <span class="n">for_expr</span><span class="o">.</span><span class="n">end_annotation</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">end_annotation</span>
        <span class="k">return</span> <span class="n">for_expr</span></div>


<div class="viewcode-block" id="SemanticParser._visit_FunctionalFor"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_FunctionalFor">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_FunctionalFor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">old_index</span>   <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">index</span>
        <span class="n">new_index</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_new_name</span><span class="p">()</span>
        <span class="n">expr</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">old_index</span><span class="p">,</span> <span class="n">new_index</span><span class="p">)</span>

        <span class="n">target</span>  <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">expr</span>
        <span class="n">index</span>   <span class="o">=</span> <span class="n">new_index</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_expected_name</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">indices</span><span class="p">]</span>
        <span class="n">dims</span>    <span class="o">=</span> <span class="p">[]</span>
        <span class="n">body</span>    <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">idx_subs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1">#scope = self.create_new_loop_scope()</span>

        <span class="c1"># The symbols created to represent unknown valued objects are temporary</span>
        <span class="n">tmp_used_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">all_used_symbols</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">For</span><span class="p">):</span>

            <span class="n">stop</span>  <span class="o">=</span> <span class="kc">None</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">LiteralInteger</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">step</span>  <span class="o">=</span> <span class="n">LiteralInteger</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">var</span>   <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">a</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">body</span><span class="o">.</span><span class="n">iterable</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">PythonRange</span><span class="p">):</span>
                <span class="n">var</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_variable</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">dvar</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infere_type</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
                <span class="n">stop</span>  <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">stop</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">start</span>
                <span class="n">step</span>  <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">step</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="p">(</span><span class="n">PythonZip</span><span class="p">,</span> <span class="n">PythonEnumerate</span><span class="p">)):</span>
                <span class="n">dvar</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infere_type</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="n">dvar</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;datatype&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dvar</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">dvar</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span> <span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="n">dvar</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dvar</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">])[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">if</span> <span class="n">dvar</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">dvar</span><span class="p">[</span><span class="s1">&#39;memory_handling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;stack&#39;</span>
                <span class="n">var</span>  <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="o">**</span><span class="n">dvar</span><span class="p">)</span>
                <span class="n">stop</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">Variable</span><span class="p">):</span>
                <span class="n">dvar</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infere_type</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="n">dvar</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;datatype&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dvar</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">dvar</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">dvar</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">dvar</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">dvar</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="n">dvar</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dvar</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">])[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">if</span> <span class="n">dvar</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">dvar</span><span class="p">[</span><span class="s1">&#39;memory_handling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;stack&#39;</span>

                <span class="n">var</span>  <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="o">**</span><span class="n">dvar</span><span class="p">)</span>
                <span class="n">stop</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">PYCCEL_RESTRICTION_TODO</span><span class="p">,</span>
                              <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                              <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>
            <span class="n">existing_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;variables&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">existing_var</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infere_type</span><span class="p">(</span><span class="n">existing_var</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dvar</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Variable </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2"> already exists with different type&quot;</span><span class="p">,</span>
                            <span class="n">symbol</span> <span class="o">=</span> <span class="n">expr</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">insert_variable</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
            <span class="n">step</span><span class="o">.</span><span class="n">invalidate_node</span><span class="p">()</span>
            <span class="n">step</span>  <span class="o">=</span> <span class="n">pyccel_to_sympy</span><span class="p">(</span><span class="n">step</span> <span class="p">,</span> <span class="n">idx_subs</span><span class="p">,</span> <span class="n">tmp_used_names</span><span class="p">)</span>
            <span class="n">start</span><span class="o">.</span><span class="n">invalidate_node</span><span class="p">()</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">pyccel_to_sympy</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">idx_subs</span><span class="p">,</span> <span class="n">tmp_used_names</span><span class="p">)</span>
            <span class="n">stop</span><span class="o">.</span><span class="n">invalidate_node</span><span class="p">()</span>
            <span class="n">stop</span>  <span class="o">=</span> <span class="n">pyccel_to_sympy</span><span class="p">(</span><span class="n">stop</span> <span class="p">,</span> <span class="n">idx_subs</span><span class="p">,</span> <span class="n">tmp_used_names</span><span class="p">)</span>
            <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="n">step</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">step</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">ceiling</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

            <span class="n">body</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dims</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">size</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">))</span>

        <span class="c1"># we now calculate the size of the array which will be allocated</span>

        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="n">idx_subs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span>


        <span class="n">sp_indices</span>  <span class="o">=</span> <span class="p">[</span><span class="n">sp_Symbol</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>

        <span class="n">dim</span> <span class="o">=</span> <span class="n">sp_Integer</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">))):</span>
            <span class="n">size</span>  <span class="o">=</span> <span class="n">dims</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">step</span>  <span class="o">=</span> <span class="n">dims</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">dims</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">stop</span>  <span class="o">=</span> <span class="n">dims</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>

            <span class="c1"># For complicated cases we must ensure that the upper bound is never smaller than the</span>
            <span class="c1"># lower bound as this leads to too little memory being allocated</span>
            <span class="n">min_size</span> <span class="o">=</span> <span class="n">size</span>
            <span class="c1"># Collect all uses of other indices</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">sp_indices</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">start</span><span class="o">.</span><span class="n">atoms</span><span class="p">(</span><span class="n">sp_Symbol</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">sp_indices</span><span class="p">]</span>
            <span class="n">stop_idx</span>  <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">sp_indices</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span>  <span class="n">stop</span><span class="o">.</span><span class="n">atoms</span><span class="p">(</span><span class="n">sp_Symbol</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">sp_indices</span><span class="p">]</span>
            <span class="n">start_idx</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">stop_idx</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

            <span class="c1"># Find the minimum size</span>
            <span class="k">while</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">start_idx</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">stop_idx</span><span class="p">))</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Use the maximum value of the start</span>
                <span class="k">if</span> <span class="n">start_idx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">stop_idx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">start_idx</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="n">min_size</span> <span class="o">=</span> <span class="n">min_size</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">sp_indices</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">dims</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span>
                <span class="c1"># and the minimum value of the stop</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">stop_idx</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="n">min_size</span> <span class="o">=</span> <span class="n">min_size</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">sp_indices</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">dims</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>

            <span class="c1"># While the min_size is not a known integer, assume that the bounds are positive</span>
            <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">min_size</span><span class="p">,</span> <span class="n">sp_Integer</span><span class="p">)</span> <span class="ow">and</span> <span class="n">j</span><span class="o">&lt;=</span><span class="n">i</span><span class="p">:</span>
                <span class="n">min_size</span> <span class="o">=</span> <span class="n">min_size</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">dims</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">simplify</span><span class="p">()</span>
                <span class="n">j</span><span class="o">+=</span><span class="mi">1</span>
            <span class="c1"># If the min_size is negative then the size will be wrong and an error is raised</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">min_size</span><span class="p">,</span> <span class="n">sp_Integer</span><span class="p">)</span> <span class="ow">and</span> <span class="n">min_size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">PYCCEL_RESTRICTION_LIST_COMPREHENSION_LIMITS</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                          <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                          <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>

            <span class="c1"># sympy is necessary to carry out the summation</span>
            <span class="n">dim</span>   <span class="o">=</span> <span class="n">dim</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">sp_indices</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">start</span><span class="o">+</span><span class="n">step</span><span class="o">*</span><span class="n">sp_indices</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">dim</span>   <span class="o">=</span> <span class="n">Summation</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="p">(</span><span class="n">sp_indices</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">dim</span>   <span class="o">=</span> <span class="n">dim</span><span class="o">.</span><span class="n">doit</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="n">sympy_to_pyccel</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">idx_subs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">PYCCEL_RESTRICTION_LIST_COMPREHENSION_SIZE</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Deduced size : </span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                          <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                          <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>

        <span class="c1"># TODO find a faster way to calculate dim</span>
        <span class="c1"># when step&gt;1 and not isinstance(dim, Sum)</span>
        <span class="c1"># maybe use the c++ library of sympy</span>

        <span class="c1"># we annotate the target to infere the type of the list created</span>

        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
        <span class="n">d_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infere_type</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>

        <span class="n">dtype</span> <span class="o">=</span> <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="n">NativeGeneric</span><span class="p">():</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">LIST_OF_TUPLES</span><span class="p">,</span>
                          <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                          <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>

        <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;memory_handling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;heap&#39;</span>
        <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">dim</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;C&#39;</span>
            <span class="n">shape</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shape</span>

        <span class="c1"># ...</span>
        <span class="c1"># TODO [YG, 30.10.2020]:</span>
        <span class="c1">#  - Check if we should allow the possibility that is_stack_array=True</span>
        <span class="c1"># ...</span>
        <span class="n">lhs_symbol</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">base</span>
        <span class="n">ne</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_lhs_variable</span><span class="p">(</span><span class="n">lhs_symbol</span><span class="p">,</span> <span class="n">d_var</span><span class="p">,</span> <span class="n">rhs</span><span class="o">=</span><span class="n">expr</span><span class="p">,</span> <span class="n">new_expressions</span><span class="o">=</span><span class="n">ne</span><span class="p">,</span> <span class="n">is_augassign</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
        <span class="n">lhs_alloc</span> <span class="o">=</span> <span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">PythonTuple</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">target</span><span class="o">.</span><span class="n">is_homogeneous</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">LIST_OF_TUPLES</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">expr</span><span class="p">,</span>
                <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>

        <span class="n">target</span><span class="o">.</span><span class="n">invalidate_node</span><span class="p">()</span>

        <span class="n">loops</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">loops</span><span class="p">]</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>

        <span class="n">l</span> <span class="o">=</span> <span class="n">loops</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">For</span><span class="p">)</span>
            <span class="c1"># Sub in indices as defined here for coherent naming</span>
            <span class="k">if</span> <span class="n">idx</span><span class="o">.</span><span class="n">is_temp</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">remove_variable</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
                <span class="n">l</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">idx_subs</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1">#self.exit_loop_scope()</span>

        <span class="k">return</span> <span class="n">CodeBlock</span><span class="p">([</span><span class="n">lhs_alloc</span><span class="p">,</span> <span class="n">FunctionalFor</span><span class="p">(</span><span class="n">loops</span><span class="p">,</span> <span class="n">lhs</span><span class="o">=</span><span class="n">lhs</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">indices</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)])</span></div>

<div class="viewcode-block" id="SemanticParser._visit_GeneratorComprehension"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_GeneratorComprehension">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_GeneratorComprehension</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_for_variable</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">lhs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lhs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">is_temp</span><span class="p">:</span>
                <span class="n">lhs</span> <span class="o">=</span> <span class="n">PyccelSymbol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_new_name</span><span class="p">(),</span> <span class="n">is_temp</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lhs</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">lhs</span>

            <span class="n">creation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">Assign</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">fst</span><span class="o">=</span><span class="n">expr</span><span class="o">.</span><span class="n">fst</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_additional_exprs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">creation</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">lhs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">lhs</span></div>

<div class="viewcode-block" id="SemanticParser._visit_While"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_While">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_While</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>

        <span class="n">scope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_new_loop_scope</span><span class="p">()</span>
        <span class="n">test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exit_loop_scope</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">While</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">)</span></div>

<div class="viewcode-block" id="SemanticParser._visit_IfSection"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_IfSection">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_IfSection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">condition</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">condition</span>

        <span class="n">name_symbol</span> <span class="o">=</span> <span class="n">PyccelSymbol</span><span class="p">(</span><span class="s1">&#39;__name__&#39;</span><span class="p">)</span>
        <span class="n">main</span> <span class="o">=</span> <span class="n">LiteralString</span><span class="p">(</span><span class="s1">&#39;__main__&#39;</span><span class="p">)</span>
        <span class="n">prog_check</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">PyccelEq</span><span class="p">)</span> \
                <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">a</span> <span class="ow">in</span> <span class="p">(</span><span class="n">name_symbol</span><span class="p">,</span> <span class="n">main</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">condition</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">prog_check</span><span class="p">:</span>
            <span class="n">cond</span> <span class="o">=</span> <span class="n">InProgram</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">change_to_program_scope</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">condition</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prog_check</span><span class="p">:</span>
            <span class="c1"># Calling the Garbage collecting,</span>
            <span class="c1"># it will add the necessary Deallocate nodes</span>
            <span class="c1"># to the ast</span>
            <span class="n">body</span><span class="o">.</span><span class="n">insert2body</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_garbage_collector</span><span class="p">(</span><span class="n">body</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">change_to_module_scope</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">IfSection</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span></div>

<div class="viewcode-block" id="SemanticParser._visit_If"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_If">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_If</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">blocks</span><span class="p">]</span>

        <span class="n">conds</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">condition</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">InProgram</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conds</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="p">(</span><span class="n">InProgram</span><span class="p">,</span><span class="n">LiteralTrue</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conds</span><span class="p">):</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;Determination of main module is too complicated to handle&quot;</span><span class="p">,</span>
                        <span class="n">symbol</span><span class="o">=</span><span class="n">expr</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>

        <span class="n">allocations</span> <span class="o">=</span> <span class="p">[</span><span class="n">arg</span><span class="o">.</span><span class="n">get_attribute_nodes</span><span class="p">(</span><span class="n">Allocate</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>

        <span class="n">var_shapes</span> <span class="o">=</span> <span class="p">[{</span><span class="n">a</span><span class="o">.</span><span class="n">variable</span> <span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">allocs</span><span class="p">}</span> <span class="k">for</span> <span class="n">allocs</span> <span class="ow">in</span> <span class="n">allocations</span><span class="p">]</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">var_shapes</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">branch</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
            <span class="n">all_shapes_set</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">v</span> <span class="ow">in</span> <span class="n">branch_shapes</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">branch_shapes</span> <span class="ow">in</span> <span class="n">var_shapes</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">all_shapes_set</span><span class="p">:</span>
                <span class="n">shape_branch1</span> <span class="o">=</span> <span class="n">var_shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">v</span><span class="p">]</span>
                <span class="n">same_shapes</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">shape_branch1</span><span class="o">==</span><span class="n">branch_shapes</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> \
                                <span class="k">for</span> <span class="n">branch_shapes</span> <span class="ow">in</span> <span class="n">var_shapes</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">same_shapes</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">same_shapes</span><span class="p">:</span>
                <span class="n">v</span><span class="o">.</span><span class="n">set_changeable_shape</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">If</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span></div>

<div class="viewcode-block" id="SemanticParser._visit_IfTernaryOperator"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_IfTernaryOperator">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_IfTernaryOperator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">value_true</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">value_true</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value_true</span><span class="o">.</span><span class="n">rank</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">value_true</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">is</span> <span class="n">NativeString</span><span class="p">():</span>
            <span class="n">lhs</span> <span class="o">=</span> <span class="n">PyccelSymbol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_new_name</span><span class="p">(),</span> <span class="n">is_temp</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># Temporarily deactivate type checks to construct syntactic assigns</span>
            <span class="n">pyccel_stage</span><span class="o">.</span><span class="n">set_stage</span><span class="p">(</span><span class="s1">&#39;syntactic&#39;</span><span class="p">)</span>
            <span class="n">assign_true</span>  <span class="o">=</span> <span class="n">Assign</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">expr</span><span class="o">.</span><span class="n">value_true</span><span class="p">,</span> <span class="n">fst</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">fst</span><span class="p">)</span>
            <span class="n">assign_false</span> <span class="o">=</span> <span class="n">Assign</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">expr</span><span class="o">.</span><span class="n">value_false</span><span class="p">,</span> <span class="n">fst</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">fst</span><span class="p">)</span>
            <span class="n">pyccel_stage</span><span class="o">.</span><span class="n">set_stage</span><span class="p">(</span><span class="s1">&#39;semantic&#39;</span><span class="p">)</span>

            <span class="n">cond</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">cond</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
            <span class="n">true_section</span>  <span class="o">=</span> <span class="n">IfSection</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">assign_true</span><span class="p">)])</span>
            <span class="n">false_section</span> <span class="o">=</span> <span class="n">IfSection</span><span class="p">(</span><span class="n">LiteralTrue</span><span class="p">(),</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">assign_false</span><span class="p">)])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_additional_exprs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">If</span><span class="p">(</span><span class="n">true_section</span><span class="p">,</span> <span class="n">false_section</span><span class="p">))</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">lhs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cond</span>        <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">cond</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
            <span class="n">value_false</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">value_false</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">IfTernaryOperator</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">value_true</span><span class="p">,</span> <span class="n">value_false</span><span class="p">)</span></div>

<div class="viewcode-block" id="SemanticParser._visit_VariableHeader"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_VariableHeader">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_VariableHeader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>

        <span class="c1"># TODO improve</span>
        <span class="c1">#      move it to the ast like create_definition for FunctionHeader?</span>

        <span class="n">name</span>  <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">name</span>
        <span class="n">d_var</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">d_var</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;datatype&#39;</span><span class="p">)</span>
        <span class="n">d_var</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;is_func&#39;</span><span class="p">)</span>

        <span class="n">var</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">d_var</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">insert_variable</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">expr</span></div>

<div class="viewcode-block" id="SemanticParser._visit_FunctionHeader"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_FunctionHeader">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_FunctionHeader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="c1"># TODO should we return it and keep it in the AST?</span>
        <span class="n">expr</span><span class="o">.</span><span class="n">clear_user_nodes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">insert_header</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">expr</span></div>

<div class="viewcode-block" id="SemanticParser._visit_Template"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_Template">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_Template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">expr</span><span class="o">.</span><span class="n">clear_user_nodes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">insert_template</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">expr</span></div>

<div class="viewcode-block" id="SemanticParser._visit_ClassHeader"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_ClassHeader">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_ClassHeader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="c1"># TODO should we return it and keep it in the AST?</span>
        <span class="n">expr</span><span class="o">.</span><span class="n">clear_user_nodes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">insert_header</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">expr</span></div>

<div class="viewcode-block" id="SemanticParser._visit_Return"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_Return">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_Return</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>

        <span class="n">results</span>     <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">expr</span>
        <span class="n">f_name</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_function</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f_name</span><span class="p">,</span> <span class="n">DottedName</span><span class="p">):</span>
            <span class="n">f_name</span> <span class="o">=</span> <span class="n">f_name</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">return_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">f_name</span><span class="p">,</span> <span class="s1">&#39;functions&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">results</span>
        <span class="n">assigns</span>     <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">v</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">return_vars</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">PyccelSymbol</span><span class="p">)</span> <span class="ow">and</span> <span class="n">r</span> <span class="o">==</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span><span class="p">)):</span>
                <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">Assign</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">fst</span><span class="o">=</span><span class="n">expr</span><span class="o">.</span><span class="n">fst</span><span class="p">))</span>
                <span class="n">assigns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">return_vars</span><span class="p">]</span>

        <span class="c1"># add the Deallocate node before the Return node and eliminating the Deallocate nodes</span>
        <span class="c1"># the arrays that will be returned.</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">assigns</span> <span class="o">+</span> <span class="p">[</span><span class="n">Deallocate</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allocs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">code</span><span class="p">:</span>
            <span class="n">expr</span>  <span class="o">=</span> <span class="n">Return</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">CodeBlock</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expr</span>  <span class="o">=</span> <span class="n">Return</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">expr</span></div>

<div class="viewcode-block" id="SemanticParser._visit_FunctionDef"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_FunctionDef">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_FunctionDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">name</span>            <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_expected_name</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">cls_name</span>        <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">cls_name</span>
        <span class="n">decorators</span>      <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">decorators</span>
        <span class="n">funcs</span>           <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sub_funcs</span>       <span class="o">=</span> <span class="p">[]</span>
        <span class="n">func_interfaces</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">is_pure</span>         <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">is_pure</span>
        <span class="n">is_elemental</span>    <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">is_elemental</span>
        <span class="n">is_private</span>      <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">is_private</span>
        <span class="n">is_inline</span>       <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">is_inline</span>
        <span class="n">doc_string</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">doc_string</span><span class="p">)</span> <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">doc_string</span> <span class="k">else</span> <span class="n">expr</span><span class="o">.</span><span class="n">doc_string</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">not_used</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">decorators</span> <span class="k">if</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">def_decorators</span><span class="o">.</span><span class="n">__all__</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_used</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">UNUSED_DECORATORS</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">not_used</span><span class="p">),</span> <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;warning&#39;</span><span class="p">)</span>

        <span class="n">args_number</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">arguments</span><span class="p">)</span>
        <span class="n">templates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;templates&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">decorators</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]:</span>
            <span class="c1"># Load templates dict from decorators dict</span>
            <span class="n">templates</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">decorators</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">][</span><span class="s1">&#39;template_dict&#39;</span><span class="p">])</span>

        <span class="n">tmp_headers</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">headers</span>
        <span class="n">python_name</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_python_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cls_name</span><span class="p">:</span>
            <span class="n">tmp_headers</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_headers</span><span class="p">(</span><span class="n">cls_name</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">python_name</span><span class="p">)</span>
            <span class="n">args_number</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tmp_headers</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_headers</span><span class="p">(</span><span class="n">python_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">tmp_headers</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">dtypes</span> <span class="o">!=</span> <span class="n">hd</span><span class="o">.</span><span class="n">dtypes</span> <span class="k">for</span> <span class="n">hd</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">):</span>
                <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">DUPLICATED_SIGNATURE</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">header</span><span class="p">,</span>
                        <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;warning&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">hd</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">args_number</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hd</span><span class="o">.</span><span class="n">dtypes</span><span class="p">)):</span>
                <span class="n">n_types</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hd</span><span class="o">.</span><span class="n">dtypes</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;The number of arguments in the function </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">args_number</span><span class="si">}</span><span class="s2">) does not match the number</span>
<span class="s2">                        of types in decorator/header (</span><span class="si">{</span><span class="n">n_types</span><span class="si">}</span><span class="s2">).&quot;&quot;&quot;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">args_number</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">hd</span><span class="o">.</span><span class="n">dtypes</span><span class="p">)):</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">expr</span><span class="o">.</span><span class="n">arguments</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;warning&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">expr</span><span class="o">.</span><span class="n">arguments</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>

        <span class="n">interfaces</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># check if a header is imported from a header file</span>
            <span class="c1"># TODO improve in the case of multiple headers ( interface )</span>
            <span class="n">func</span>       <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;functions&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">func</span> <span class="ow">and</span> <span class="n">func</span><span class="o">.</span><span class="n">is_header</span><span class="p">:</span>
                <span class="n">interfaces</span> <span class="o">=</span> <span class="p">[</span><span class="n">func</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">arguments</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">headers</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">interfaces</span><span class="p">:</span>

            <span class="c1"># TODO ERROR wrong position</span>

            <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">FUNCTION_TYPE_EXPECTED</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                   <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                   <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>

        <span class="c1"># We construct a FunctionDef from each function header</span>
        <span class="k">for</span> <span class="n">hd</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="n">interfaces</span> <span class="o">+=</span> <span class="n">hd</span><span class="o">.</span><span class="n">create_definition</span><span class="p">(</span><span class="n">templates</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">interfaces</span><span class="p">:</span>
            <span class="c1"># this for the case of a function without arguments =&gt; no headers</span>
            <span class="n">interfaces</span> <span class="o">=</span> <span class="p">[</span><span class="n">FunctionDef</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[])]</span>

<span class="c1">#        TODO move this to codegen</span>
<span class="c1">#        vec_func = None</span>
<span class="c1">#        if &#39;vectorize&#39; in decorators:</span>
<span class="c1">#            #TODO move to another place</span>
<span class="c1">#            vec_name  = &#39;vec_&#39; + name</span>
<span class="c1">#            arg       = decorators[&#39;vectorize&#39;][0]</span>
<span class="c1">#            arg       = str(arg.name)</span>
<span class="c1">#            args      = [str(i.name) for i in expr.arguments]</span>
<span class="c1">#            index_arg = args.index(arg)</span>
<span class="c1">#            arg       = Symbol(arg)</span>
<span class="c1">#            vec_arg   = arg</span>
<span class="c1">#            index     = self.namespace.get_new_name()</span>
<span class="c1">#            range_    = Function(&#39;range&#39;)(Function(&#39;len&#39;)(arg))</span>
<span class="c1">#            args      = symbols(args)</span>
<span class="c1">#            args[index_arg] = vec_arg[index]</span>
<span class="c1">#            body_vec        = Assign(args[index_arg], Function(name)(*args))</span>
<span class="c1">#            body_vec.set_fst(expr.fst)</span>
<span class="c1">#            body_vec   = [For(index, range_, [body_vec])]</span>
<span class="c1">#            header_vec = header.vectorize(index_arg)</span>
<span class="c1">#            vec_func   = expr.vectorize(body_vec, header_vec)</span>

        <span class="n">interface_name</span> <span class="o">=</span> <span class="n">name</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">interfaces</span><span class="p">):</span>
            <span class="n">args</span>           <span class="o">=</span> <span class="p">[]</span>
            <span class="n">results</span>        <span class="o">=</span> <span class="p">[]</span>
            <span class="n">global_vars</span>    <span class="o">=</span> <span class="p">[]</span>
            <span class="n">imports</span>        <span class="o">=</span> <span class="p">[]</span>
            <span class="n">arg</span>            <span class="o">=</span> <span class="kc">None</span>
            <span class="n">arguments</span>      <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">arguments</span>
            <span class="n">header_results</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">results</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">interfaces</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">interface_name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">scope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_new_function_scope</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">decorators</span> <span class="o">=</span> <span class="n">decorators</span><span class="p">,</span>
                    <span class="n">used_symbols</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">local_used_symbols</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                    <span class="n">original_symbols</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">python_names</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">cls_name</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;self&#39;</span><span class="p">:</span>
                <span class="n">arg</span>       <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">arguments</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">dt</span>        <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_class_construct</span><span class="p">(</span><span class="n">cls_name</span><span class="p">)()</span>
                <span class="n">cls_base</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">cls_name</span><span class="p">,</span> <span class="s1">&#39;classes&#39;</span><span class="p">)</span>
                <span class="n">var</span>       <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="s1">&#39;self&#39;</span><span class="p">,</span> <span class="n">cls_base</span><span class="o">=</span><span class="n">cls_base</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">insert_variable</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">arguments</span><span class="p">:</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">ah</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">arguments</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">arguments</span><span class="p">):</span>
                    <span class="n">ah</span> <span class="o">=</span> <span class="n">ah</span><span class="o">.</span><span class="n">var</span>
                    <span class="n">additional_args</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">FunctionAddress</span><span class="p">):</span>
                        <span class="n">d_var</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;is_argument&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;memory_handling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;alias&#39;</span>
                        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">has_default</span><span class="p">:</span>
                            <span class="c1"># optional argument only if the value is None</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">Nil</span><span class="p">):</span>
                                <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;is_optional&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">a_new</span> <span class="o">=</span> <span class="n">FunctionAddress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_expected_name</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
                                        <span class="n">ah</span><span class="o">.</span><span class="n">arguments</span><span class="p">,</span> <span class="n">ah</span><span class="o">.</span><span class="n">results</span><span class="p">,</span> <span class="p">[],</span> <span class="o">**</span><span class="n">d_var</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">d_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infere_type</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
                        <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ah</span><span class="o">.</span><span class="n">alloc_shape</span>
                        <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;is_argument&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;is_const&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ah</span><span class="o">.</span><span class="n">is_const</span>
                        <span class="n">dtype</span> <span class="o">=</span> <span class="n">d_var</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;datatype&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;cls_base&#39;</span><span class="p">]:</span>
                            <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;cls_base&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_cls_base</span><span class="p">(</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span> <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="p">)</span>

                        <span class="k">if</span> <span class="s1">&#39;allow_negative_index&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">decorators</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">decorators</span><span class="p">[</span><span class="s1">&#39;allow_negative_index&#39;</span><span class="p">]:</span>
                                <span class="n">d_var</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">allows_negative_indexes</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">has_default</span><span class="p">:</span>
                            <span class="c1"># optional argument only if the value is None</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">Nil</span><span class="p">):</span>
                                <span class="n">d_var</span><span class="p">[</span><span class="s1">&#39;is_optional&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">a_new</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_expected_name</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="o">**</span><span class="n">d_var</span><span class="p">)</span>


                    <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Literal</span><span class="p">)</span> <span class="ow">and</span> \
                            <span class="n">value</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">is</span> <span class="n">a_new</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">and</span> \
                            <span class="n">value</span><span class="o">.</span><span class="n">precision</span> <span class="o">!=</span> <span class="n">a_new</span><span class="o">.</span><span class="n">precision</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">convert_to_literal</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">python_value</span><span class="p">,</span> <span class="n">a_new</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">a_new</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>

                    <span class="n">arg_new</span> <span class="o">=</span> <span class="n">FunctionDefArgument</span><span class="p">(</span><span class="n">a_new</span><span class="p">,</span>
                                <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                                <span class="n">kwonly</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">is_kwonly</span><span class="p">,</span>
                                <span class="n">annotation</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">annotation</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">additional_args</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">+=</span> <span class="n">additional_args</span>

                    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg_new</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a_new</span><span class="p">,</span> <span class="n">FunctionAddress</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">insert_function</span><span class="p">(</span><span class="n">a_new</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">insert_variable</span><span class="p">(</span><span class="n">a_new</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">results</span>
            <span class="k">if</span> <span class="n">header_results</span><span class="p">:</span>
                <span class="n">new_results</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">ah</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">header_results</span><span class="p">):</span>
                    <span class="n">d_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infere_type</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
                    <span class="n">dtype</span> <span class="o">=</span> <span class="n">d_var</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;datatype&#39;</span><span class="p">)</span>
                    <span class="n">a_new</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_expected_name</span><span class="p">(</span><span class="n">a</span><span class="p">),</span>
                            <span class="o">**</span><span class="n">d_var</span><span class="p">,</span> <span class="n">is_temp</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">is_temp</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">insert_variable</span><span class="p">(</span><span class="n">a_new</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
                    <span class="n">new_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_new</span><span class="p">)</span>

                <span class="n">results</span> <span class="o">=</span> <span class="n">new_results</span>

            <span class="c1"># insert the FunctionDef into the scope</span>
            <span class="c1"># to handle the case of a recursive function</span>
            <span class="c1"># TODO improve in the case of an interface</span>
            <span class="n">recursive_func_obj</span> <span class="o">=</span> <span class="n">FunctionDef</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="p">[])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">insert_function</span><span class="p">(</span><span class="n">recursive_func_obj</span><span class="p">)</span>

            <span class="c1"># Create a new list that store local variables for each FunctionDef to handle nested functions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_allocs</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>

            <span class="c1"># we annotate the body</span>
            <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>

            <span class="c1"># Calling the Garbage collecting,</span>
            <span class="c1"># it will add the necessary Deallocate nodes</span>
            <span class="c1"># to the body of the function</span>
            <span class="n">body</span><span class="o">.</span><span class="n">insert2body</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_garbage_collector</span><span class="p">(</span><span class="n">body</span><span class="p">))</span>

            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">arg</span> <span class="ow">and</span> <span class="n">cls_name</span><span class="p">:</span>
                <span class="n">dt</span>       <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_class_construct</span><span class="p">(</span><span class="n">cls_name</span><span class="p">)()</span>
                <span class="n">cls_base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">cls_name</span><span class="p">,</span> <span class="s1">&#39;classes&#39;</span><span class="p">)</span>
                <span class="n">var</span>      <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="s1">&#39;self&#39;</span><span class="p">,</span> <span class="n">cls_base</span><span class="o">=</span><span class="n">cls_base</span><span class="p">)</span>
                <span class="n">args</span>     <span class="o">=</span> <span class="p">[</span><span class="n">FunctionDefArgument</span><span class="p">(</span><span class="n">var</span><span class="p">)]</span> <span class="o">+</span> <span class="n">args</span>

            <span class="c1"># Determine local and global variables</span>
            <span class="n">global_vars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_variables</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">parent_scope</span><span class="p">))</span>
            <span class="n">global_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">global_vars</span> <span class="k">if</span> <span class="n">body</span><span class="o">.</span><span class="n">is_user_of</span><span class="p">(</span><span class="n">g</span><span class="p">)]</span>

            <span class="c1"># get the imports</span>
            <span class="n">imports</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">imports</span><span class="p">[</span><span class="s1">&#39;imports&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="n">imports</span>   <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">imports</span><span class="p">))</span>

            <span class="c1"># remove the FunctionDef from the function scope</span>
            <span class="c1"># TODO improve func_ is None in the case of an interface</span>
            <span class="n">func_</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">is_recursive</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># check if the function is recursive if it was called on the same scope</span>
            <span class="k">if</span> <span class="n">func_</span> <span class="ow">and</span> <span class="n">func_</span><span class="o">.</span><span class="n">is_recursive</span><span class="p">:</span>
                <span class="n">is_recursive</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">sub_funcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="o">.</span><span class="n">is_header</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">FunctionAddress</span><span class="p">)]</span>

            <span class="n">func_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">FunctionAddress</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">func_args</span><span class="p">:</span>
                <span class="n">func_interfaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Interface</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">func_args</span><span class="p">,</span> <span class="n">is_argument</span> <span class="o">=</span> <span class="kc">True</span><span class="p">))</span>

            <span class="n">namespace_imports</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">imports</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exit_function_scope</span><span class="p">()</span>

            <span class="c1"># ... computing inout arguments</span>
            <span class="n">args_inout</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

            <span class="n">results_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>

            <span class="c1"># Find all nodes which can modify variables</span>
            <span class="n">assigns</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">get_attribute_nodes</span><span class="p">(</span><span class="n">Assign</span><span class="p">,</span> <span class="n">excluded_nodes</span> <span class="o">=</span> <span class="p">(</span><span class="n">FunctionCall</span><span class="p">,))</span>
            <span class="n">calls</span>   <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">get_attribute_nodes</span><span class="p">(</span><span class="n">FunctionCall</span><span class="p">)</span>

            <span class="c1"># Collect the modified objects</span>
            <span class="n">lhs_assigns</span>   <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">lhs</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">assigns</span><span class="p">]</span>
            <span class="n">modified_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">func_arg</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">calls</span>
                                <span class="k">for</span> <span class="n">func_arg</span><span class="p">,</span> <span class="n">inout</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">args</span><span class="p">,</span><span class="n">f</span><span class="o">.</span><span class="n">funcdef</span><span class="o">.</span><span class="n">arguments_inout</span><span class="p">)</span> <span class="k">if</span> <span class="n">inout</span><span class="p">]</span>
            <span class="c1"># Collect modified variables</span>
            <span class="n">all_assigned</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">(</span><span class="n">lhs_assigns</span> <span class="o">+</span> <span class="n">modified_args</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span>
                            <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get_attribute_nodes</span><span class="p">(</span><span class="n">Variable</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">a</span><span class="p">])]</span>

            <span class="n">permanent_assign</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">all_assigned</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">rank</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">local_assign</span>     <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">all_assigned</span><span class="p">]</span>

            <span class="n">apps</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">calls</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">funcdef</span><span class="o">.</span><span class="n">name</span>
                    <span class="ow">not</span> <span class="ow">in</span> <span class="n">sub_funcs</span><span class="p">)]</span>

            <span class="n">d_apps</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">apps</span><span class="p">:</span>
                <span class="n">a_args</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">a_args</span><span class="p">:</span>
                    <span class="n">d_apps</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="n">results_names</span><span class="p">,</span> <span class="n">permanent_assign</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;self&#39;</span><span class="p">]):</span>
                    <span class="n">args_inout</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">d_apps</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span> <span class="n">args_inout</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">):</span>
                    <span class="n">intent</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">n_fa</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">d_apps</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>
                    <span class="n">i_fa</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">while</span> <span class="ow">not</span><span class="p">(</span><span class="n">intent</span><span class="p">)</span> <span class="ow">and</span> <span class="n">i_fa</span> <span class="o">&lt;</span> <span class="n">n_fa</span><span class="p">:</span>
                        <span class="n">fa</span> <span class="o">=</span> <span class="n">d_apps</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i_fa</span><span class="p">]</span>
                        <span class="n">f_name</span> <span class="o">=</span> <span class="n">fa</span><span class="o">.</span><span class="n">funcdef</span><span class="o">.</span><span class="n">name</span>
                        <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">f_name</span><span class="p">,</span> <span class="s1">&#39;functions&#39;</span><span class="p">)</span>

                        <span class="n">j</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fa</span><span class="o">.</span><span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                        <span class="n">intent</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">arguments_inout</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">intent</span><span class="p">:</span>
                            <span class="n">args_inout</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

                        <span class="n">i_fa</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">var</span><span class="p">,</span> <span class="n">Variable</span><span class="p">):</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">var</span>
                    <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">is_const</span> <span class="ow">and</span> <span class="p">(</span><span class="n">args_inout</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">or</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">local_assign</span><span class="p">)):</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Cannot modify &#39;const&#39; argument (</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">)&quot;</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                            <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>
            <span class="c1"># ...</span>

            <span class="c1"># Raise an error if one of the return arguments is an alias.</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">is_alias</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">UNSUPPORTED_POINTER_RETURN_VALUE</span><span class="p">,</span>
                    <span class="n">symbol</span><span class="o">=</span><span class="n">r</span><span class="p">,</span><span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                    <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>

            <span class="n">func_kwargs</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;global_vars&#39;</span><span class="p">:</span><span class="n">global_vars</span><span class="p">,</span>
                    <span class="s1">&#39;cls_name&#39;</span><span class="p">:</span><span class="n">cls_name</span><span class="p">,</span>
                    <span class="s1">&#39;is_pure&#39;</span><span class="p">:</span><span class="n">is_pure</span><span class="p">,</span>
                    <span class="s1">&#39;is_elemental&#39;</span><span class="p">:</span><span class="n">is_elemental</span><span class="p">,</span>
                    <span class="s1">&#39;is_private&#39;</span><span class="p">:</span><span class="n">is_private</span><span class="p">,</span>
                    <span class="s1">&#39;imports&#39;</span><span class="p">:</span><span class="n">imports</span><span class="p">,</span>
                    <span class="s1">&#39;decorators&#39;</span><span class="p">:</span><span class="n">decorators</span><span class="p">,</span>
                    <span class="s1">&#39;is_recursive&#39;</span><span class="p">:</span><span class="n">is_recursive</span><span class="p">,</span>
                    <span class="s1">&#39;arguments_inout&#39;</span><span class="p">:</span><span class="n">args_inout</span><span class="p">,</span>
                    <span class="s1">&#39;functions&#39;</span><span class="p">:</span> <span class="n">sub_funcs</span><span class="p">,</span>
                    <span class="s1">&#39;interfaces&#39;</span><span class="p">:</span> <span class="n">func_interfaces</span><span class="p">,</span>
                    <span class="s1">&#39;doc_string&#39;</span><span class="p">:</span> <span class="n">doc_string</span><span class="p">,</span>
                    <span class="s1">&#39;scope&#39;</span><span class="p">:</span> <span class="n">scope</span>
                    <span class="p">}</span>
            <span class="k">if</span> <span class="n">is_inline</span><span class="p">:</span>
                <span class="n">func_kwargs</span><span class="p">[</span><span class="s1">&#39;namespace_imports&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">namespace_imports</span>
                <span class="n">global_funcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">body</span><span class="o">.</span><span class="n">get_attribute_nodes</span><span class="p">(</span><span class="n">FunctionDef</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;functions&#39;</span><span class="p">)]</span>
                <span class="n">func_kwargs</span><span class="p">[</span><span class="s1">&#39;global_funcs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">global_funcs</span>
                <span class="bp">cls</span> <span class="o">=</span> <span class="n">InlineFunctionDef</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">cls</span> <span class="o">=</span> <span class="n">FunctionDef</span>
            <span class="n">func</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">args</span><span class="p">,</span>
                    <span class="n">results</span><span class="p">,</span>
                    <span class="n">body</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">func_kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_recursive</span><span class="p">:</span>
                <span class="n">recursive_func_obj</span><span class="o">.</span><span class="n">invalidate_node</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">cls_name</span><span class="p">:</span>
                <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">cls_name</span><span class="p">,</span> <span class="s1">&#39;classes&#39;</span><span class="p">)</span>
                <span class="n">methods</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">methods</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">func</span><span class="p">]</span>

                <span class="c1"># update the class methods</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">insert_class</span><span class="p">(</span><span class="n">ClassDef</span><span class="p">(</span><span class="n">cls_name</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">attributes</span><span class="p">,</span>
                        <span class="n">methods</span><span class="p">,</span> <span class="n">superclass</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">superclass</span><span class="p">))</span>

            <span class="n">funcs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">func</span><span class="p">]</span>

            <span class="c1">#clear the sympy cache</span>
            <span class="c1">#TODO clear all variable except the global ones</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">funcs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">funcs</span> <span class="o">=</span> <span class="n">funcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">insert_function</span><span class="p">(</span><span class="n">funcs</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">insert_function</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

            <span class="n">funcs</span> <span class="o">=</span> <span class="n">Interface</span><span class="p">(</span><span class="n">interface_name</span><span class="p">,</span> <span class="n">funcs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">insert_function</span><span class="p">(</span><span class="n">funcs</span><span class="p">)</span>
<span class="c1">#        TODO move this to codegen</span>
<span class="c1">#        if vec_func:</span>
<span class="c1">#           self._visit_FunctionDef(vec_func, **settings)</span>
<span class="c1">#           vec_func = self.scope.functions.pop(vec_name)</span>
<span class="c1">#           if isinstance(funcs, Interface):</span>
<span class="c1">#               funcs = list(funcs.funcs)+[vec_func]</span>
<span class="c1">#           else:</span>
<span class="c1">#               self.scope.sons_scopes[&#39;sc_&#39;+ name] = self.scope.sons_scopes[name]</span>
<span class="c1">#               funcs = funcs.rename(&#39;sc_&#39;+ name)</span>
<span class="c1">#               funcs = [funcs, vec_func]</span>
<span class="c1">#           funcs = Interface(name, funcs)</span>
<span class="c1">#           self.insert_function(funcs)</span>
        <span class="k">return</span> <span class="n">EmptyNode</span><span class="p">()</span></div>

<div class="viewcode-block" id="SemanticParser._visit_PythonPrint"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_PythonPrint">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_PythonPrint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">expr</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PythonPrint</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">is_symbolic</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)</span> \
                <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">NativeSymbol</span><span class="p">)</span>

        <span class="c1"># TODO fix: not yet working because of mpi examples</span>
<span class="c1">#        if not test:</span>
<span class="c1">#            # TODO: Add description to parser/messages.py</span>
<span class="c1">#            errors.report(&#39;Either all arguments must be symbolic or none of them can be&#39;,</span>
<span class="c1">#                   bounding_box=(self._current_fst_node.lineno, self._current_fst_node.col_offset),</span>
<span class="c1">#                   severity=&#39;fatal&#39;)</span>

        <span class="k">if</span> <span class="n">is_symbolic</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">_args</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;symbolic_functions&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>

                    <span class="c1"># TODO improve: how can we print SymbolicAssign as  lhs = rhs</span>

                    <span class="n">_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">SymbolicPrint</span><span class="p">(</span><span class="n">_args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PythonPrint</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></div>

<div class="viewcode-block" id="SemanticParser._visit_ClassDef"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_ClassDef">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_ClassDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>

        <span class="c1"># TODO - improve the use and def of interfaces</span>
        <span class="c1">#      - wouldn&#39;t be better if it is done inside ClassDef?</span>

        <span class="n">name</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">name</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">scope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_new_class_scope</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">used_symbols</span><span class="o">=</span><span class="n">expr</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">local_used_symbols</span><span class="p">,</span>
                    <span class="n">original_symbols</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">python_names</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">methods</span><span class="p">)</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">superclass</span>
        <span class="n">interfaces</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># remove quotes for str representation</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="n">ClassDef</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[],</span> <span class="n">superclass</span><span class="o">=</span><span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">insert_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="n">const</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">methods</span><span class="p">):</span>
            <span class="n">m_name</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">m_name</span> <span class="o">==</span> <span class="s1">&#39;__init__&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_visit_FunctionDef</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
                <span class="n">methods</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">const</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">m_name</span><span class="p">)</span>
                <span class="k">break</span>



        <span class="k">if</span> <span class="ow">not</span> <span class="n">const</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">UNDEFINED_INIT_METHOD</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                   <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                   <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>

        <span class="n">ms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_visit_FunctionDef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
            <span class="n">m_name</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">m_name</span><span class="p">)</span>
            <span class="n">ms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

        <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="n">const</span><span class="p">]</span> <span class="o">+</span> <span class="n">ms</span>
        <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_headers</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">header</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">PYCCEL_MISSING_HEADER</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                   <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                   <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>

        <span class="n">attributes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;classes&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">attributes</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">methods</span><span class="o">.</span><span class="n">copy</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">Interface</span><span class="p">):</span>
                <span class="n">methods</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">interfaces</span> <span class="o">+=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">exit_class_scope</span><span class="p">()</span>

        <span class="bp">cls</span> <span class="o">=</span> <span class="n">ClassDef</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attributes</span><span class="p">,</span> <span class="n">methods</span><span class="p">,</span>
              <span class="n">interfaces</span><span class="o">=</span><span class="n">interfaces</span><span class="p">,</span> <span class="n">superclass</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">insert_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">EmptyNode</span><span class="p">()</span></div>

<div class="viewcode-block" id="SemanticParser._visit_Del"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_Del">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_Del</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>

        <span class="n">ls</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">variables</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">Del</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span></div>

<div class="viewcode-block" id="SemanticParser._visit_PyccelIs"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_PyccelIs">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_PyccelIs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="c1"># Handles PyccelIs and PyccelIsNot</span>
        <span class="n">IsClass</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>

        <span class="c1"># TODO ERROR wrong position ??</span>

        <span class="n">var1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">lhs</span><span class="p">)</span>
        <span class="n">var2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">rhs</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">var1</span> <span class="ow">is</span> <span class="n">var2</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">var2</span><span class="p">,</span> <span class="n">Nil</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="n">Nil</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">IsClass</span> <span class="o">==</span> <span class="n">PyccelIsNot</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">LiteralFalse</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">IsClass</span> <span class="o">==</span> <span class="n">PyccelIs</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">LiteralTrue</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="n">Nil</span><span class="p">):</span>
            <span class="n">var1</span><span class="p">,</span> <span class="n">var2</span> <span class="o">=</span> <span class="n">var2</span><span class="p">,</span> <span class="n">var1</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var2</span><span class="p">,</span> <span class="n">Nil</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="n">Variable</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">IsClass</span> <span class="o">==</span> <span class="n">PyccelIsNot</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">LiteralTrue</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">IsClass</span> <span class="o">==</span> <span class="n">PyccelIs</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">LiteralFalse</span><span class="p">()</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">var1</span><span class="o">.</span><span class="n">is_optional</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">PYCCEL_RESTRICTION_OPTIONAL_NONE</span><span class="p">,</span>
                        <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                        <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">IsClass</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="n">expr</span><span class="o">.</span><span class="n">rhs</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">var1</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">var2</span><span class="o">.</span><span class="n">dtype</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">IsClass</span> <span class="o">==</span> <span class="n">PyccelIs</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">LiteralFalse</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">IsClass</span> <span class="o">==</span> <span class="n">PyccelIsNot</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">LiteralTrue</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">var1</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">NativeBool</span><span class="p">)</span> <span class="ow">and</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">var2</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">NativeBool</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">IsClass</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="n">var2</span><span class="p">)</span>

        <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">NativeString</span><span class="p">(),</span> <span class="n">NativeComplex</span><span class="p">(),</span> <span class="n">NativeFloat</span><span class="p">(),</span> <span class="n">NativeInteger</span><span class="p">()]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">var1</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">PYCCEL_RESTRICTION_PRIMITIVE_IMMUTABLE</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">expr</span><span class="p">,</span>
            <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
            <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">IsClass</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="n">var2</span><span class="p">)</span>

        <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">PYCCEL_RESTRICTION_IS_ISNOT</span><span class="p">,</span>
            <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
            <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">IsClass</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="n">var2</span><span class="p">)</span></div>

<div class="viewcode-block" id="SemanticParser._visit_Import"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_Import">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_Import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>

        <span class="c1"># TODO - must have a dict where to store things that have been</span>
        <span class="c1">#        imported</span>
        <span class="c1">#      - should not use scope</span>

        <span class="n">container</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">imports</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">EmptyNode</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">AsName</span><span class="p">):</span>
            <span class="n">source</span>        <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">name</span>
            <span class="n">source_target</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">target</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">source</span>        <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
            <span class="n">source_target</span> <span class="o">=</span> <span class="n">source</span>

        <span class="k">if</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">pyccel_builtin_import_registery</span><span class="p">:</span>
            <span class="n">imports</span> <span class="o">=</span> <span class="n">pyccel_builtin_import</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">_insert_obj</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
                <span class="n">F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="n">F</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">FOUND_DUPLICATED_IMPORT</span><span class="p">,</span>
                                <span class="n">symbol</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;warning&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">F</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">container</span><span class="p">[</span><span class="n">location</span><span class="p">][</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">IMPORTING_EXISTING_IDENTIFIED</span><span class="p">,</span>
                                  <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                                  <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">target</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">target</span><span class="p">:</span>
                    <span class="n">t_name</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">AsName</span><span class="p">)</span> <span class="k">else</span> <span class="n">t</span>
                    <span class="k">if</span> <span class="n">t_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pyccel_builtin_import_registery</span><span class="p">[</span><span class="n">source</span><span class="p">]:</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Function &#39;</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">&#39; from module &#39;</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&#39; is not currently supported by pyccel&quot;</span><span class="p">,</span>
                                <span class="n">symbol</span><span class="o">=</span><span class="n">expr</span><span class="p">,</span>
                                <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="p">)</span> <span class="ow">in</span> <span class="n">imports</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">Decorator</span><span class="p">):</span>
                            <span class="k">continue</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">Constant</span><span class="p">):</span>
                            <span class="n">_insert_obj</span><span class="p">(</span><span class="s1">&#39;variables&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">_insert_obj</span><span class="p">(</span><span class="s1">&#39;functions&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">imports</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="n">mod</span> <span class="o">=</span> <span class="n">imports</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">Module</span><span class="p">)</span>
                <span class="n">_insert_obj</span><span class="p">(</span><span class="s1">&#39;variables&#39;</span><span class="p">,</span> <span class="n">source_target</span><span class="p">,</span> <span class="n">mod</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">insert_import</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="p">[</span><span class="n">AsName</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">imports</span><span class="p">],</span> <span class="n">source_target</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">recognised_source</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Module </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2"> is not currently supported by pyccel&quot;</span><span class="p">,</span>
                    <span class="n">symbol</span><span class="o">=</span><span class="n">expr</span><span class="p">,</span>
                    <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># we need to use str here since source has been defined</span>
            <span class="c1"># using repr.</span>
            <span class="c1"># TODO shall we improve it?</span>

            <span class="n">p</span>       <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_parsers</span><span class="p">[</span><span class="n">source_target</span><span class="p">]</span>
            <span class="n">import_init</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">semantic_parser</span><span class="o">.</span><span class="n">ast</span><span class="o">.</span><span class="n">init_func</span> <span class="k">if</span> <span class="n">source_target</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">container</span><span class="p">[</span><span class="s1">&#39;imports&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">import_free</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">semantic_parser</span><span class="o">.</span><span class="n">ast</span><span class="o">.</span><span class="n">free_func</span> <span class="k">if</span> <span class="n">source_target</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">container</span><span class="p">[</span><span class="s1">&#39;imports&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">target</span><span class="p">:</span>
                <span class="n">targets</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="o">.</span><span class="n">target</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">AsName</span><span class="p">)</span> <span class="k">else</span> <span class="n">i</span><span class="p">:</span><span class="kc">None</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">target</span><span class="p">}</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">AsName</span><span class="p">)</span> <span class="k">else</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">target</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">,</span> <span class="s1">&#39;classes&#39;</span><span class="p">,</span> <span class="s1">&#39;functions&#39;</span><span class="p">]:</span>
                    <span class="n">d_son</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span><span class="p">,</span><span class="n">n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">targets</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span><span class="n">names</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">d_son</span><span class="p">:</span>
                            <span class="n">e</span> <span class="o">=</span> <span class="n">d_son</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
                                <span class="n">container</span><span class="p">[</span><span class="n">entry</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">container</span><span class="p">[</span><span class="n">entry</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                            <span class="n">targets</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span>
                <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="n">targets</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;Import target </span><span class="si">{}</span><span class="s2"> could not be found&quot;</span><span class="p">,</span>
                            <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;warning&quot;</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">expr</span><span class="p">)</span>
                <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="n">AsName</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">targets</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mod</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">semantic_parser</span><span class="o">.</span><span class="n">ast</span>
                <span class="n">container</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">][</span><span class="n">source_target</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod</span>
                <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="n">AsName</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">source_target</span><span class="p">)]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">cls_constructs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">cls_constructs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">macros</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">macros</span><span class="p">)</span>

            <span class="c1"># ... meta variables</span>

            <span class="c1"># in some cases (blas, lapack and openacc level-0)</span>
            <span class="c1"># the import should not appear in the final file</span>
            <span class="c1"># all metavars here, will have a prefix and suffix = __</span>
            <span class="n">__ignore_at_import__</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">metavars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ignore_at_import&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

            <span class="c1"># Indicates that the module must be imported with the syntax &#39;from mod import *&#39;</span>
            <span class="n">__import_all__</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">metavars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;import_all&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

            <span class="c1"># Indicates the name of the fortran module containing the functions</span>
            <span class="n">__module_name__</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">metavars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;module_name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">source_target</span> <span class="ow">in</span> <span class="n">container</span><span class="p">[</span><span class="s1">&#39;imports&#39;</span><span class="p">]:</span>
                <span class="n">targets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">container</span><span class="p">[</span><span class="s1">&#39;imports&#39;</span><span class="p">][</span><span class="n">source_target</span><span class="p">]</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">targets</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">import_init</span><span class="p">:</span>
                <span class="n">old_name</span> <span class="o">=</span> <span class="n">import_init</span><span class="o">.</span><span class="n">name</span>
                <span class="n">new_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_new_name</span><span class="p">(</span><span class="n">old_name</span><span class="p">)</span>
                <span class="n">targets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AsName</span><span class="p">(</span><span class="n">import_init</span><span class="p">,</span> <span class="n">new_name</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">new_name</span> <span class="o">!=</span> <span class="n">old_name</span><span class="p">:</span>
                    <span class="n">import_init</span> <span class="o">=</span> <span class="n">import_init</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">new_name</span><span class="p">)</span>

                <span class="n">result</span>  <span class="o">=</span> <span class="n">FunctionCall</span><span class="p">(</span><span class="n">import_init</span><span class="p">,[],[])</span>

            <span class="k">if</span> <span class="n">import_free</span><span class="p">:</span>
                <span class="n">old_name</span> <span class="o">=</span> <span class="n">import_free</span><span class="o">.</span><span class="n">name</span>
                <span class="n">new_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_new_name</span><span class="p">(</span><span class="n">old_name</span><span class="p">)</span>
                <span class="n">targets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AsName</span><span class="p">(</span><span class="n">import_free</span><span class="p">,</span> <span class="n">new_name</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">new_name</span> <span class="o">!=</span> <span class="n">old_name</span><span class="p">:</span>
                    <span class="n">import_free</span> <span class="o">=</span> <span class="n">import_free</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">new_name</span><span class="p">)</span>

            <span class="n">mod</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">semantic_parser</span><span class="o">.</span><span class="n">ast</span>

            <span class="k">if</span> <span class="n">__import_all__</span><span class="p">:</span>
                <span class="n">expr</span> <span class="o">=</span> <span class="n">Import</span><span class="p">(</span><span class="n">source_target</span><span class="p">,</span> <span class="n">AsName</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">__module_name__</span><span class="p">),</span> <span class="n">mod</span><span class="o">=</span><span class="n">mod</span><span class="p">)</span>
                <span class="n">container</span><span class="p">[</span><span class="s1">&#39;imports&#39;</span><span class="p">][</span><span class="n">source_target</span><span class="p">]</span> <span class="o">=</span> <span class="n">expr</span>

            <span class="k">elif</span> <span class="n">__module_name__</span><span class="p">:</span>
                <span class="n">expr</span> <span class="o">=</span> <span class="n">Import</span><span class="p">(</span><span class="n">__module_name__</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">mod</span><span class="o">=</span><span class="n">mod</span><span class="p">)</span>
                <span class="n">container</span><span class="p">[</span><span class="s1">&#39;imports&#39;</span><span class="p">][</span><span class="n">source_target</span><span class="p">]</span> <span class="o">=</span> <span class="n">expr</span>

            <span class="k">elif</span> <span class="ow">not</span> <span class="n">__ignore_at_import__</span><span class="p">:</span>
                <span class="n">expr</span> <span class="o">=</span> <span class="n">Import</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">mod</span><span class="o">=</span><span class="n">mod</span><span class="p">)</span>
                <span class="n">container</span><span class="p">[</span><span class="s1">&#39;imports&#39;</span><span class="p">][</span><span class="n">source_target</span><span class="p">]</span> <span class="o">=</span> <span class="n">expr</span>

        <span class="k">return</span> <span class="n">result</span></div>



<div class="viewcode-block" id="SemanticParser._visit_With"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_With">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_With</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">scope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_new_loop_scope</span><span class="p">()</span>

        <span class="n">domaine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
        <span class="n">parent</span>  <span class="o">=</span> <span class="n">domaine</span><span class="o">.</span><span class="n">cls_base</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">parent</span><span class="o">.</span><span class="n">is_with_construct</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">UNDEFINED_WITH_ACCESS</span><span class="p">,</span>
                   <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                   <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>

        <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">exit_loop_scope</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">With</span><span class="p">(</span><span class="n">domaine</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span><span class="o">.</span><span class="n">block</span></div>



<div class="viewcode-block" id="SemanticParser._visit_MacroFunction"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_MacroFunction">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_MacroFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="c1"># we change here the master name to its FunctionDef</span>

        <span class="n">f_name</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">master</span>
        <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_headers</span><span class="p">(</span><span class="n">f_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">header</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">f_name</span><span class="p">,</span> <span class="s1">&#39;functions&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">MACRO_MISSING_HEADER_OR_FUNC</span><span class="p">,</span>
                <span class="n">symbol</span><span class="o">=</span><span class="n">f_name</span><span class="p">,</span><span class="n">severity</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">,</span>
                <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">interfaces</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">hd</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                <span class="n">interfaces</span> <span class="o">+=</span> <span class="n">hd</span><span class="o">.</span><span class="n">create_definition</span><span class="p">()</span>

            <span class="c1"># TODO -&gt; Said: must handle interface</span>

            <span class="n">func</span> <span class="o">=</span> <span class="n">interfaces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">name</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">name</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">FunctionDefArgument</span><span class="p">)</span> <span class="k">else</span> <span class="n">FunctionDefArgument</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">arguments</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">get_arg</span><span class="p">(</span><span class="n">func_arg</span><span class="p">,</span> <span class="n">master_arg</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">master_arg</span><span class="p">,</span> <span class="n">PyccelSymbol</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">FunctionCallArgument</span><span class="p">(</span><span class="n">func_arg</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">master_arg</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">FunctionCallArgument</span><span class="p">(</span><span class="n">master_arg</span><span class="p">)</span>

        <span class="n">master_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_arg</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">arguments</span><span class="p">,</span> <span class="n">expr</span><span class="o">.</span><span class="n">master_arguments</span><span class="p">)]</span>

        <span class="n">master</span> <span class="o">=</span> <span class="n">FunctionCall</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">master_args</span><span class="p">)</span>
        <span class="n">macro</span>   <span class="o">=</span> <span class="n">MacroFunction</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">master</span><span class="p">,</span> <span class="n">master_args</span><span class="p">,</span>
                                <span class="n">results</span><span class="o">=</span><span class="n">expr</span><span class="o">.</span><span class="n">results</span><span class="p">,</span> <span class="n">results_shapes</span><span class="o">=</span><span class="n">expr</span><span class="o">.</span><span class="n">results_shapes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">insert_macro</span><span class="p">(</span><span class="n">macro</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">macro</span></div>

<div class="viewcode-block" id="SemanticParser._visit_MacroShape"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_MacroShape">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_MacroShape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">expr</span><span class="o">.</span><span class="n">clear_user_nodes</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">expr</span></div>

<div class="viewcode-block" id="SemanticParser._visit_MacroVariable"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_MacroVariable">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_MacroVariable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>

        <span class="n">master</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">master</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">DottedName</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">PYCCEL_RESTRICTION_TODO</span><span class="p">,</span>
                          <span class="n">bounding_box</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_fst_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">),</span>
                          <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;fatal&#39;</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_headers</span><span class="p">(</span><span class="n">master</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">master</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">header</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                <span class="c1"># TODO -&gt; Said: must handle interface</span>

        <span class="n">expr</span> <span class="o">=</span> <span class="n">MacroVariable</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">insert_macro</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">expr</span></div>

<div class="viewcode-block" id="SemanticParser._visit_StarredArguments"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_StarredArguments">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_StarredArguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">args_var</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">rank</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">StarredArguments</span><span class="p">([</span><span class="n">var</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">)])</span></div>

<div class="viewcode-block" id="SemanticParser._visit_NumpyMatmul"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_NumpyMatmul">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_NumpyMatmul</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">FunctionCall</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">insert_import</span><span class="p">(</span><span class="s1">&#39;numpy&#39;</span><span class="p">,</span> <span class="n">AsName</span><span class="p">(</span><span class="n">NumpyMatmul</span><span class="p">,</span> <span class="s1">&#39;matmul&#39;</span><span class="p">))</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>
            <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">NumpyMatmul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span></div>

<div class="viewcode-block" id="SemanticParser._visit_Assert"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_Assert">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_Assert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Assert</span><span class="p">(</span><span class="n">test</span><span class="p">)</span></div>

<div class="viewcode-block" id="SemanticParser._visit_NumpyWhere"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_NumpyWhere">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_NumpyWhere</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_call</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">func_call_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_function_args</span><span class="p">(</span><span class="n">func_call</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
        <span class="c1"># expr is a FunctionCall</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">func_call_args</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">has_keyword</span><span class="p">]</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="o">.</span><span class="n">keyword</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">func_call</span><span class="o">.</span><span class="n">args</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">has_keyword</span><span class="p">}</span>
        <span class="n">nargs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nargs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit_NumpyNonZero</span><span class="p">(</span><span class="n">func_call</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">NumpyWhere</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="SemanticParser._visit_NumpyNonZero"><a class="viewcode-back" href="../../../pyccel.parser.html#pyccel.parser.semantic.SemanticParser._visit_NumpyNonZero">[docs]</a>    <span class="k">def</span> <span class="nf">_visit_NumpyNonZero</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_call</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">func_call_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_function_args</span><span class="p">(</span><span class="n">func_call</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
        <span class="c1"># expr is a FunctionCall</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="n">func_call_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Variable</span><span class="p">):</span>
            <span class="n">new_symbol</span> <span class="o">=</span> <span class="n">PyccelSymbol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_new_name</span><span class="p">())</span>
            <span class="n">creation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">Assign</span><span class="p">(</span><span class="n">new_symbol</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">fst</span><span class="o">=</span><span class="n">func_call</span><span class="o">.</span><span class="n">fst</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_additional_exprs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">creation</span><span class="p">)</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">new_symbol</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">NumpyWhere</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2023, *.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>